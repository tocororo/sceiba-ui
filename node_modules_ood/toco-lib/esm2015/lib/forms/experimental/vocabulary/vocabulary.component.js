/**
 * @fileoverview added by tsickle
 * Generated from: lib/forms/experimental/vocabulary/vocabulary.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 *   Copyright (c) 2020 Universidad de Pinar del Río "Hermanos Saíz Montes de Oca"
 *   All rights reserved.
 */
import { Component } from "@angular/core";
import { FormControl } from "@angular/forms";
import { startWith, map } from "rxjs/operators";
import { TaxonomyService } from '../../../backend/public-api';
import { InputControl } from '../../input/input.control';
/**
 * @record
 */
function VocabularyComponentExtraContent() { }
if (false) {
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.multiple;
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.selectedTermsIds;
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.excludeTermsIds;
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.level;
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.vocab;
}
/**
 * A control to select a term or terms in a vocabulary.
 */
export class VocabularyComponent extends InputControl {
    /**
     * @param {?} service
     */
    constructor(service) {
        super();
        this.service = service;
        // internalControl = new FormControl();
        //this control is used by the chips,not necessary to expose it
        this.chipsFormControl = new FormControl();
        this.chipsList = [];
        this.selectOptions = [];
        this.terms = [];
        this.loading = true;
        // selectedTermsIds = [];
        this.searchText = "Seleccione las opciones";
        this.termsTreeObserver = {
            next: (/**
             * @param {?} response
             * @return {?}
             */
            (response) => {
                console.log("VOCABULARY COMPONENT RESPONSE ", response);
                console.log(response.data.tree);
                this.terms = response.data.tree.term_node;
                this.terms.forEach((/**
                 * @param {?} element
                 * @return {?}
                 */
                element => {
                    this.selectOptions = this.selectOptions.concat(this._get_terms(element));
                }));
            }),
            error: (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                console.log("The observable got an error notification: " + err + ".");
            }),
            complete: (/**
             * @return {?}
             */
            () => {
                console.log("The observable got a complete notification.");
                this.loading = !this.loading;
            })
        };
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.init('', '', false, true);
        // (this.content.parentFormSection as FormGroup).addControl(
        //   this.content.name,
        //   this.internalControl
        // );
        if (this.content.required) {
            this.content.formControl.setValidators((/**
             * @param {?} control
             * @return {?}
             */
            (control) => {
                return !this.content.value || this.content.value.length == 0
                    ? { requiredTerms: "No Terms Selected" }
                    : null;
            }));
        }
        this.inputId = this.content.label.trim().toLowerCase();
        if (this.content.extraContent) {
            this.extraContent = this.content.extraContent;
            // if (this.extraContent.multiple !== null) {
            //   this.multiple = this.extraContent.multiple;
            // }
            // if (this.extraContent.selectedTermsIds) {
            //   this.content.value = this.extraContent.selectedTermsIds;
            // } else {
            //   this.content.value = [];
            // }
            // already selected terms
            if (!this.extraContent.selectedTermsIds) {
                this.extraContent.selectedTermsIds = [];
            }
            // terms ids to exclude of the possible options.
            if (!this.extraContent.excludeTermsIds) {
                this.extraContent.excludeTermsIds = [];
            }
            this.content.value = [];
            if (this.extraContent.level == undefined) {
                this.extraContent.level = 10;
            }
            if (this.extraContent.vocab) {
                // this.vocab = this.extraContent.vocab;
                this.service
                    .getTermsTreeByVocab(this.extraContent.vocab, this.extraContent.level)
                    .subscribe(this.termsTreeObserver);
            }
            //   else if(this.extraContent.termID){
            //     this.service.getTermByUUID(this.extraContent.termID, this.extraContent.level)
            //     .subscribe(this.termsTreeObserver);
            // }
            this._updateFilteredOptions();
        }
    }
    /**
     * @private
     * @return {?}
     */
    setValidation() {
        if (this.content.formControl.valid) {
            this.chipsFormControl.setErrors(null);
        }
        else {
            this.chipsFormControl.setErrors({ requiered: true });
        }
    }
    /**
     * @private
     * @param {?} term
     * @return {?}
     */
    addTermToValue(term) {
        if (this.extraContent.multiple) {
            this.content.value.unshift(term);
        }
        else {
            this.content.value = [term];
        }
        this.content.formControl.setValue(this.content.value);
        this.setValidation();
    }
    /**
     * @private
     * @param {?} term
     * @return {?}
     */
    removeTermFromValue(term) {
        this.content.value = ((/** @type {?} */ (this.content.value))).filter((/**
         * @param {?} e
         * @return {?}
         */
        (e) => e.id !== term.id));
        this.content.formControl.setValue(this.content.value);
        this.setValidation();
    }
    /**
     * @private
     * @return {?}
     */
    _updateFilteredOptions() {
        this.filteredOptions = this.chipsFormControl.valueChanges.pipe(startWith(""), map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            /** @type {?} */
            const filterValue = value ? value.toLowerCase() : "";
            console.log('************************************');
            console.log(this.selectOptions);
            console.log('************************************');
            return this.selectOptions.filter((/**
             * @param {?} option
             * @return {?}
             */
            option => option.term.identifier.toLowerCase().includes(filterValue)));
        })));
    }
    /**
     * @private
     * @param {?} node
     * @param {?=} parent
     * @return {?}
     */
    _get_terms(node, parent = null) {
        /** @type {?} */
        let result = [];
        node.parent = parent;
        // if is in selected terms ids list, then is part of the value
        if (((/** @type {?} */ (this.extraContent.selectedTermsIds))).some((/**
         * @param {?} id
         * @return {?}
         */
        id => id === node.term.uuid))) {
            this.addTermToValue(node.term);
            this.chipsList.push(node);
        }
        else {
            // if is not in any of the exclude term ids, then push
            if (!((/** @type {?} */ (this.extraContent.excludeTermsIds))).some((/**
             * @param {?} id
             * @return {?}
             */
            id => id === node.term.uuid))) {
                result.push(node);
            }
        }
        if (node.children) {
            node.children.forEach((/**
             * @param {?} child
             * @return {?}
             */
            child => {
                result = result.concat(this._get_terms(child, node));
            }));
        }
        return result;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    addChips(value) {
        if (this.extraContent.multiple) {
            this.chipsList.unshift(value);
        }
        else {
            // if not is multiple, then the element in the chipsList goes back to the options
            if (this.chipsList.length > 0) {
                this.selectOptions.push(this.chipsList[0]);
            }
            this.chipsList = [value];
        }
        this.addTermToValue(value.term);
        this.selectOptions = this.selectOptions.filter((/**
         * @param {?} option
         * @return {?}
         */
        option => option.term.id !== value.term.id));
        this.chipsFormControl.setValue("");
        // document.getElementById(this.inputId).blur();
        this._updateFilteredOptions();
    }
    /**
     * @param {?} index
     * @return {?}
     */
    removeChip(index) {
        this.selectOptions.push(this.chipsList[index]);
        this.removeTermFromValue(this.chipsList[index].term);
        this.chipsList.splice(index, 1);
        this._updateFilteredOptions();
    }
    /**
     * @param {?} node
     * @return {?}
     */
    getTermNameInATree(node) {
        if (node.parent != null) {
            return this.getTermNameInATree(node.parent) + " / " + node.term.description;
        }
        else {
            return node.term.description;
        }
    }
}
VocabularyComponent.decorators = [
    { type: Component, args: [{
                selector: "toco-vocabulary",
                template: "<mat-card>\n\n  <mat-progress-bar *ngIf=\"loading\"\n    mode=\"indeterminate\">\n  </mat-progress-bar>\n\n    <mat-card-subtitle *ngIf=\"!loading\">\n    <mat-form-field style=\"width: 100%;\">\n\n      <mat-label> {{content.label}} <span *ngIf=\"content.required\">*</span></mat-label>\n      <input\n        matInput\n        id=\"'inputId-'{{content.name}}\"\n        type=\"text\"\n        [formControl]=\"chipsFormControl\"\n        [matAutocomplete]=\"auto\"\n          aria-label=\"Number\"\n      />\n\n      <mat-hint *ngIf=\"content.startHint\" [align]=\"'start'\">{{ content.startHint.label }}</mat-hint>\n      <mat-hint *ngIf=\"!content.startHint\" [align]=\"'start'\">{{ searchText }}</mat-hint>\n\n      <mat-autocomplete #auto=\"matAutocomplete\">\n        <mat-option *ngFor=\"let option of filteredOptions | async\" [value]=\"option.term.description\" (click)=\"addChips(option)\"\n          [title]=\"option.term.description\">\n          {{ option.term.description }}\n        </mat-option>\n      </mat-autocomplete>\n\n      <!-- <button mat-icon-button color=\"accent\" class=\"delete-filter\" (click)=\"remove_component()\">\n      <mat-icon>close</mat-icon>\n    </button> -->\n    </mat-form-field>\n  </mat-card-subtitle>\n  <mat-card-content *ngIf=\"!loading\">\n    <mat-chip-list class=\"mat-chip-list-stacked\" fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"margin-bottom: .5em\"\n      id=\"chiplist-{{extraContent.vocab}}\">\n      <mat-chip *ngFor=\"let item of chipsList; let i=index\" (removed)=\"removeChip(i)\" [removable]=\"true\" style=\"width: 100%;height: 100%;\">\n        {{ getTermNameInATree(item) }}\n        <mat-icon matChipRemove>cancel</mat-icon>\n      </mat-chip>\n    </mat-chip-list>\n  </mat-card-content>\n\n</mat-card>\n",
                host: {
                    "[style.minWidth]": "content.minWidth",
                    "[style.width]": "content.width"
                },
                styles: [""]
            }] }
];
/** @nocollapse */
VocabularyComponent.ctorParameters = () => [
    { type: TaxonomyService }
];
if (false) {
    /** @type {?} */
    VocabularyComponent.prototype.chipsFormControl;
    /** @type {?} */
    VocabularyComponent.prototype.inputId;
    /** @type {?} */
    VocabularyComponent.prototype.filteredOptions;
    /** @type {?} */
    VocabularyComponent.prototype.chipsList;
    /** @type {?} */
    VocabularyComponent.prototype.selectOptions;
    /** @type {?} */
    VocabularyComponent.prototype.terms;
    /** @type {?} */
    VocabularyComponent.prototype.loading;
    /** @type {?} */
    VocabularyComponent.prototype.extraContent;
    /** @type {?} */
    VocabularyComponent.prototype.searchText;
    /**
     * @type {?}
     * @private
     */
    VocabularyComponent.prototype.termsTreeObserver;
    /**
     * @type {?}
     * @private
     */
    VocabularyComponent.prototype.service;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm9jYWJ1bGFyeS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly90b2NvLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9mb3Jtcy9leHBlcmltZW50YWwvdm9jYWJ1bGFyeS92b2NhYnVsYXJ5LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFLQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ2xELE9BQU8sRUFDTCxXQUFXLEVBSVosTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QixPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUc5RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7Ozs7QUFJekQsOENBUUM7OztJQVBDLG1EQUFrQjs7SUFDbEIsMkRBQXFCOztJQUNyQiwwREFBb0I7O0lBRXBCLGdEQUFjOztJQUVkLGdEQUFrQzs7Ozs7QUFlcEMsTUFBTSxPQUFPLG1CQUFvQixTQUFRLFlBQVk7Ozs7SUErQ25ELFlBQW9CLE9BQXdCO1FBRTFDLEtBQUssRUFBRSxDQUFDO1FBRlUsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7OztRQXpDNUMscUJBQWdCLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUdyQyxjQUFTLEdBQWUsRUFBRSxDQUFDO1FBQzNCLGtCQUFhLEdBQWUsRUFBRSxDQUFDO1FBRS9CLFVBQUssR0FBZSxFQUFFLENBQUM7UUFFdkIsWUFBTyxHQUFHLElBQUksQ0FBQzs7UUFNZixlQUFVLEdBQUcseUJBQXlCLENBQUM7UUFFL0Isc0JBQWlCLEdBQW1DO1lBQzFELElBQUk7Ozs7WUFBRSxDQUFDLFFBQXVCLEVBQUUsRUFBRTtnQkFDaEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQ0FBZ0MsRUFBQyxRQUFRLENBQUMsQ0FBQTtnQkFDdEQsT0FBTyxDQUFDLEdBQUcs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Q3RDLGVBQWUsRUFBRSxlQUFlO2lCQUNqQzs7YUFDRjs7OztZQTVCUSxlQUFlOzs7O0lBbUN0QiwrQ0FBcUM7O0lBQ3JDLHNDQUFnQjs7SUFDaEIsOENBQXdDOztJQUN4Qyx3Q0FBMkI7O0lBQzNCLDRDQUErQjs7SUFFL0Isb0NBQXVCOztJQUV2QixzQ0FBZTs7SUFFZiwyQ0FBOEM7O0lBSTlDLHlDQUF1Qzs7Ozs7SUFFdkMsZ0RBdUJFOzs7OztJQUVVLHNDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiAgIENvcHlyaWdodCAoYykgMjAyMCBVbml2ZXJzaWRhZCBkZSBQaW5hciBkZWwgUsOtbyBcIkhlcm1hbm9zIFNhw616IE1vbnRlcyBkZSBPY2FcIlxuICogICBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7XG4gIEZvcm1Db250cm9sLFxuICBBYnN0cmFjdENvbnRyb2wsXG4gIFZhbGlkYXRpb25FcnJvcnMsXG4gIEZvcm1Hcm91cFxufSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcbmltcG9ydCB7IE9ic2VydmFibGUsIFBhcnRpYWxPYnNlcnZlciB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBzdGFydFdpdGgsIG1hcCB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuaW1wb3J0IHsgVGF4b25vbXlTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vYmFja2VuZC9wdWJsaWMtYXBpJztcbmltcG9ydCB7IFZvY2FidWxhcmllc0lubXV0YWJsZU5hbWVzLCBUZXJtTm9kZSwgVGVybSB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL3B1YmxpYy1hcGknO1xuXG5pbXBvcnQgeyBJbnB1dENvbnRyb2wgfSBmcm9tICcuLi8uLi9pbnB1dC9pbnB1dC5jb250cm9sJztcblxuaW1wb3J0IHsgUmVzcG9uc2UgfSBmcm9tICcuLi8uLi8uLi9jb3JlL3B1YmxpYy1hcGknO1xuXG5pbnRlcmZhY2UgVm9jYWJ1bGFyeUNvbXBvbmVudEV4dHJhQ29udGVudHtcbiAgbXVsdGlwbGU6IGJvb2xlYW47XG4gIHNlbGVjdGVkVGVybXNJZHM6IFtdO1xuICBleGNsdWRlVGVybXNJZHM6IFtdO1xuXG4gIGxldmVsOiBudW1iZXI7XG5cbiAgdm9jYWI6IFZvY2FidWxhcmllc0lubXV0YWJsZU5hbWVzO1xufVxuXG4vKipcbiAqIEEgY29udHJvbCB0byBzZWxlY3QgYSB0ZXJtIG9yIHRlcm1zIGluIGEgdm9jYWJ1bGFyeS5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiBcInRvY28tdm9jYWJ1bGFyeVwiLFxuICB0ZW1wbGF0ZVVybDogXCIuL3ZvY2FidWxhcnkuY29tcG9uZW50Lmh0bWxcIixcbiAgc3R5bGVVcmxzOiBbXCIuL3ZvY2FidWxhcnkuY29tcG9uZW50LnNjc3NcIl0sXG4gIGhvc3Q6IHtcbiAgICBcIltzdHlsZS5taW5XaWR0aF1cIjogXCJjb250ZW50Lm1pbldpZHRoXCIsXG4gICAgXCJbc3R5bGUud2lkdGhdXCI6IFwiY29udGVudC53aWR0aFwiXG4gIH1cbn0pXG5leHBvcnQgY2xhc3MgVm9jYWJ1bGFyeUNvbXBvbmVudCBleHRlbmRzIElucHV0Q29udHJvbFxuICBpbXBsZW1lbnRzIE9uSW5pdCB7XG5cbiAgLy8gaW50ZXJuYWxDb250cm9sID0gbmV3IEZvcm1Db250cm9sKCk7XG5cbiAgLy90aGlzIGNvbnRyb2wgaXMgdXNlZCBieSB0aGUgY2hpcHMsbm90IG5lY2Vzc2FyeSB0byBleHBvc2UgaXRcbiAgY2hpcHNGb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbCgpO1xuICBpbnB1dElkOiBzdHJpbmc7XG4gIGZpbHRlcmVkT3B0aW9uczogT2JzZXJ2YWJsZTxUZXJtTm9kZVtdPjtcbiAgY2hpcHNMaXN0OiBUZXJtTm9kZVtdID0gW107XG4gIHNlbGVjdE9wdGlvbnM6IFRlcm1Ob2RlW10gPSBbXTtcblxuICB0ZXJtczogVGVybU5vZGVbXSA9IFtdO1xuXG4gIGxvYWRpbmcgPSB0cnVlO1xuXG4gIGV4dHJhQ29udGVudDogVm9jYWJ1bGFyeUNvbXBvbmVudEV4dHJhQ29udGVudDtcblxuICAvLyBzZWxlY3RlZFRlcm1zSWRzID0gW107XG5cbiAgc2VhcmNoVGV4dCA9IFwiU2VsZWNjaW9uZSBsYXMgb3BjaW9uZXNcIjtcblxuICBwcml2YXRlIHRlcm1zVHJlZU9ic2VydmVyOiBQYXJ0aWFsT2JzZXJ2ZXI8UmVzcG9uc2U8YW55Pj4gPSB7XG4gICAgbmV4dDogKHJlc3BvbnNlOiBSZXNwb25zZTxhbnk+KSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhcIlZPQ0FCVUxBUlkgQ09NUE9ORU5UIFJFU1BPTlNFIFwiLHJlc3BvbnNlKVxuICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YS50cmVlKTtcblxuICAgICAgdGhpcy50ZXJtcyA9IHJlc3BvbnNlLmRhdGEudHJlZS50ZXJtX25vZGU7XG5cbiAgICAgIHRoaXMudGVybXMuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgICAgdGhpcy5zZWxlY3RPcHRpb25zID0gdGhpcy5zZWxlY3RPcHRpb25zLmNvbmNhdChcbiAgICAgICAgICB0aGlzLl9nZXRfdGVybXMoZWxlbWVudClcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgfSxcblxuICAgIGVycm9yOiAoZXJyOiBhbnkpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFwiVGhlIG9ic2VydmFibGUgZ290IGFuIGVycm9yIG5vdGlmaWNhdGlvbjogXCIgKyBlcnIgKyBcIi5cIik7XG4gICAgfSxcblxuICAgIGNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhcIlRoZSBvYnNlcnZhYmxlIGdvdCBhIGNvbXBsZXRlIG5vdGlmaWNhdGlvbi5cIik7XG4gICAgICB0aGlzLmxvYWRpbmcgPSAhdGhpcy5sb2FkaW5nO1xuICAgIH1cbiAgfTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHNlcnZpY2U6IFRheG9ub215U2VydmljZSlcbiAge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBuZ09uSW5pdCgpXG4gIHtcbiAgICB0aGlzLmluaXQoJycsICcnLCBmYWxzZSwgdHJ1ZSk7XG4gICAgLy8gKHRoaXMuY29udGVudC5wYXJlbnRGb3JtU2VjdGlvbiBhcyBGb3JtR3JvdXApLmFkZENvbnRyb2woXG4gICAgLy8gICB0aGlzLmNvbnRlbnQubmFtZSxcbiAgICAvLyAgIHRoaXMuaW50ZXJuYWxDb250cm9sXG4gICAgLy8gKTtcblxuICAgIGlmICh0aGlzLmNvbnRlbnQucmVxdWlyZWQpIHtcbiAgICAgIHRoaXMuY29udGVudC5mb3JtQ29udHJvbC5zZXRWYWxpZGF0b3JzKFxuICAgICAgICAoY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwgPT4ge1xuICAgICAgICAgIHJldHVybiAhdGhpcy5jb250ZW50LnZhbHVlIHx8IHRoaXMuY29udGVudC52YWx1ZS5sZW5ndGggPT0gMFxuICAgICAgICAgICAgPyB7IHJlcXVpcmVkVGVybXM6IFwiTm8gVGVybXMgU2VsZWN0ZWRcIiB9XG4gICAgICAgICAgICA6IG51bGw7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5pbnB1dElkID0gdGhpcy5jb250ZW50LmxhYmVsLnRyaW0oKS50b0xvd2VyQ2FzZSgpO1xuICAgIGlmICh0aGlzLmNvbnRlbnQuZXh0cmFDb250ZW50KSB7XG4gICAgICB0aGlzLmV4dHJhQ29udGVudCA9IHRoaXMuY29udGVudC5leHRyYUNvbnRlbnQ7XG5cbiAgICAgIC8vIGlmICh0aGlzLmV4dHJhQ29udGVudC5tdWx0aXBsZSAhPT0gbnVsbCkge1xuICAgICAgLy8gICB0aGlzLm11bHRpcGxlID0gdGhpcy5leHRyYUNvbnRlbnQubXVsdGlwbGU7XG4gICAgICAvLyB9XG4gICAgICAvLyBpZiAodGhpcy5leHRyYUNvbnRlbnQuc2VsZWN0ZWRUZXJtc0lkcykge1xuICAgICAgLy8gICB0aGlzLmNvbnRlbnQudmFsdWUgPSB0aGlzLmV4dHJhQ29udGVudC5zZWxlY3RlZFRlcm1zSWRzO1xuICAgICAgLy8gfSBlbHNlIHtcbiAgICAgIC8vICAgdGhpcy5jb250ZW50LnZhbHVlID0gW107XG4gICAgICAvLyB9XG5cbiAgICAgIC8vIGFscmVhZHkgc2VsZWN0ZWQgdGVybXNcbiAgICAgIGlmICghdGhpcy5leHRyYUNvbnRlbnQuc2VsZWN0ZWRUZXJtc0lkcykge1xuICAgICAgICB0aGlzLmV4dHJhQ29udGVudC5zZWxlY3RlZFRlcm1zSWRzID0gW107XG4gICAgICB9XG5cbiAgICAgIC8vIHRlcm1zIGlkcyB0byBleGNsdWRlIG9mIHRoZSBwb3NzaWJsZSBvcHRpb25zLlxuICAgICAgaWYgKCF0aGlzLmV4dHJhQ29udGVudC5leGNsdWRlVGVybXNJZHMpIHtcbiAgICAgICAgdGhpcy5leHRyYUNvbnRlbnQuZXhjbHVkZVRlcm1zSWRzID0gW107XG4gICAgICB9XG4gICAgICB0aGlzLmNvbnRlbnQudmFsdWUgPSBbXTtcblxuICAgICAgaWYgKHRoaXMuZXh0cmFDb250ZW50LmxldmVsID09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLmV4dHJhQ29udGVudC5sZXZlbCA9IDEwO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuZXh0cmFDb250ZW50LnZvY2FiKSB7XG4gICAgICAgIC8vIHRoaXMudm9jYWIgPSB0aGlzLmV4dHJhQ29udGVudC52b2NhYjtcbiAgICAgICAgdGhpcy5zZXJ2aWNlXG4gICAgICAgICAgLmdldFRlcm1zVHJlZUJ5Vm9jYWIodGhpcy5leHRyYUNvbnRlbnQudm9jYWIsIHRoaXMuZXh0cmFDb250ZW50LmxldmVsKVxuICAgICAgICAgIC5zdWJzY3JpYmUodGhpcy50ZXJtc1RyZWVPYnNlcnZlcik7XG4gICAgICB9XG4gICAgLy8gICBlbHNlIGlmKHRoaXMuZXh0cmFDb250ZW50LnRlcm1JRCl7XG4gICAgLy8gICAgIHRoaXMuc2VydmljZS5nZXRUZXJtQnlVVUlEKHRoaXMuZXh0cmFDb250ZW50LnRlcm1JRCwgdGhpcy5leHRyYUNvbnRlbnQubGV2ZWwpXG4gICAgLy8gICAgIC5zdWJzY3JpYmUodGhpcy50ZXJtc1RyZWVPYnNlcnZlcik7XG4gICAgLy8gfVxuICAgICAgdGhpcy5fdXBkYXRlRmlsdGVyZWRPcHRpb25zKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRWYWxpZGF0aW9uKCkge1xuICAgIGlmICh0aGlzLmNvbnRlbnQuZm9ybUNvbnRyb2wudmFsaWQpIHtcbiAgICAgIHRoaXMuY2hpcHNGb3JtQ29udHJvbC5zZXRFcnJvcnMobnVsbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2hpcHNGb3JtQ29udHJvbC5zZXRFcnJvcnMoeyByZXF1aWVyZWQ6IHRydWUgfSk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgYWRkVGVybVRvVmFsdWUodGVybTogVGVybSkge1xuICAgIGlmICh0aGlzLmV4dHJhQ29udGVudC5tdWx0aXBsZSkge1xuICAgICAgdGhpcy5jb250ZW50LnZhbHVlLnVuc2hpZnQodGVybSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY29udGVudC52YWx1ZSA9IFt0ZXJtXTtcbiAgICB9XG4gICAgdGhpcy5jb250ZW50LmZvcm1Db250cm9sLnNldFZhbHVlKHRoaXMuY29udGVudC52YWx1ZSk7XG4gICAgdGhpcy5zZXRWYWxpZGF0aW9uKCk7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZVRlcm1Gcm9tVmFsdWUodGVybTogVGVybSkge1xuICAgIHRoaXMuY29udGVudC52YWx1ZSA9ICh0aGlzLmNvbnRlbnQudmFsdWUgYXMgW10pLmZpbHRlcihcbiAgICAgIChlOiBUZXJtKSA9PiBlLmlkICE9PSB0ZXJtLmlkXG4gICAgKTtcbiAgICB0aGlzLmNvbnRlbnQuZm9ybUNvbnRyb2wuc2V0VmFsdWUodGhpcy5jb250ZW50LnZhbHVlKTtcbiAgICB0aGlzLnNldFZhbGlkYXRpb24oKTtcbiAgfVxuXG4gIHByaXZhdGUgX3VwZGF0ZUZpbHRlcmVkT3B0aW9ucygpIHtcbiAgICB0aGlzLmZpbHRlcmVkT3B0aW9ucyA9IHRoaXMuY2hpcHNGb3JtQ29udHJvbC52YWx1ZUNoYW5nZXMucGlwZTxcbiAgICAgIHN0cmluZyxcbiAgICAgIFRlcm1Ob2RlW11cbiAgICA+KFxuICAgICAgc3RhcnRXaXRoKFwiXCIpLFxuICAgICAgbWFwKHZhbHVlID0+IHtcbiAgICAgICAgY29uc3QgZmlsdGVyVmFsdWUgPSB2YWx1ZSA/IHZhbHVlLnRvTG93ZXJDYXNlKCkgOiBcIlwiO1xuICAgICAgICBjb25zb2xlLmxvZygnKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqJylcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5zZWxlY3RPcHRpb25zKTtcbiAgICAgICAgY29uc29sZS5sb2coJyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKicpXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0T3B0aW9ucy5maWx0ZXIob3B0aW9uID0+XG4gICAgICAgICAgb3B0aW9uLnRlcm0uaWRlbnRpZmllci50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGZpbHRlclZhbHVlKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0X3Rlcm1zKG5vZGU6IFRlcm1Ob2RlLCBwYXJlbnQ6IFRlcm1Ob2RlID0gbnVsbCk6IFRlcm1Ob2RlW10ge1xuICAgIGxldCByZXN1bHQ6IFRlcm1Ob2RlW10gPSBbXTtcbiAgICBub2RlLnBhcmVudCA9IHBhcmVudDtcbiAgICAvLyBpZiBpcyBpbiBzZWxlY3RlZCB0ZXJtcyBpZHMgbGlzdCwgdGhlbiBpcyBwYXJ0IG9mIHRoZSB2YWx1ZVxuICAgIGlmIChcbiAgICAgICh0aGlzLmV4dHJhQ29udGVudC5zZWxlY3RlZFRlcm1zSWRzIGFzIFtdKS5zb21lKFxuICAgICAgICBpZCA9PiBpZCA9PT0gbm9kZS50ZXJtLnV1aWRcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRoaXMuYWRkVGVybVRvVmFsdWUobm9kZS50ZXJtKTtcbiAgICAgIHRoaXMuY2hpcHNMaXN0LnB1c2gobm9kZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGlmIGlzIG5vdCBpbiBhbnkgb2YgdGhlIGV4Y2x1ZGUgdGVybSBpZHMsIHRoZW4gcHVzaFxuICAgICAgaWYgKFxuICAgICAgICAhKHRoaXMuZXh0cmFDb250ZW50LmV4Y2x1ZGVUZXJtc0lkcyBhcyBbXSkuc29tZShcbiAgICAgICAgICBpZCA9PiBpZCA9PT0gbm9kZS50ZXJtLnV1aWRcbiAgICAgICAgKVxuICAgICAgKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKG5vZGUpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZihub2RlLmNoaWxkcmVuKXtcbiAgICAgIG5vZGUuY2hpbGRyZW4uZm9yRWFjaChjaGlsZCA9PiB7XG4gICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQodGhpcy5fZ2V0X3Rlcm1zKGNoaWxkLCBub2RlKSk7XG4gICAgICB9KTtcbiAgICB9XG5cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBhZGRDaGlwcyh2YWx1ZTogVGVybU5vZGUpIHtcbiAgICBpZiAodGhpcy5leHRyYUNvbnRlbnQubXVsdGlwbGUpIHtcbiAgICAgIHRoaXMuY2hpcHNMaXN0LnVuc2hpZnQodmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBpZiBub3QgaXMgbXVsdGlwbGUsIHRoZW4gdGhlIGVsZW1lbnQgaW4gdGhlIGNoaXBzTGlzdCBnb2VzIGJhY2sgdG8gdGhlIG9wdGlvbnNcbiAgICAgIGlmICh0aGlzLmNoaXBzTGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0T3B0aW9ucy5wdXNoKHRoaXMuY2hpcHNMaXN0WzBdKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuY2hpcHNMaXN0ID0gW3ZhbHVlXTtcbiAgICB9XG4gICAgdGhpcy5hZGRUZXJtVG9WYWx1ZSh2YWx1ZS50ZXJtKTtcbiAgICB0aGlzLnNlbGVjdE9wdGlvbnMgPSB0aGlzLnNlbGVjdE9wdGlvbnMuZmlsdGVyKFxuICAgICAgb3B0aW9uID0+IG9wdGlvbi50ZXJtLmlkICE9PSB2YWx1ZS50ZXJtLmlkXG4gICAgKTtcblxuICAgIHRoaXMuY2hpcHNGb3JtQ29udHJvbC5zZXRWYWx1ZShcIlwiKTtcbiAgICAvLyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmlucHV0SWQpLmJsdXIoKTtcbiAgICB0aGlzLl91cGRhdGVGaWx0ZXJlZE9wdGlvbnMoKTtcbiAgfVxuXG4gIHJlbW92ZUNoaXAoaW5kZXg6IG51bWJlcikge1xuICAgIHRoaXMuc2VsZWN0T3B0aW9ucy5wdXNoKHRoaXMuY2hpcHNMaXN0W2luZGV4XSk7XG4gICAgdGhpcy5yZW1vdmVUZXJtRnJvbVZhbHVlKHRoaXMuY2hpcHNMaXN0W2luZGV4XS50ZXJtKTtcbiAgICB0aGlzLmNoaXBzTGlzdC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIHRoaXMuX3VwZGF0ZUZpbHRlcmVkT3B0aW9ucygpO1xuICB9XG5cbiAgZ2V0VGVybU5hbWVJbkFUcmVlKG5vZGU6IFRlcm1Ob2RlKSB7XG4gICAgaWYgKG5vZGUucGFyZW50ICE9IG51bGwpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldFRlcm1OYW1lSW5BVHJlZShub2RlLnBhcmVudCkgKyBcIiAvIFwiICsgbm9kZS50ZXJtLmRlc2NyaXB0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbm9kZS50ZXJtLmRlc2NyaXB0aW9uO1xuICAgIH1cbiAgfVxufVxuIl19