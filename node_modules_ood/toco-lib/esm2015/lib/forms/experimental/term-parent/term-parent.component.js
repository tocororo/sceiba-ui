/**
 * @fileoverview added by tsickle
 * Generated from: lib/forms/experimental/term-parent/term-parent.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 *   Copyright (c) 2020 Universidad de Pinar del Río "Hermanos Saíz Montes de Oca"
 *   All rights reserved.
 */
import { Component } from '@angular/core';
import { FormControl } from '@angular/forms';
import { startWith, map } from 'rxjs/operators';
import { InputControl } from '../../input/input.control';
export class TermParentComponent extends InputControl {
    constructor() {
        super();
        // internalControl = new FormControl();
        this.formControl = new FormControl();
        this.selectOptions = [];
        this.currentTerm = null;
        this.parentTerm = null;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.init('', '', false, true);
        // (this.content.parentFormSection as FormGroup).addControl(
        //     this.content.name,
        //     this.internalControl
        //   );
        console.log(this.content.value);
        console.log(this.content.required);
        console.log(this.content.required && (this.content.value == 0 || this.content.value == null || this.content.value == undefined));
        if (this.content.required) {
            this.content.formControl.setValidators((/**
             * @param {?} control
             * @return {?}
             */
            (control) => {
                return (control.value == 0 || control.value == null || control.value == undefined)
                    ? { 'requiredTerms': 'No Terms Selected' }
                    : null;
            }));
        }
        this.setValueToInternalControl();
        this.inputId = this.content.label.trim().toLowerCase();
        if (this.content.extraContent && this.content.extraContent.terms) {
            if (this.content.extraContent.currentTerm) {
                this.currentTerm = this.content.extraContent.currentTerm;
            }
            ((/** @type {?} */ (this.content.extraContent.terms))).forEach((/**
             * @param {?} element
             * @return {?}
             */
            element => {
                this.selectOptions = this.selectOptions.concat(this._get_terms(element));
            }));
            this._updateFilteredOptions();
        }
    }
    /**
     * @private
     * @return {?}
     */
    _updateFilteredOptions() {
        this.filteredOptions = this.formControl.valueChanges.pipe(startWith(''), map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            /** @type {?} */
            const filterValue = value.toLowerCase();
            return this.selectOptions.filter((/**
             * @param {?} option
             * @return {?}
             */
            option => option.identifier.toLowerCase().includes(filterValue)));
        })));
    }
    /**
     * @private
     * @param {?} node
     * @return {?}
     */
    _get_terms(node) {
        /** @type {?} */
        let result = [];
        if (!this.currentTerm) {
            result.push(node.term);
        }
        else {
            if (this.currentTerm.id !== node.term.id) {
                if (this.currentTerm.parent_id && this.currentTerm.parent_id === node.term.id) {
                    this.parentTerm = node.term;
                }
                else {
                    result.push(node.term);
                }
            }
        }
        node.children.forEach((/**
         * @param {?} child
         * @return {?}
         */
        child => {
            result = result.concat(this._get_terms(child));
        }));
        return result;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    addParent(value) {
        this.parentTerm = value;
        this.selectOptions = this.selectOptions.filter((/**
         * @param {?} option
         * @return {?}
         */
        option => option.id !== value.id));
        this.formControl.setValue('');
        this._updateFilteredOptions();
        // document.getElementById(this.inputId).blur();
        (this.currentTerm) ? this.currentTerm.parent_id = this.parentTerm.id : this.parentTerm.id;
        this.setValueToInternalControl();
    }
    /**
     * @return {?}
     */
    removeParent() {
        this.selectOptions.push(this.parentTerm);
        this._updateFilteredOptions();
        this.parentTerm = null;
        this.setValueToInternalControl();
    }
    /**
     * @private
     * @return {?}
     */
    setValueToInternalControl() {
        if (this.parentTerm == null) {
            this.content.value = null;
            this.content.formControl.setValue(null);
        }
        else {
            this.content.value = this.parentTerm.id;
            this.content.formControl.setValue(this.content.value);
        }
        if (this.content.formControl.valid) {
            this.formControl.setErrors(null);
        }
        else {
            this.formControl.setErrors({ requiered: true });
        }
    }
}
TermParentComponent.decorators = [
    { type: Component, args: [{
                selector: 'toco-term-parent',
                template: "<div class=\"card-filter\" *ngIf=\"content.extraContent\">\n\n  <mat-form-field style=\"width: 100%;\">\n\n      <mat-label> {{content.label}} <span *ngIf=\"content.required\">*</span></mat-label>\n    <input \n        matInput \n        id=\"'inputId-'{{content.name}}\" \n        type=\"text\" \n        [formControl]=\"formControl\"\n        [placeholder]=\"content.label\"\n        [matAutocomplete]=\"auto\" \n        aria-label=\"Number\" \n      />\n    <mat-autocomplete #auto=\"matAutocomplete\">\n      <mat-option *ngFor=\"let option of filteredOptions | async\" [value]=\"option.identifier\" (click)=\"addParent(option)\"\n        [title]=\"option.description\">\n        {{ option.description }}\n      </mat-option>\n    </mat-autocomplete>\n\n  </mat-form-field>\n\n  <mat-chip-list fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"margin-bottom: .5em\" id=\"chiplist\">\n    <mat-chip (click)=\"removeParent()\" *ngIf=\"parentTerm\">{{ parentTerm.description }}</mat-chip>\n  </mat-chip-list>\n\n</div>",
                host: {
                    '[style.minWidth]': 'content.minWidth',
                    '[style.width]': 'content.width'
                },
                styles: [""]
            }] }
];
/** @nocollapse */
TermParentComponent.ctorParameters = () => [];
if (false) {
    /** @type {?} */
    TermParentComponent.prototype.formControl;
    /** @type {?} */
    TermParentComponent.prototype.inputId;
    /** @type {?} */
    TermParentComponent.prototype.filteredOptions;
    /** @type {?} */
    TermParentComponent.prototype.selectOptions;
    /** @type {?} */
    TermParentComponent.prototype.currentTerm;
    /** @type {?} */
    TermParentComponent.prototype.parentTerm;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVybS1wYXJlbnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vdG9jby1saWIvIiwic291cmNlcyI6WyJsaWIvZm9ybXMvZXhwZXJpbWVudGFsL3Rlcm0tcGFyZW50L3Rlcm0tcGFyZW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFNQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQWdELE1BQU0sZ0JBQWdCLENBQUM7QUFFM0YsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUloRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFZekQsTUFBTSxPQUFPLG1CQUFvQixTQUFRLFlBQVk7SUFZakQ7UUFFSSxLQUFLLEVBQUUsQ0FBQzs7UUFUWixnQkFBVyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFHaEMsa0JBQWEsR0FBVyxFQUFFLENBQUM7UUFDM0IsZ0JBQVcsR0FBUyxJQUFJLENBQUM7UUFDekIsZUFBVSxHQUFTLElBQUksQ0FBQztJQUt4QixDQUFDOzs7O0lBRUQsUUFBUTtRQUVOLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDN0IsNERBQTREO1FBQzVELHlCQUF5QjtRQUN6QiwyQkFBMkI7UUFDM0IsT0FBTztRQUVQLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUMvQixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLENBQUMs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SyxHQUFHLElBQUksQ0FBQztZQUMxQixJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDM0M7YUFBSTtZQUNELElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1lBQ3hDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3pEO1FBRUQsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUM7WUFDL0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDcEM7YUFBSTtZQUNELElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLEVBQUMsU0FBUyxFQUFDLElBQUksRUFBQyxDQUFDLENBQUM7U0FDaEQ7SUFDTCxDQUFDOzs7WUFoSUosU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxrQkFBa0I7Z0JBQzVCLDZnQ0FBMkM7Z0JBRTNDLElBQUksRUFBRTtvQkFDRixrQkFBa0IsRUFBRSxrQkFBa0I7b0JBQ3RDLGVBQWUsRUFBRSxlQUFlO2lCQUNuQzs7YUFDSjs7Ozs7O0lBTUcsMENBQWdDOztJQUNoQyxzQ0FBZ0I7O0lBQ2hCLDhDQUFvQzs7SUFDcEMsNENBQTJCOztJQUMzQiwwQ0FBeUI7O0lBQ3pCLHlDQUF3QiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiAgIENvcHlyaWdodCAoYykgMjAyMCBVbml2ZXJzaWRhZCBkZSBQaW5hciBkZWwgUsOtbyBcIkhlcm1hbm9zIFNhw616IE1vbnRlcyBkZSBPY2FcIlxuICogICBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICovXG5cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Db250cm9sLCBBYnN0cmFjdENvbnRyb2wsIFZhbGlkYXRpb25FcnJvcnMsIEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN0YXJ0V2l0aCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5cbmltcG9ydCB7IEZvcm1GaWVsZENvbnRyb2xfRXhwZXJpbWVudGFsIH0gZnJvbSAnLi4vZm9ybS1maWVsZC5jb250cm9sLmV4cGVyaW1lbnRhbCc7XG5pbXBvcnQgeyBJbnB1dENvbnRyb2wgfSBmcm9tICcuLi8uLi9pbnB1dC9pbnB1dC5jb250cm9sJztcbmltcG9ydCB7IFRlcm0sIFRlcm1Ob2RlIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvcHVibGljLWFwaSc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAndG9jby10ZXJtLXBhcmVudCcsXG4gICAgdGVtcGxhdGVVcmw6ICcuL3Rlcm0tcGFyZW50LmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi90ZXJtLXBhcmVudC5jb21wb25lbnQuc2NzcyddLFxuICAgIGhvc3Q6IHtcbiAgICAgICAgJ1tzdHlsZS5taW5XaWR0aF0nOiAnY29udGVudC5taW5XaWR0aCcsXG4gICAgICAgICdbc3R5bGUud2lkdGhdJzogJ2NvbnRlbnQud2lkdGgnXG4gICAgfVxufSlcbmV4cG9ydCBjbGFzcyBUZXJtUGFyZW50Q29tcG9uZW50IGV4dGVuZHMgSW5wdXRDb250cm9sIGltcGxlbWVudHMgT25Jbml0IHtcblxuICAgIC8vIGludGVybmFsQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbCgpO1xuXG5cbiAgICBmb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbCgpO1xuICAgIGlucHV0SWQ6IHN0cmluZztcbiAgICBmaWx0ZXJlZE9wdGlvbnM6IE9ic2VydmFibGU8VGVybVtdPjtcbiAgICBzZWxlY3RPcHRpb25zOiBUZXJtW10gPSBbXTtcbiAgICBjdXJyZW50VGVybTogVGVybSA9IG51bGw7XG4gICAgcGFyZW50VGVybTogVGVybSA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3RvcigpXG4gICAge1xuICAgICAgICBzdXBlcigpO1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuXG4gICAgICB0aGlzLmluaXQoJycsICcnLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgIC8vICh0aGlzLmNvbnRlbnQucGFyZW50Rm9ybVNlY3Rpb24gYXMgRm9ybUdyb3VwKS5hZGRDb250cm9sKFxuICAgICAgICAvLyAgICAgdGhpcy5jb250ZW50Lm5hbWUsXG4gICAgICAgIC8vICAgICB0aGlzLmludGVybmFsQ29udHJvbFxuICAgICAgICAvLyAgICk7XG5cbiAgICAgICAgY29uc29sZS5sb2codGhpcy5jb250ZW50LnZhbHVlKVxuICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmNvbnRlbnQucmVxdWlyZWQpO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKHRoaXMuY29udGVudC5yZXF1aXJlZCAmJiAodGhpcy5jb250ZW50LnZhbHVlID09IDAgfHwgdGhpcy5jb250ZW50LnZhbHVlID09IG51bGwgfHwgdGhpcy5jb250ZW50LnZhbHVlID09IHVuZGVmaW5lZCkpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbnRlbnQucmVxdWlyZWQpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudC5mb3JtQ29udHJvbC5zZXRWYWxpZGF0b3JzKChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChjb250cm9sLnZhbHVlID09IDAgfHwgY29udHJvbC52YWx1ZSA9PSBudWxsIHx8IGNvbnRyb2wudmFsdWUgPT0gdW5kZWZpbmVkKVxuICAgICAgICAgICAgICAgICAgICA/IHsgJ3JlcXVpcmVkVGVybXMnOiAnTm8gVGVybXMgU2VsZWN0ZWQnIH1cbiAgICAgICAgICAgICAgICAgICAgOiBudWxsO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRWYWx1ZVRvSW50ZXJuYWxDb250cm9sKCk7XG5cblxuICAgICAgICB0aGlzLmlucHV0SWQgPSB0aGlzLmNvbnRlbnQubGFiZWwudHJpbSgpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmICh0aGlzLmNvbnRlbnQuZXh0cmFDb250ZW50ICYmIHRoaXMuY29udGVudC5leHRyYUNvbnRlbnQudGVybXMpIHtcblxuICAgICAgICAgICAgaWYgKHRoaXMuY29udGVudC5leHRyYUNvbnRlbnQuY3VycmVudFRlcm0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUZXJtID0gdGhpcy5jb250ZW50LmV4dHJhQ29udGVudC5jdXJyZW50VGVybTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgKHRoaXMuY29udGVudC5leHRyYUNvbnRlbnQudGVybXMgYXMgVGVybU5vZGVbXSkuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdE9wdGlvbnMgPSB0aGlzLnNlbGVjdE9wdGlvbnMuY29uY2F0KHRoaXMuX2dldF90ZXJtcyhlbGVtZW50KSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5fdXBkYXRlRmlsdGVyZWRPcHRpb25zKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF91cGRhdGVGaWx0ZXJlZE9wdGlvbnMoKSB7XG4gICAgICAgIHRoaXMuZmlsdGVyZWRPcHRpb25zID0gdGhpcy5mb3JtQ29udHJvbC52YWx1ZUNoYW5nZXMucGlwZTxzdHJpbmcsIFRlcm1bXT4oXG4gICAgICAgICAgICBzdGFydFdpdGgoJycpLFxuICAgICAgICAgICAgbWFwKHZhbHVlID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJWYWx1ZSA9IHZhbHVlLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0T3B0aW9ucy5maWx0ZXIob3B0aW9uID0+IG9wdGlvbi5pZGVudGlmaWVyLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoZmlsdGVyVmFsdWUpKTtcbiAgICAgICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRfdGVybXMobm9kZTogVGVybU5vZGUpOiBUZXJtW10ge1xuICAgICAgICBsZXQgcmVzdWx0OiBUZXJtW10gPSBbXTtcbiAgICAgICAgaWYgKCF0aGlzLmN1cnJlbnRUZXJtKSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaChub2RlLnRlcm0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudFRlcm0uaWQgIT09IG5vZGUudGVybS5pZCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRUZXJtLnBhcmVudF9pZCAmJiB0aGlzLmN1cnJlbnRUZXJtLnBhcmVudF9pZCA9PT0gbm9kZS50ZXJtLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50VGVybSA9IG5vZGUudGVybTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChub2RlLnRlcm0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIG5vZGUuY2hpbGRyZW4uZm9yRWFjaChjaGlsZCA9PiB7XG4gICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KHRoaXMuX2dldF90ZXJtcyhjaGlsZCkpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGFkZFBhcmVudCh2YWx1ZTogVGVybSkge1xuXG4gICAgICAgIHRoaXMucGFyZW50VGVybSA9IHZhbHVlO1xuICAgICAgICB0aGlzLnNlbGVjdE9wdGlvbnMgPSB0aGlzLnNlbGVjdE9wdGlvbnMuZmlsdGVyKG9wdGlvbiA9PiBvcHRpb24uaWQgIT09IHZhbHVlLmlkKTtcblxuICAgICAgICB0aGlzLmZvcm1Db250cm9sLnNldFZhbHVlKCcnKTtcbiAgICAgICAgdGhpcy5fdXBkYXRlRmlsdGVyZWRPcHRpb25zKCk7XG4gICAgICAgIC8vIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaW5wdXRJZCkuYmx1cigpO1xuXG4gICAgICAgICh0aGlzLmN1cnJlbnRUZXJtKSA/IHRoaXMuY3VycmVudFRlcm0ucGFyZW50X2lkID0gdGhpcy5wYXJlbnRUZXJtLmlkIDogdGhpcy5wYXJlbnRUZXJtLmlkO1xuICAgICAgICB0aGlzLnNldFZhbHVlVG9JbnRlcm5hbENvbnRyb2woKTtcbiAgICB9XG5cbiAgICByZW1vdmVQYXJlbnQoKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0T3B0aW9ucy5wdXNoKHRoaXMucGFyZW50VGVybSk7XG4gICAgICAgIHRoaXMuX3VwZGF0ZUZpbHRlcmVkT3B0aW9ucygpO1xuICAgICAgICB0aGlzLnBhcmVudFRlcm0gPSBudWxsO1xuICAgICAgICB0aGlzLnNldFZhbHVlVG9JbnRlcm5hbENvbnRyb2woKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldFZhbHVlVG9JbnRlcm5hbENvbnRyb2woKXtcbiAgICAgICAgaWYoIHRoaXMucGFyZW50VGVybSA9PSBudWxsKXtcbiAgICAgICAgICAgIHRoaXMuY29udGVudC52YWx1ZSA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnQuZm9ybUNvbnRyb2wuc2V0VmFsdWUobnVsbCk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgdGhpcy5jb250ZW50LnZhbHVlID0gdGhpcy5wYXJlbnRUZXJtLmlkO1xuICAgICAgICAgICAgdGhpcy5jb250ZW50LmZvcm1Db250cm9sLnNldFZhbHVlKHRoaXMuY29udGVudC52YWx1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5jb250ZW50LmZvcm1Db250cm9sLnZhbGlkKXtcbiAgICAgICAgICAgIHRoaXMuZm9ybUNvbnRyb2wuc2V0RXJyb3JzKG51bGwpO1xuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgIHRoaXMuZm9ybUNvbnRyb2wuc2V0RXJyb3JzKHtyZXF1aWVyZWQ6dHJ1ZX0pO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19