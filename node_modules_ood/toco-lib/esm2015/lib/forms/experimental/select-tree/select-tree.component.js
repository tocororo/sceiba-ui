/**
 * @fileoverview added by tsickle
 * Generated from: lib/forms/experimental/select-tree/select-tree.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 *   Copyright (c) 2020 Universidad de Pinar del Río "Hermanos Saíz Montes de Oca"
 *   All rights reserved.
 */
import { Component } from "@angular/core";
import { FlatTreeControl } from "@angular/cdk/tree";
import { MatTreeFlattener, MatTreeFlatDataSource } from "@angular/material";
import { SelectionModel } from "@angular/cdk/collections";
import { of } from "rxjs";
import { InputControl } from '../../input/input.control';
/**
 * @record
 */
export function SelectOptionNode() { }
if (false) {
    /** @type {?} */
    SelectOptionNode.prototype.element;
    /** @type {?|undefined} */
    SelectOptionNode.prototype.parent;
    /** @type {?|undefined} */
    SelectOptionNode.prototype.children;
}
/**
 * @record
 */
export function FlatTreeNode() { }
if (false) {
    /** @type {?} */
    FlatTreeNode.prototype.name;
    /** @type {?} */
    FlatTreeNode.prototype.level;
    /** @type {?} */
    FlatTreeNode.prototype.expandable;
    /** @type {?} */
    FlatTreeNode.prototype.element;
}
/**
 * @record
 */
function TreeFilterData() { }
if (false) {
    /** @type {?} */
    TreeFilterData.prototype.selectOptions;
    /** @type {?} */
    TreeFilterData.prototype.type;
    /** @type {?} */
    TreeFilterData.prototype.placeholder;
    /** @type {?} */
    TreeFilterData.prototype.text;
    /** @type {?} */
    TreeFilterData.prototype.field;
    /** @type {?} */
    TreeFilterData.prototype.index;
    /** @type {?} */
    TreeFilterData.prototype.value;
    /** @type {?} */
    TreeFilterData.prototype.idVocab;
}
export class SelectTreeComponent extends InputControl {
    constructor() {
        super();
        this.checklistSelection = new SelectionModel(true /* multiple */);
        this.treeFlattener = new MatTreeFlattener(this.transformer, this.getLevel, this.isExpandable, this.getChildren);
        this.treeControl = new FlatTreeControl(this.getLevel, this.isExpandable);
        this.dataSource = new MatTreeFlatDataSource(this.treeControl, this.treeFlattener);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        // (this.content.parentFormSection as FormGroup).addControl(
        //   this.content.name,
        //   this.internalControl
        // );
        this.init('', '', false, true);
        if (this.content.extraContent) {
            if (this.content.extraContent.observable) {
                this.content.extraContent.observable.subscribe((
                // next
                /**
                 * @param {?} response
                 * @return {?}
                 */
                (response) => {
                    console.log(response);
                    this.data = this.content.extraContent.getOptions(response);
                    console.log(this.data);
                    this.dataSource.data = this.data;
                    console.log(this.dataSource);
                    this.content.extraContent.selectedTermsIds.forEach((/**
                     * @param {?} uuid
                     * @return {?}
                     */
                    (uuid) => {
                        console.log(uuid);
                        this.treeControl.dataNodes.forEach((/**
                         * @param {?} node
                         * @return {?}
                         */
                        node => {
                            if (node.element.value == uuid) {
                                console.log(node);
                                if (node.expandable) {
                                    this.itemSelectionToggle(node);
                                }
                                else {
                                    this.leafItemSelectionToggle(node);
                                }
                            }
                        }));
                    }));
                }), (
                // error
                /**
                 * @param {?} error
                 * @return {?}
                 */
                (error) => {
                    console.log(error);
                }), (
                // complete
                /**
                 * @return {?}
                 */
                () => { }));
            }
            else {
                this.data = this.content.extraContent.getOptions();
                this.dataSource.data = this.data;
            }
            if (!this.content.extraContent.selectedTermsIds) {
                this.content.extraContent.selectedTermsIds = [];
            }
        }
        this.content.value = "";
    }
    /**
     * @return {?}
     */
    remove_component() { }
    /**
     * @return {?}
     */
    onChange() {
        console.log("ttree change");
    }
    /**
     * @return {?}
     */
    emitSelection() {
        this.content.formControl.setValue(this.checklistSelection.selected);
        // this.content.extraContent.selectionChange(this.checklistSelection.selected)
        // var valueEmiter = "OR";
        // this.checklistSelection.selected.forEach(node => {
        //   valueEmiter = valueEmiter + "," + node.element.value;
        // });
        // if (this.content.extraContent.selectionChange) {
        //   this.content.extraContent.selectionChange(this.content.value);
        // }
    }
    /**
     * Transform the data to something the tree can read.
     * @param {?} node
     * @param {?} level
     * @return {?}
     */
    transformer(node, level) {
        /** @type {?} */
        const result = {
            name: node.element.label,
            level: level,
            expandable: node.children.length > 0,
            element: node.element
        };
        return result;
    }
    /**
     * Get the level of the node
     * @param {?} node
     * @return {?}
     */
    getLevel(node) {
        return node.level;
    }
    /**
     * Get whether the node is expanded or not.
     * @param {?} node
     * @return {?}
     */
    isExpandable(node) {
        return node.expandable;
    }
    /**
     * Get whether the node has children or not.
     * @param {?} index
     * @param {?} node
     * @return {?}
     */
    hasChild(index, node) {
        return node.expandable;
    }
    /**
     * Get the children for the node.
     * @param {?} node
     * @return {?}
     */
    getChildren(node) {
        return of(node.children);
    }
    /**
     * Whether all the descendants of the node are selected.
     * @param {?} node
     * @return {?}
     */
    descendantsAllSelected(node) {
        if (this.treeControl.dataNodes != undefined) {
            /** @type {?} */
            const descendants = this.treeControl.getDescendants(node);
            /** @type {?} */
            const descAllSelected = descendants.every((/**
             * @param {?} child
             * @return {?}
             */
            child => this.checklistSelection.isSelected(child)));
            return descAllSelected;
        }
        return false;
    }
    /**
     * Whether part of the descendants are selected
     * @param {?} node
     * @return {?}
     */
    descendantsPartiallySelected(node) {
        if (this.treeControl.dataNodes != undefined) {
            /** @type {?} */
            const descendants = this.treeControl.getDescendants(node);
            /** @type {?} */
            const result = descendants.some((/**
             * @param {?} child
             * @return {?}
             */
            child => this.checklistSelection.isSelected(child)));
            return result && !this.descendantsAllSelected(node);
        }
        return false;
    }
    /**
     * Select/deselect all the descendants node
     * @param {?} node
     * @return {?}
     */
    itemSelectionToggle(node) {
        this.checklistSelection.toggle(node);
        /** @type {?} */
        const descendants = this.treeControl.getDescendants(node);
        this.checklistSelection.isSelected(node)
            ? this.checklistSelection.select(...descendants)
            : this.checklistSelection.deselect(...descendants);
        // Force update for the parent
        descendants.every((/**
         * @param {?} child
         * @return {?}
         */
        child => this.checklistSelection.isSelected(child)));
        this.checkAllParentsSelection(node);
        this.emitSelection();
    }
    /**
     * Check all the parents to see if they changed
     * @param {?} node
     * @return {?}
     */
    leafItemSelectionToggle(node) {
        this.checklistSelection.toggle(node);
        this.checkAllParentsSelection(node);
        this.emitSelection();
    }
    /* Checks all the parents when a leaf node is selected/unselected */
    /**
     * @param {?} node
     * @return {?}
     */
    checkAllParentsSelection(node) {
        /** @type {?} */
        let parent = this.getParentNode(node);
        while (parent) {
            this.checkRootNodeSelection(parent);
            parent = this.getParentNode(parent);
        }
    }
    /**
     * Check root node checked state and change it accordingly
     * @param {?} node
     * @return {?}
     */
    checkRootNodeSelection(node) {
        /** @type {?} */
        const nodeSelected = this.checklistSelection.isSelected(node);
        /** @type {?} */
        const descendants = this.treeControl.getDescendants(node);
        /** @type {?} */
        const descAllSelected = descendants.every((/**
         * @param {?} child
         * @return {?}
         */
        child => this.checklistSelection.isSelected(child)));
        if (nodeSelected && !descAllSelected) {
            this.checklistSelection.deselect(node);
        }
        else if (!nodeSelected && descAllSelected) {
            this.checklistSelection.select(node);
        }
    }
    /* Get the parent node of a node */
    /**
     * @param {?} node
     * @return {?}
     */
    getParentNode(node) {
        /** @type {?} */
        const currentLevel = this.getLevel(node);
        if (currentLevel < 1) {
            return null;
        }
        /** @type {?} */
        const startIndex = this.treeControl.dataNodes.indexOf(node) - 1;
        for (let i = startIndex; i >= 0; i--) {
            /** @type {?} */
            const currentNode = this.treeControl.dataNodes[i];
            if (this.getLevel(currentNode) < currentLevel) {
                return currentNode;
            }
        }
        return null;
    }
}
SelectTreeComponent.decorators = [
    { type: Component, args: [{
                selector: "toco-select-tree",
                template: "<mat-tree [dataSource]=\"dataSource\" [treeControl]=\"treeControl\" class=\"scrolleable\">\n  <mat-tree-node\n    class=\"hover\"\n    *matTreeNodeDef=\"let node\"\n    matTreeNodeToggle\n    matTreeNodePadding\n    fxLayout=\"row\"\n    fxLayoutAlign=\"space-between center\"\n    [ngStyle]=\"{ 'white-space': 'normal !important' }\"\n  >\n    <div fxLayout=\"row\" fxLayoutAlign=\"start center\">\n      <button mat-icon-button disabled></button>\n      <mat-checkbox\n        class=\"checklist-leaf-node\"\n        [checked]=\"checklistSelection.isSelected(node)\"\n        (change)=\"leafItemSelectionToggle(node)\"\n        matTooltip=\"{{ node.name }}\"\n        [ngStyle]=\"{ 'white-space': 'normal !important' }\"\n      >\n          {{ node.name }}\n      </mat-checkbox>\n    </div>\n  </mat-tree-node>\n\n  <mat-tree-node\n    class=\"hover\"\n    *matTreeNodeDef=\"let node; when: hasChild\"\n    matTreeNodePadding\n    [ngStyle]=\"{ 'white-space': 'normal !important' }\"\n  >\n    <button\n      mat-icon-button\n      matTreeNodeToggle\n      [attr.aria-label]=\"'toggle ' + node.name\"\n    >\n      <mat-icon class=\"mat-icon-rtl-mirror\">\n        {{ treeControl.isExpanded(node) ? \"expand_more\" : \"chevron_right\" }}\n      </mat-icon>\n    </button>\n    <div class=\"item-width\" fxLayout=\"row\" fxLayoutAlign=\"space-between center\">\n      <mat-checkbox\n        [checked]=\"descendantsAllSelected(node)\"\n        [indeterminate]=\"descendantsPartiallySelected(node)\"\n        (change)=\"itemSelectionToggle(node)\"\n        matTooltip=\"{{ node.name }}\"\n        [ngStyle]=\"{ 'white-space': 'normal !important' }\"\n        >{{ node.name }}</mat-checkbox\n      >\n    </div>\n  </mat-tree-node>\n</mat-tree>\n",
                styles: [".scrolleable{max-height:20em;min-width:15em;overflow:auto}"]
            }] }
];
/** @nocollapse */
SelectTreeComponent.ctorParameters = () => [];
if (false) {
    /** @type {?} */
    SelectTreeComponent.prototype.data;
    /** @type {?} */
    SelectTreeComponent.prototype.treeControl;
    /** @type {?} */
    SelectTreeComponent.prototype.treeFlattener;
    /** @type {?} */
    SelectTreeComponent.prototype.dataSource;
    /** @type {?} */
    SelectTreeComponent.prototype.checklistSelection;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LXRyZWUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vdG9jby1saWIvIiwic291cmNlcyI6WyJsaWIvZm9ybXMvZXhwZXJpbWVudGFsL3NlbGVjdC10cmVlL3NlbGVjdC10cmVlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFLQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBRWxELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM1RSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDMUQsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUkxQixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7Ozs7QUFFekQsc0NBSUM7OztJQUhDLG1DQUFzQjs7SUFDdEIsa0NBQTBCOztJQUMxQixvQ0FBOEI7Ozs7O0FBR2hDLGtDQUtDOzs7SUFKQyw0QkFBYTs7SUFDYiw2QkFBYzs7SUFDZCxrQ0FBb0I7O0lBQ3BCLCtCQUFzQjs7Ozs7QUFFeEIsNkJBU0M7OztJQVJDLHVDQUFrQzs7SUFDbEMsOEJBQWE7O0lBQ2IscUNBQW9COztJQUNwQiw4QkFBYTs7SUFDYiwrQkFBYzs7SUFDZCwrQkFBYzs7SUFDZCwrQkFBVzs7SUFDWCxpQ0FBZ0I7O0FBUWxCLE1BQU0sT0FBTyxtQkFBb0IsU0FBUSxZQUFZO0lBV25EO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFIVix1QkFBa0IsR0FBRyxJQUFJLGNBQWMsQ0FBZSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFJekUsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLGdCQUFnQixDQUN2QyxJQUFJLENBQUMsV0FBVyxFQUNoQixJQUFJLENBQUMsUUFBUSxFQUNiLElBQUks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QUMzQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3RDO0lBQ0gsQ0FBQzs7Ozs7O0lBR0QsYUFBYSxDQUFDLElBQWtCOztjQUN4QixZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFFeEMsSUFBSSxZQUFZLEdBQUcsQ0FBQyxFQUFFO1lBQ3BCLE9BQU8sSUFBSSxDQUFDO1NBQ2I7O2NBRUssVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBRS9ELEtBQUssSUFBSSxDQUFDLEdBQUcsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7O2tCQUM5QixXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBRWpELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsR0FBRyxZQUFZLEVBQUU7Z0JBQzdDLE9BQU8sV0FBVyxDQUFDO2FBQ3BCO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7OztZQW5PRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGtCQUFrQjtnQkFDNUIsNHREQUEyQzs7YUFFNUM7Ozs7OztJQUdDLG1DQUF5Qjs7SUFJekIsMENBQTJDOztJQUMzQyw0Q0FBZ0U7O0lBQ2hFLHlDQUFrRTs7SUFDbEUsaURBQTJFIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqICAgQ29weXJpZ2h0IChjKSAyMDIwIFVuaXZlcnNpZGFkIGRlIFBpbmFyIGRlbCBSw61vIFwiSGVybWFub3MgU2HDrXogTW9udGVzIGRlIE9jYVwiXG4gKiAgIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgRm9ybUNvbnRyb2wsIEZvcm1Hcm91cCB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xuaW1wb3J0IHsgRmxhdFRyZWVDb250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Nkay90cmVlXCI7XG5pbXBvcnQgeyBNYXRUcmVlRmxhdHRlbmVyLCBNYXRUcmVlRmxhdERhdGFTb3VyY2UgfSBmcm9tIFwiQGFuZ3VsYXIvbWF0ZXJpYWxcIjtcbmltcG9ydCB7IFNlbGVjdGlvbk1vZGVsIH0gZnJvbSBcIkBhbmd1bGFyL2Nkay9jb2xsZWN0aW9uc1wiO1xuaW1wb3J0IHsgb2YgfSBmcm9tIFwicnhqc1wiO1xuXG5pbXBvcnQgeyBGb3JtRmllbGRDb250cm9sX0V4cGVyaW1lbnRhbCB9IGZyb20gXCIuLi9mb3JtLWZpZWxkLmNvbnRyb2wuZXhwZXJpbWVudGFsXCI7XG5pbXBvcnQgeyBTZWxlY3RPcHRpb24gfSBmcm9tICcuLi8uLi9pbnB1dC9zZWxlY3Qvc2VsZWN0LWlucHV0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBJbnB1dENvbnRyb2wgfSBmcm9tICcuLi8uLi9pbnB1dC9pbnB1dC5jb250cm9sJztcblxuZXhwb3J0IGludGVyZmFjZSBTZWxlY3RPcHRpb25Ob2RlIHtcbiAgZWxlbWVudDogU2VsZWN0T3B0aW9uO1xuICBwYXJlbnQ/OiBTZWxlY3RPcHRpb25Ob2RlO1xuICBjaGlsZHJlbj86IFNlbGVjdE9wdGlvbk5vZGVbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGbGF0VHJlZU5vZGUge1xuICBuYW1lOiBzdHJpbmc7XG4gIGxldmVsOiBudW1iZXI7XG4gIGV4cGFuZGFibGU6IGJvb2xlYW47XG4gIGVsZW1lbnQ6IFNlbGVjdE9wdGlvbjtcbn1cbmludGVyZmFjZSBUcmVlRmlsdGVyRGF0YSB7XG4gIHNlbGVjdE9wdGlvbnM6IFNlbGVjdE9wdGlvbk5vZGVbXTtcbiAgdHlwZTogc3RyaW5nO1xuICBwbGFjZWhvbGRlcjogc3RyaW5nO1xuICB0ZXh0OiBzdHJpbmc7XG4gIGZpZWxkOiBzdHJpbmc7XG4gIGluZGV4OiBudW1iZXI7XG4gIHZhbHVlOiBhbnk7XG4gIGlkVm9jYWI6IG51bWJlcjtcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiBcInRvY28tc2VsZWN0LXRyZWVcIixcbiAgdGVtcGxhdGVVcmw6IFwiLi9zZWxlY3QtdHJlZS5jb21wb25lbnQuaHRtbFwiLFxuICBzdHlsZVVybHM6IFtcIi4vc2VsZWN0LXRyZWUuY29tcG9uZW50LnNjc3NcIl1cbn0pXG5leHBvcnQgY2xhc3MgU2VsZWN0VHJlZUNvbXBvbmVudCBleHRlbmRzIElucHV0Q29udHJvbFxuICBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIGRhdGE6IFNlbGVjdE9wdGlvbk5vZGVbXTtcblxuICAvLyBpbnRlcm5hbENvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2woKTtcblxuICB0cmVlQ29udHJvbDogRmxhdFRyZWVDb250cm9sPEZsYXRUcmVlTm9kZT47XG4gIHRyZWVGbGF0dGVuZXI6IE1hdFRyZWVGbGF0dGVuZXI8U2VsZWN0T3B0aW9uTm9kZSwgRmxhdFRyZWVOb2RlPjtcbiAgZGF0YVNvdXJjZTogTWF0VHJlZUZsYXREYXRhU291cmNlPFNlbGVjdE9wdGlvbk5vZGUsIEZsYXRUcmVlTm9kZT47XG4gIGNoZWNrbGlzdFNlbGVjdGlvbiA9IG5ldyBTZWxlY3Rpb25Nb2RlbDxGbGF0VHJlZU5vZGU+KHRydWUgLyogbXVsdGlwbGUgKi8pO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy50cmVlRmxhdHRlbmVyID0gbmV3IE1hdFRyZWVGbGF0dGVuZXIoXG4gICAgICB0aGlzLnRyYW5zZm9ybWVyLFxuICAgICAgdGhpcy5nZXRMZXZlbCxcbiAgICAgIHRoaXMuaXNFeHBhbmRhYmxlLFxuICAgICAgdGhpcy5nZXRDaGlsZHJlblxuICAgICk7XG5cbiAgICB0aGlzLnRyZWVDb250cm9sID0gbmV3IEZsYXRUcmVlQ29udHJvbCh0aGlzLmdldExldmVsLCB0aGlzLmlzRXhwYW5kYWJsZSk7XG4gICAgdGhpcy5kYXRhU291cmNlID0gbmV3IE1hdFRyZWVGbGF0RGF0YVNvdXJjZShcbiAgICAgIHRoaXMudHJlZUNvbnRyb2wsXG4gICAgICB0aGlzLnRyZWVGbGF0dGVuZXJcbiAgICApO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG5cbiAgICAvLyAodGhpcy5jb250ZW50LnBhcmVudEZvcm1TZWN0aW9uIGFzIEZvcm1Hcm91cCkuYWRkQ29udHJvbChcbiAgICAvLyAgIHRoaXMuY29udGVudC5uYW1lLFxuICAgIC8vICAgdGhpcy5pbnRlcm5hbENvbnRyb2xcbiAgICAvLyApO1xuXG4gICAgdGhpcy5pbml0KCcnLCAnJywgZmFsc2UsIHRydWUpO1xuICAgIGlmICh0aGlzLmNvbnRlbnQuZXh0cmFDb250ZW50KXtcbiAgICAgIGlmICh0aGlzLmNvbnRlbnQuZXh0cmFDb250ZW50Lm9ic2VydmFibGUpIHtcbiAgICAgICAgdGhpcy5jb250ZW50LmV4dHJhQ29udGVudC5vYnNlcnZhYmxlLnN1YnNjcmliZShcbiAgICAgICAgICAvLyBuZXh0XG4gICAgICAgICAgKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcblxuICAgICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5jb250ZW50LmV4dHJhQ29udGVudC5nZXRPcHRpb25zKHJlc3BvbnNlKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMuZGF0YSk7XG4gICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2UuZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMuZGF0YVNvdXJjZSk7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnQuZXh0cmFDb250ZW50LnNlbGVjdGVkVGVybXNJZHMuZm9yRWFjaCgodXVpZDpzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2codXVpZCk7XG5cbiAgICAgICAgICAgICAgdGhpcy50cmVlQ29udHJvbC5kYXRhTm9kZXMuZm9yRWFjaChub2RlID0+IHtcblxuXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUuZWxlbWVudC52YWx1ZSA9PSB1dWlkKXtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG5vZGUpO1xuXG4gICAgICAgICAgICAgICAgICBpZihub2RlLmV4cGFuZGFibGUpe1xuICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1TZWxlY3Rpb25Ub2dnbGUobm9kZSk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxlYWZJdGVtU2VsZWN0aW9uVG9nZ2xlKG5vZGUpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sXG5cbiAgICAgICAgICAvLyBlcnJvclxuICAgICAgICAgIChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAvLyBjb21wbGV0ZVxuICAgICAgICAgICgpID0+IHt9XG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLmNvbnRlbnQuZXh0cmFDb250ZW50LmdldE9wdGlvbnMoKTtcbiAgICAgICAgdGhpcy5kYXRhU291cmNlLmRhdGEgPSB0aGlzLmRhdGE7XG4gICAgICB9XG4gICAgICBpZiAoIXRoaXMuY29udGVudC5leHRyYUNvbnRlbnQuc2VsZWN0ZWRUZXJtc0lkcykge1xuICAgICAgICB0aGlzLmNvbnRlbnQuZXh0cmFDb250ZW50LnNlbGVjdGVkVGVybXNJZHMgPSBbXTtcbiAgICAgIH1cbiAgICB9XG5cblxuICAgIHRoaXMuY29udGVudC52YWx1ZSA9IFwiXCI7XG4gIH1cblxuICByZW1vdmVfY29tcG9uZW50KCkge31cblxuICBvbkNoYW5nZSgpIHtcbiAgICBjb25zb2xlLmxvZyhcInR0cmVlIGNoYW5nZVwiKTtcbiAgfVxuXG4gIGVtaXRTZWxlY3Rpb24oKSB7XG4gICAgdGhpcy5jb250ZW50LmZvcm1Db250cm9sLnNldFZhbHVlKHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLnNlbGVjdGVkKTtcblxuICAgIC8vIHRoaXMuY29udGVudC5leHRyYUNvbnRlbnQuc2VsZWN0aW9uQ2hhbmdlKHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLnNlbGVjdGVkKVxuICAgIC8vIHZhciB2YWx1ZUVtaXRlciA9IFwiT1JcIjtcbiAgICAvLyB0aGlzLmNoZWNrbGlzdFNlbGVjdGlvbi5zZWxlY3RlZC5mb3JFYWNoKG5vZGUgPT4ge1xuICAgIC8vICAgdmFsdWVFbWl0ZXIgPSB2YWx1ZUVtaXRlciArIFwiLFwiICsgbm9kZS5lbGVtZW50LnZhbHVlO1xuICAgIC8vIH0pO1xuXG4gICAgLy8gaWYgKHRoaXMuY29udGVudC5leHRyYUNvbnRlbnQuc2VsZWN0aW9uQ2hhbmdlKSB7XG4gICAgLy8gICB0aGlzLmNvbnRlbnQuZXh0cmFDb250ZW50LnNlbGVjdGlvbkNoYW5nZSh0aGlzLmNvbnRlbnQudmFsdWUpO1xuICAgIC8vIH1cbiAgfVxuXG4gIC8qKiBUcmFuc2Zvcm0gdGhlIGRhdGEgdG8gc29tZXRoaW5nIHRoZSB0cmVlIGNhbiByZWFkLiAqL1xuICB0cmFuc2Zvcm1lcihub2RlOiBTZWxlY3RPcHRpb25Ob2RlLCBsZXZlbDogbnVtYmVyKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgbmFtZTogbm9kZS5lbGVtZW50LmxhYmVsLFxuICAgICAgbGV2ZWw6IGxldmVsLFxuICAgICAgZXhwYW5kYWJsZTogbm9kZS5jaGlsZHJlbi5sZW5ndGggPiAwLFxuICAgICAgZWxlbWVudDogbm9kZS5lbGVtZW50XG4gICAgfTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqIEdldCB0aGUgbGV2ZWwgb2YgdGhlIG5vZGUgKi9cbiAgZ2V0TGV2ZWwobm9kZTogRmxhdFRyZWVOb2RlKSB7XG4gICAgcmV0dXJuIG5vZGUubGV2ZWw7XG4gIH1cblxuICAvKiogR2V0IHdoZXRoZXIgdGhlIG5vZGUgaXMgZXhwYW5kZWQgb3Igbm90LiAqL1xuICBpc0V4cGFuZGFibGUobm9kZTogRmxhdFRyZWVOb2RlKSB7XG4gICAgcmV0dXJuIG5vZGUuZXhwYW5kYWJsZTtcbiAgfVxuXG4gIC8qKiBHZXQgd2hldGhlciB0aGUgbm9kZSBoYXMgY2hpbGRyZW4gb3Igbm90LiAqL1xuICBoYXNDaGlsZChpbmRleDogbnVtYmVyLCBub2RlOiBGbGF0VHJlZU5vZGUpIHtcbiAgICByZXR1cm4gbm9kZS5leHBhbmRhYmxlO1xuICB9XG5cbiAgLyoqIEdldCB0aGUgY2hpbGRyZW4gZm9yIHRoZSBub2RlLiAqL1xuICBnZXRDaGlsZHJlbihub2RlOiBTZWxlY3RPcHRpb25Ob2RlKSB7XG4gICAgcmV0dXJuIG9mKG5vZGUuY2hpbGRyZW4pO1xuICB9XG5cbiAgLyoqIFdoZXRoZXIgYWxsIHRoZSBkZXNjZW5kYW50cyBvZiB0aGUgbm9kZSBhcmUgc2VsZWN0ZWQuICovXG4gIGRlc2NlbmRhbnRzQWxsU2VsZWN0ZWQobm9kZTogRmxhdFRyZWVOb2RlKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMudHJlZUNvbnRyb2wuZGF0YU5vZGVzICE9IHVuZGVmaW5lZCkge1xuICAgICAgY29uc3QgZGVzY2VuZGFudHMgPSB0aGlzLnRyZWVDb250cm9sLmdldERlc2NlbmRhbnRzKG5vZGUpO1xuICAgICAgY29uc3QgZGVzY0FsbFNlbGVjdGVkID0gZGVzY2VuZGFudHMuZXZlcnkoY2hpbGQgPT5cbiAgICAgICAgdGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uaXNTZWxlY3RlZChjaGlsZClcbiAgICAgICk7XG4gICAgICByZXR1cm4gZGVzY0FsbFNlbGVjdGVkO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKiogV2hldGhlciBwYXJ0IG9mIHRoZSBkZXNjZW5kYW50cyBhcmUgc2VsZWN0ZWQgKi9cbiAgZGVzY2VuZGFudHNQYXJ0aWFsbHlTZWxlY3RlZChub2RlOiBGbGF0VHJlZU5vZGUpOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy50cmVlQ29udHJvbC5kYXRhTm9kZXMgIT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBkZXNjZW5kYW50cyA9IHRoaXMudHJlZUNvbnRyb2wuZ2V0RGVzY2VuZGFudHMobm9kZSk7XG4gICAgICBjb25zdCByZXN1bHQgPSBkZXNjZW5kYW50cy5zb21lKGNoaWxkID0+XG4gICAgICAgIHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLmlzU2VsZWN0ZWQoY2hpbGQpXG4gICAgICApO1xuICAgICAgcmV0dXJuIHJlc3VsdCAmJiAhdGhpcy5kZXNjZW5kYW50c0FsbFNlbGVjdGVkKG5vZGUpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKiogU2VsZWN0L2Rlc2VsZWN0IGFsbCB0aGUgZGVzY2VuZGFudHMgbm9kZSAqL1xuICBpdGVtU2VsZWN0aW9uVG9nZ2xlKG5vZGU6IEZsYXRUcmVlTm9kZSk6IHZvaWQge1xuICAgIHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLnRvZ2dsZShub2RlKTtcbiAgICBjb25zdCBkZXNjZW5kYW50cyA9IHRoaXMudHJlZUNvbnRyb2wuZ2V0RGVzY2VuZGFudHMobm9kZSk7XG4gICAgdGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uaXNTZWxlY3RlZChub2RlKVxuICAgICAgPyB0aGlzLmNoZWNrbGlzdFNlbGVjdGlvbi5zZWxlY3QoLi4uZGVzY2VuZGFudHMpXG4gICAgICA6IHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLmRlc2VsZWN0KC4uLmRlc2NlbmRhbnRzKTtcblxuICAgIC8vIEZvcmNlIHVwZGF0ZSBmb3IgdGhlIHBhcmVudFxuICAgIGRlc2NlbmRhbnRzLmV2ZXJ5KGNoaWxkID0+IHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLmlzU2VsZWN0ZWQoY2hpbGQpKTtcbiAgICB0aGlzLmNoZWNrQWxsUGFyZW50c1NlbGVjdGlvbihub2RlKTtcbiAgICB0aGlzLmVtaXRTZWxlY3Rpb24oKTtcbiAgfVxuXG4gIC8qKiBDaGVjayBhbGwgdGhlIHBhcmVudHMgdG8gc2VlIGlmIHRoZXkgY2hhbmdlZCAqL1xuICBsZWFmSXRlbVNlbGVjdGlvblRvZ2dsZShub2RlOiBGbGF0VHJlZU5vZGUpOiB2b2lkIHtcbiAgICB0aGlzLmNoZWNrbGlzdFNlbGVjdGlvbi50b2dnbGUobm9kZSk7XG4gICAgdGhpcy5jaGVja0FsbFBhcmVudHNTZWxlY3Rpb24obm9kZSk7XG4gICAgdGhpcy5lbWl0U2VsZWN0aW9uKCk7XG4gIH1cblxuICAvKiBDaGVja3MgYWxsIHRoZSBwYXJlbnRzIHdoZW4gYSBsZWFmIG5vZGUgaXMgc2VsZWN0ZWQvdW5zZWxlY3RlZCAqL1xuICBjaGVja0FsbFBhcmVudHNTZWxlY3Rpb24obm9kZTogRmxhdFRyZWVOb2RlKTogdm9pZCB7XG4gICAgbGV0IHBhcmVudDogRmxhdFRyZWVOb2RlIHwgbnVsbCA9IHRoaXMuZ2V0UGFyZW50Tm9kZShub2RlKTtcbiAgICB3aGlsZSAocGFyZW50KSB7XG4gICAgICB0aGlzLmNoZWNrUm9vdE5vZGVTZWxlY3Rpb24ocGFyZW50KTtcbiAgICAgIHBhcmVudCA9IHRoaXMuZ2V0UGFyZW50Tm9kZShwYXJlbnQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBDaGVjayByb290IG5vZGUgY2hlY2tlZCBzdGF0ZSBhbmQgY2hhbmdlIGl0IGFjY29yZGluZ2x5ICovXG4gIGNoZWNrUm9vdE5vZGVTZWxlY3Rpb24obm9kZTogRmxhdFRyZWVOb2RlKTogdm9pZCB7XG4gICAgY29uc3Qgbm9kZVNlbGVjdGVkID0gdGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uaXNTZWxlY3RlZChub2RlKTtcbiAgICBjb25zdCBkZXNjZW5kYW50cyA9IHRoaXMudHJlZUNvbnRyb2wuZ2V0RGVzY2VuZGFudHMobm9kZSk7XG4gICAgY29uc3QgZGVzY0FsbFNlbGVjdGVkID0gZGVzY2VuZGFudHMuZXZlcnkoY2hpbGQgPT5cbiAgICAgIHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLmlzU2VsZWN0ZWQoY2hpbGQpXG4gICAgKTtcbiAgICBpZiAobm9kZVNlbGVjdGVkICYmICFkZXNjQWxsU2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLmRlc2VsZWN0KG5vZGUpO1xuICAgIH0gZWxzZSBpZiAoIW5vZGVTZWxlY3RlZCAmJiBkZXNjQWxsU2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLnNlbGVjdChub2RlKTtcbiAgICB9XG4gIH1cblxuICAvKiBHZXQgdGhlIHBhcmVudCBub2RlIG9mIGEgbm9kZSAqL1xuICBnZXRQYXJlbnROb2RlKG5vZGU6IEZsYXRUcmVlTm9kZSk6IEZsYXRUcmVlTm9kZSB8IG51bGwge1xuICAgIGNvbnN0IGN1cnJlbnRMZXZlbCA9IHRoaXMuZ2V0TGV2ZWwobm9kZSk7XG5cbiAgICBpZiAoY3VycmVudExldmVsIDwgMSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnRJbmRleCA9IHRoaXMudHJlZUNvbnRyb2wuZGF0YU5vZGVzLmluZGV4T2Yobm9kZSkgLSAxO1xuXG4gICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjb25zdCBjdXJyZW50Tm9kZSA9IHRoaXMudHJlZUNvbnRyb2wuZGF0YU5vZGVzW2ldO1xuXG4gICAgICBpZiAodGhpcy5nZXRMZXZlbChjdXJyZW50Tm9kZSkgPCBjdXJyZW50TGV2ZWwpIHtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnROb2RlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuIl19