/**
 * @fileoverview added by tsickle
 * Generated from: lib/authentication/authentication.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 *   Copyright (c) 2020 Universidad de Pinar del Río "Hermanos Saíz Montes de Oca"
 *   All rights reserved.
 */
import { HttpClient } from '@angular/common/http';
import { Injectable, Optional } from '@angular/core';
import { Router } from '@angular/router';
import { JwksValidationHandler, OAuthModuleConfig, OAuthResourceServerErrorHandler, OAuthService, OAuthStorage } from 'angular-oauth2-oidc';
import { Subject, throwError } from 'rxjs';
import { catchError } from 'rxjs/operators';
import { Environment } from '../core/public-api';
import * as i0 from "@angular/core";
import * as i1 from "angular-oauth2-oidc";
import * as i2 from "@angular/common/http";
import * as i3 from "@angular/router";
import * as i4 from "../core/env";
/** @enum {string} */
const AuthBackend = {
    /**
     * `sceiba` represent the Sceiba's backend
     */
    sceiba: "sceiba",
    /**
     * `cuor` represent the Cuor's backend, The Organizations System
     */
    cuor: "cuor",
};
export { AuthBackend };
/**
 * This service handles the behavior when a user authentications and
 * gives information about it.
 */
export class OauthAuthenticationService {
    /**
     * @param {?} oauthStorage
     * @param {?} http
     * @param {?} _router
     * @param {?} oauthService
     * @param {?} errorHandler
     * @param {?} moduleConfig
     */
    constructor(oauthStorage, http, _router, oauthService, errorHandler, moduleConfig) {
        this.oauthStorage = oauthStorage;
        this.http = http;
        this._router = _router;
        this.oauthService = oauthService;
        this.errorHandler = errorHandler;
        this.moduleConfig = moduleConfig;
        // TODO: this object is `any` because we have two backends with two difrent userprofiles...
        this.authenticationSubject = new Subject();
        /**
         * Observer to handles the behavior when a user authenticates
         */
        this.authenticationSubjectObservable = this.authenticationSubject.asObservable();
    }
    /**
     * notifies by an observable if the user is authenticated
     * for the knowledge of who uses it
     * @param {?} user
     * @return {?}
     */
    login(user) {
        console.log('autentication service user:', user);
        this.authenticationSubject.next(user);
    }
    /**
     * @return {?}
     */
    logout() {
        this.authenticationSubject.next(null);
    }
    /**
     * gives information about an user authenticated
     * @return {?}
     */
    getUserInfo() {
        return this.http.get(this.userInfoEndpoint);
        // if (this.authBackend == AuthBackend.sceiba) {
        //     return this.http.get<any>(this.env.sceibaApi + 'me');
        // } else if (this.authBackend == AuthBackend.cuor){
        //     return this.http.get<any>(this.env.cuorApi + 'me');
        // }
    }
    /**
     * @param {?} next
     * @param {?} state
     * @return {?}
     */
    canActivate(next, state) {
        /** @type {?} */
        const user = this.oauthStorage.getItem('user');
        if (user) {
            return true;
        }
        else {
            this._router.navigate(['/']);
            return false;
        }
    }
    /**
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    intercept(req, next) {
        /** @type {?} */
        let token = this.oauthStorage.getItem('access_token');
        if (token) {
            /** @type {?} */
            let headers = req.headers.set('Authorization', 'Bearer ' + token);
            if (req.method != 'GET') {
                headers = headers.set('Content-Type', 'application/json');
                headers = headers.set('Access-Control-Allow-Origin', '*');
            }
            req = req.clone({ headers });
        }
        return next.handle(req).pipe(catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => {
            /* 401 means the user is not authorized. */
            if (err.status === 401) {
                this.oauthService.initImplicitFlow();
                // this._router.navigateByUrl('/');
            }
            return throwError(err);
        })));
    }
    /**
     * Configure, this function is necessary if you will implement your own logic
     * @param {?} authConfig
     * @return {?}
     */
    configure(authConfig) {
        this.oauthService.configure(authConfig);
        this.oauthService.tokenValidationHandler = new JwksValidationHandler();
        this.oauthService.loadDiscoveryDocumentAndTryLogin();
    }
}
OauthAuthenticationService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
OauthAuthenticationService.ctorParameters = () => [
    { type: OAuthStorage },
    { type: HttpClient },
    { type: Router },
    { type: OAuthService },
    { type: OAuthResourceServerErrorHandler },
    { type: OAuthModuleConfig, decorators: [{ type: Optional }] }
];
/** @nocollapse */ OauthAuthenticationService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function OauthAuthenticationService_Factory() { return new OauthAuthenticationService(i0.ɵɵinject(i1.OAuthStorage), i0.ɵɵinject(i2.HttpClient), i0.ɵɵinject(i3.Router), i0.ɵɵinject(i1.OAuthService), i0.ɵɵinject(i1.OAuthResourceServerErrorHandler), i0.ɵɵinject(i1.OAuthModuleConfig, 8)); }, token: OauthAuthenticationService, providedIn: "root" });
if (false) {
    /** @type {?} */
    OauthAuthenticationService.prototype.userInfoEndpoint;
    /**
     * @type {?}
     * @private
     */
    OauthAuthenticationService.prototype.authenticationSubject;
    /**
     * Observer to handles the behavior when a user authenticates
     * @type {?}
     */
    OauthAuthenticationService.prototype.authenticationSubjectObservable;
    /**
     * @type {?}
     * @private
     */
    OauthAuthenticationService.prototype.oauthStorage;
    /**
     * @type {?}
     * @protected
     */
    OauthAuthenticationService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    OauthAuthenticationService.prototype._router;
    /**
     * @type {?}
     * @private
     */
    OauthAuthenticationService.prototype.oauthService;
    /**
     * @type {?}
     * @private
     */
    OauthAuthenticationService.prototype.errorHandler;
    /**
     * @type {?}
     * @private
     */
    OauthAuthenticationService.prototype.moduleConfig;
}
export class SimpleAuthenticationService {
    /**
     * @param {?} env
     * @param {?} http
     * @param {?} _router
     */
    constructor(env, http, _router) {
        this.env = env;
        this.http = http;
        this._router = _router;
        //implements CanActivate {
        this.authBackend = AuthBackend.sceiba;
        this.authenticationSubject = new Subject();
        /**
         * Observer to handles the behavior when a user authenticates
         */
        this.authenticationSubjectObservable = this.authenticationSubject.asObservable();
    }
    /**
     * notifies by an observable if the user is authenticated
     * for the knowledge of who uses it
     * @param {?} islogged 'true' is loggued or 'false' other way
     * @return {?}
     */
    logguedChange(islogged) {
        this.authenticationSubject.next(islogged);
    }
    /**
     * gives information about an user authenticated
     * @return {?}
     */
    getUserInfo() {
        if (this.authBackend == AuthBackend.sceiba) {
            return this.http.get(this.env.sceibaApi + 'me');
        }
        else if (this.authBackend == AuthBackend.cuor) {
            return this.http.get(this.env.cuorApi + 'me');
        }
    }
}
SimpleAuthenticationService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
SimpleAuthenticationService.ctorParameters = () => [
    { type: Environment },
    { type: HttpClient },
    { type: Router }
];
/** @nocollapse */ SimpleAuthenticationService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function SimpleAuthenticationService_Factory() { return new SimpleAuthenticationService(i0.ɵɵinject(i4.Environment), i0.ɵɵinject(i2.HttpClient), i0.ɵɵinject(i3.Router)); }, token: SimpleAuthenticationService, providedIn: "root" });
if (false) {
    /** @type {?} */
    SimpleAuthenticationService.prototype.authBackend;
    /**
     * @type {?}
     * @private
     */
    SimpleAuthenticationService.prototype.authenticationSubject;
    /**
     * Observer to handles the behavior when a user authenticates
     * @type {?}
     */
    SimpleAuthenticationService.prototype.authenticationSubjectObservable;
    /**
     * @type {?}
     * @private
     */
    SimpleAuthenticationService.prototype.env;
    /**
     * @type {?}
     * @protected
     */
    SimpleAuthenticationService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    SimpleAuthenticationService.prototype._router;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3RvY28tbGliLyIsInNvdXJjZXMiOlsibGliL2F1dGhlbnRpY2F0aW9uL2F1dGhlbnRpY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBS0EsT0FBTyxFQUFFLFVBQVUsRUFBMkUsTUFBTSxzQkFBc0IsQ0FBQztBQUMzSCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQXVDLE1BQU0sRUFBdUIsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRyxPQUFPLEVBQWMscUJBQXFCLEVBQUUsaUJBQWlCLEVBQUUsK0JBQStCLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hKLE9BQU8sRUFBYyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU1QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7Ozs7Ozs7QUFLakQsTUFBWSxXQUFXO0lBQ25COztPQUVHO0lBQ0gsTUFBTSxVQUFXO0lBQ2pCOztPQUVHO0lBQ0gsSUFBSSxRQUFTO0VBQ2hCOzs7Ozs7QUFRRCxNQUFNLE9BQU8sMEJBQTBCOzs7Ozs7Ozs7SUFLbkMsWUFFWSxZQUEwQixFQUN4QixJQUFnQixFQUNsQixPQUFlLEVBQ2YsWUFBMEIsRUFDMUIsWUFBNkMsRUFDakMsWUFBK0I7UUFMM0MsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDeEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNsQixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ2YsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsaUJBQVksR0FBWixZQUFZLENBQWlDO1FBQ2pDLGlCQUFZLEdBQVosWUFBWSxDQUFtQjs7UUFHL0MsMEJBQXFC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QUFnRTs7Ozs7SUFJaEUsc0VBQW1GOzs7OztJQVIvRSwwQ0FBd0I7Ozs7O0lBQ3hCLDJDQUEwQjs7Ozs7SUFDMUIsOENBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqICAgQ29weXJpZ2h0IChjKSAyMDIwIFVuaXZlcnNpZGFkIGRlIFBpbmFyIGRlbCBSw61vIFwiSGVybWFub3MgU2HDrXogTW9udGVzIGRlIE9jYVwiXG4gKiAgIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKi9cblxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEVycm9yUmVzcG9uc2UsIEh0dHBFdmVudCwgSHR0cEhhbmRsZXIsIEh0dHBJbnRlcmNlcHRvciwgSHR0cFJlcXVlc3QgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgQ2FuQWN0aXZhdGUsIFJvdXRlciwgUm91dGVyU3RhdGVTbmFwc2hvdCB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBBdXRoQ29uZmlnLCBKd2tzVmFsaWRhdGlvbkhhbmRsZXIsIE9BdXRoTW9kdWxlQ29uZmlnLCBPQXV0aFJlc291cmNlU2VydmVyRXJyb3JIYW5kbGVyLCBPQXV0aFNlcnZpY2UsIE9BdXRoU3RvcmFnZSB9IGZyb20gJ2FuZ3VsYXItb2F1dGgyLW9pZGMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFVzZXJQcm9maWxlIH0gZnJvbSAnLi4vLi4vcHVibGljLWFwaSc7XG5pbXBvcnQgeyBFbnZpcm9ubWVudCB9IGZyb20gJy4uL2NvcmUvcHVibGljLWFwaSc7XG5cbi8qKlxuICogVGhpcyBlbnVtIGhhbmRsZXMgdGhlIHNlbGVjdGVkIGJhY2tlbmRcbiAqL1xuZXhwb3J0IGVudW0gQXV0aEJhY2tlbmR7XG4gICAgLyoqXG4gICAgICogYHNjZWliYWAgcmVwcmVzZW50IHRoZSBTY2VpYmEncyBiYWNrZW5kXG4gICAgICovXG4gICAgc2NlaWJhID0gJ3NjZWliYScsXG4gICAgLyoqXG4gICAgICogYGN1b3JgIHJlcHJlc2VudCB0aGUgQ3VvcidzIGJhY2tlbmQsIFRoZSBPcmdhbml6YXRpb25zIFN5c3RlbVxuICAgICAqL1xuICAgIGN1b3IgPSAnY3Vvcidcbn1cbi8qKlxuICogVGhpcyBzZXJ2aWNlIGhhbmRsZXMgdGhlIGJlaGF2aW9yIHdoZW4gYSB1c2VyIGF1dGhlbnRpY2F0aW9ucyBhbmRcbiAqIGdpdmVzIGluZm9ybWF0aW9uIGFib3V0IGl0LlxuICovXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE9hdXRoQXV0aGVudGljYXRpb25TZXJ2aWNlIGltcGxlbWVudHMgQ2FuQWN0aXZhdGUsIEh0dHBJbnRlcmNlcHRvciB7XG5cbiAgICAvLyBwdWJsaWMgYXV0aEJhY2tlbmQ6IEF1dGhCYWNrZW5kID0gIEF1dGhCYWNrZW5kLnNjZWliYVxuICAgIHB1YmxpYyB1c2VySW5mb0VuZHBvaW50OiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgLy8gcHJpdmF0ZSBlbnY6IEVudmlyb25tZW50LFxuICAgICAgICBwcml2YXRlIG9hdXRoU3RvcmFnZTogT0F1dGhTdG9yYWdlLFxuICAgICAgICBwcm90ZWN0ZWQgaHR0cDogSHR0cENsaWVudCxcbiAgICAgICAgcHJpdmF0ZSBfcm91dGVyOiBSb3V0ZXIsXG4gICAgICAgIHByaXZhdGUgb2F1dGhTZXJ2aWNlOiBPQXV0aFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZXJyb3JIYW5kbGVyOiBPQXV0aFJlc291cmNlU2VydmVyRXJyb3JIYW5kbGVyLFxuICAgICAgICBAT3B0aW9uYWwoKSBwcml2YXRlIG1vZHVsZUNvbmZpZzogT0F1dGhNb2R1bGVDb25maWcpIHsgfVxuXG4gICAgLy8gVE9ETzogdGhpcyBvYmplY3QgaXMgYGFueWAgYmVjYXVzZSB3ZSBoYXZlIHR3byBiYWNrZW5kcyB3aXRoIHR3byBkaWZyZW50IHVzZXJwcm9maWxlcy4uLlxuICAgIHByaXZhdGUgYXV0aGVudGljYXRpb25TdWJqZWN0OiBTdWJqZWN0PGFueT4gPSBuZXcgU3ViamVjdCgpO1xuICAgIC8qKlxuICAgICAqIE9ic2VydmVyIHRvIGhhbmRsZXMgdGhlIGJlaGF2aW9yIHdoZW4gYSB1c2VyIGF1dGhlbnRpY2F0ZXNcbiAgICAgKi9cbiAgICBwdWJsaWMgYXV0aGVudGljYXRpb25TdWJqZWN0T2JzZXJ2YWJsZSA9IHRoaXMuYXV0aGVudGljYXRpb25TdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuXG4gICAgLyoqXG4gICAgICogbm90aWZpZXMgYnkgYW4gb2JzZXJ2YWJsZSBpZiB0aGUgdXNlciBpcyBhdXRoZW50aWNhdGVkXG4gICAgICogZm9yIHRoZSBrbm93bGVkZ2Ugb2Ygd2hvIHVzZXMgaXRcbiAgICAgKiBAcGFyYW0gaXNsb2dnZWQgJ3RydWUnIGlzIGxvZ2d1ZWQgb3IgJ2ZhbHNlJyBvdGhlciB3YXlcbiAgICAgKi9cbiAgICBsb2dpbih1c2VyKSB7XG4gICAgICBjb25zb2xlLmxvZygnYXV0ZW50aWNhdGlvbiBzZXJ2aWNlIHVzZXI6JywgdXNlcilcbiAgICAgIHRoaXMuYXV0aGVudGljYXRpb25TdWJqZWN0Lm5leHQodXNlcik7XG4gICAgfVxuICAgIGxvZ291dCgpIHtcbiAgICAgIHRoaXMuYXV0aGVudGljYXRpb25TdWJqZWN0Lm5leHQobnVsbCk7XG4gIH1cbiAgICAvKipcbiAgICAgKiBnaXZlcyBpbmZvcm1hdGlvbiBhYm91dCBhbiB1c2VyIGF1dGhlbnRpY2F0ZWRcbiAgICAgKi9cbiAgICBnZXRVc2VySW5mbygpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQ8YW55Pih0aGlzLnVzZXJJbmZvRW5kcG9pbnQpO1xuICAgICAgICAvLyBpZiAodGhpcy5hdXRoQmFja2VuZCA9PSBBdXRoQmFja2VuZC5zY2VpYmEpIHtcbiAgICAgICAgLy8gICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PGFueT4odGhpcy5lbnYuc2NlaWJhQXBpICsgJ21lJyk7XG4gICAgICAgIC8vIH0gZWxzZSBpZiAodGhpcy5hdXRoQmFja2VuZCA9PSBBdXRoQmFja2VuZC5jdW9yKXtcbiAgICAgICAgLy8gICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PGFueT4odGhpcy5lbnYuY3VvckFwaSArICdtZScpO1xuICAgICAgICAvLyB9XG4gICAgfVxuXG4gICAgY2FuQWN0aXZhdGUobmV4dDogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3QpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHwgUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCB1c2VyID0gdGhpcy5vYXV0aFN0b3JhZ2UuZ2V0SXRlbSgndXNlcicpXG5cbiAgICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2V7XG4gICAgICAgICAgICB0aGlzLl9yb3V0ZXIubmF2aWdhdGUoWycvJ10pO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICB9XG5cblxuICAgIHB1YmxpYyBpbnRlcmNlcHQocmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcblxuICAgICAgICBsZXQgdG9rZW4gPSB0aGlzLm9hdXRoU3RvcmFnZS5nZXRJdGVtKCdhY2Nlc3NfdG9rZW4nKTtcblxuICAgICAgICBpZiAodG9rZW4pIHtcbiAgICAgICAgICAgIGxldCBoZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdBdXRob3JpemF0aW9uJywgJ0JlYXJlciAnICsgdG9rZW4pO1xuXG4gICAgICAgICAgICBpZiAocmVxLm1ldGhvZCAhPSAnR0VUJyl7XG4gICAgICAgICAgICAgICAgaGVhZGVycyA9IGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgICAgICAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLnNldCgnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVxID0gcmVxLmNsb25lKHsgaGVhZGVycyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpLnBpcGUoXG4gICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvKiA0MDEgbWVhbnMgdGhlIHVzZXIgaXMgbm90IGF1dGhvcml6ZWQuICovXG4gICAgICAgICAgICAgICAgaWYgKGVyci5zdGF0dXMgPT09IDQwMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9hdXRoU2VydmljZS5pbml0SW1wbGljaXRGbG93KCk7XG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuX3JvdXRlci5uYXZpZ2F0ZUJ5VXJsKCcvJyk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29uZmlndXJlLCB0aGlzIGZ1bmN0aW9uIGlzIG5lY2Vzc2FyeSBpZiB5b3Ugd2lsbCBpbXBsZW1lbnQgeW91ciBvd24gbG9naWNcbiAgICAgKiBAcGFyYW0gYXV0aENvbmZpZzogaXMgdGhlIGF1dGggY29uZmlndXJhdGlvbi5cbiAgICAgKiB5b3UgaGF2ZSB0byBjYWxsIGBvYXV0aFNlcnZpY2UuaW5pdEltcGxpY2l0RmxvdygpYCBpbiB5b3UgbG9naW4gZnVuY3Rpb25cbiAgICAgKiBhbmQgYG9hdXRoU2VydmljZS5sb2dPdXQoKWAgaW4geW91IGxvZ291dCBmdW5jdGlvblxuICAgICAqL1xuICAgIHB1YmxpYyBjb25maWd1cmUoYXV0aENvbmZpZzogQXV0aENvbmZpZyk6IHZvaWQge1xuICAgICAgICB0aGlzLm9hdXRoU2VydmljZS5jb25maWd1cmUoYXV0aENvbmZpZyk7XG4gICAgICAgIHRoaXMub2F1dGhTZXJ2aWNlLnRva2VuVmFsaWRhdGlvbkhhbmRsZXIgPSBuZXcgSndrc1ZhbGlkYXRpb25IYW5kbGVyKCk7XG4gICAgICAgIHRoaXMub2F1dGhTZXJ2aWNlLmxvYWREaXNjb3ZlcnlEb2N1bWVudEFuZFRyeUxvZ2luKCk7XG4gICAgfVxufVxuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFNpbXBsZUF1dGhlbnRpY2F0aW9uU2VydmljZSB7IC8vaW1wbGVtZW50cyBDYW5BY3RpdmF0ZSB7XG5cbiAgcHVibGljIGF1dGhCYWNrZW5kOiBBdXRoQmFja2VuZCA9ICBBdXRoQmFja2VuZC5zY2VpYmFcblxuICBjb25zdHJ1Y3RvcihcbiAgICAgIHByaXZhdGUgZW52OiBFbnZpcm9ubWVudCxcbiAgICAgIHByb3RlY3RlZCBodHRwOiBIdHRwQ2xpZW50LFxuICAgICAgcHJpdmF0ZSBfcm91dGVyOiBSb3V0ZXIpIHsgfVxuXG4gIHByaXZhdGUgYXV0aGVudGljYXRpb25TdWJqZWN0OiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3QoKTtcbiAgLyoqXG4gICAqIE9ic2VydmVyIHRvIGhhbmRsZXMgdGhlIGJlaGF2aW9yIHdoZW4gYSB1c2VyIGF1dGhlbnRpY2F0ZXNcbiAgICovXG4gIHB1YmxpYyBhdXRoZW50aWNhdGlvblN1YmplY3RPYnNlcnZhYmxlID0gdGhpcy5hdXRoZW50aWNhdGlvblN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG5cbiAgLyoqXG4gICAqIG5vdGlmaWVzIGJ5IGFuIG9ic2VydmFibGUgaWYgdGhlIHVzZXIgaXMgYXV0aGVudGljYXRlZFxuICAgKiBmb3IgdGhlIGtub3dsZWRnZSBvZiB3aG8gdXNlcyBpdFxuICAgKiBAcGFyYW0gaXNsb2dnZWQgJ3RydWUnIGlzIGxvZ2d1ZWQgb3IgJ2ZhbHNlJyBvdGhlciB3YXlcbiAgICovXG4gIGxvZ2d1ZWRDaGFuZ2UoaXNsb2dnZWQ6IGJvb2xlYW4pIHtcbiAgICAgIHRoaXMuYXV0aGVudGljYXRpb25TdWJqZWN0Lm5leHQoaXNsb2dnZWQpO1xuICB9XG4gIC8qKlxuICAgKiBnaXZlcyBpbmZvcm1hdGlvbiBhYm91dCBhbiB1c2VyIGF1dGhlbnRpY2F0ZWRcbiAgICovXG4gIGdldFVzZXJJbmZvKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICBpZiAodGhpcy5hdXRoQmFja2VuZCA9PSBBdXRoQmFja2VuZC5zY2VpYmEpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldDxhbnk+KHRoaXMuZW52LnNjZWliYUFwaSArICdtZScpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmF1dGhCYWNrZW5kID09IEF1dGhCYWNrZW5kLmN1b3Ipe1xuICAgICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PGFueT4odGhpcy5lbnYuY3VvckFwaSArICdtZScpO1xuICAgICAgfVxuICB9XG5cbiAgLy8gY2FuQWN0aXZhdGUobmV4dDogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3QpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHwgUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4ge1xuICAvLyAgIGlmKHRoaXMuZW52LnVzZXIgIT0gbnVsbCl7XG4gIC8vICAgICByZXR1cm4gdHJ1ZTtcbiAgLy8gICB9XG4gIC8vICAgZWxzZXtcbiAgLy8gICAgICAgdGhpcy5fcm91dGVyLm5hdmlnYXRlKFsnLyddKTtcbiAgLy8gICAgICAgcmV0dXJuIGZhbHNlO1xuICAvLyAgIH1cblxuICAvLyB9XG59XG4iXX0=