/**
 * @fileoverview added by tsickle
 * Generated from: lib/authentication/authentication.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input } from "@angular/core";
import { Router } from "@angular/router";
import { timer } from "rxjs";
import { TranslateService } from "@ngx-translate/core";
import { JwksValidationHandler, OAuthService, OAuthStorage } from "angular-oauth2-oidc";
import { Environment } from "../core/env";
import { UserProfileService } from "../backend/user-profile.service";
import { UserProfile } from "../entities/person.entity";
import { OauthAuthenticationService } from "./authentication.service";
/**
 * @record
 */
export function OauthInfo() { }
if (false) {
    /** @type {?} */
    OauthInfo.prototype.serverHost;
    /** @type {?} */
    OauthInfo.prototype.loginUrl;
    /** @type {?} */
    OauthInfo.prototype.tokenEndpoint;
    /** @type {?} */
    OauthInfo.prototype.userInfoEndpoint;
    /** @type {?} */
    OauthInfo.prototype.appHost;
    /** @type {?} */
    OauthInfo.prototype.appName;
    /** @type {?} */
    OauthInfo.prototype.oauthRedirectUri;
    /** @type {?} */
    OauthInfo.prototype.oauthClientId;
    /** @type {?} */
    OauthInfo.prototype.oauthScope;
}
/**
 * Represents a component used to authenticate.
 *
 * In order to use this component with the correct i18n, you must include
 * (in your i18n translate files that are in the folder `assets\i18n`)
 * a translation key of name "TOCO_AUTHENTICATION" that contains
 * an object as value with the translation needed by this component.
 *
 * In the case of `es.json` file, you must include the following translation key:
 * "TOCO_AUTHENTICATION": {
 * "MAT_CARD_TITLE_AUTH": "AutenticaciÃ³n con",
 * "AUTENTICARSE": "Autenticarse",
 * "H1_HOLA": "Hola",
 * "BUTTON_SALIR": "Salir"
 * }
 *
 * In the case of `en.json` file, you must include the following translation key:
 * "TOCO_AUTHENTICATION": {
 * "MAT_CARD_TITLE_AUTH": "Authentication with",
 * "AUTENTICARSE": "Log in",
 * "H1_HOLA": "Hello,",
 * "BUTTON_SALIR": "Exit"
 * }
 *
 * If you have another language, then you have another `*.json` file,
 * and you must include the "TOCO_AUTHENTICATION" translation key with the correct translation values.
 */
export class AuthenticationComponent {
    /**
     * @param {?} userProfileService
     * @param {?} env
     * @param {?} router
     * @param {?} oauthService
     * @param {?} oauthStorage
     * @param {?} authenticationService
     * @param {?} _transServ
     */
    constructor(userProfileService, env, router, oauthService, oauthStorage, authenticationService, _transServ) {
        this.userProfileService = userProfileService;
        this.env = env;
        this.router = router;
        this.oauthService = oauthService;
        this.oauthStorage = oauthStorage;
        this.authenticationService = authenticationService;
        this._transServ = _transServ;
        this.timerAuthenticateSuscription = null;
        this.timerAuthenticateObserver = {
            next: (/**
             * @param {?} _
             * @return {?}
             */
            (_) => {
                // console.log('next');
                // this.oauthService.setupAutomaticSilentRefresh();
                if (this.oauthStorage.getItem("access_token")) {
                    this.authenticationService.getUserInfo().subscribe((/**
                     * @param {?} response
                     * @return {?}
                     */
                    (response) => {
                        this.oauthStorage.setItem("user", JSON.stringify(response));
                        this.authenticationService.login(response);
                    }), (/**
                     * @param {?} error
                     * @return {?}
                     */
                    error => console.log(error)), (/**
                     * @return {?}
                     */
                    () => { }));
                    // this.authenticationService.logguedChange(true);
                }
            }),
            error: (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                console.log("The observable got an error notification: " + err + ".");
            }),
            complete: (/**
             * @return {?}
             */
            () => {
                console.log("The observable got a complete notification.");
            }),
        };
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.isButtonLogin == undefined)
            this.isButtonLogin = false;
        if (this.isButtonLoginIcon == undefined)
            this.isButtonLoginIcon = false;
        if (this.isButtonLoginText == undefined) {
            this._transServ.get('TOCO_AUTHENTICATION.AUTENTICARSE').subscribe((/**
             * @param {?} res
             * @return {?}
             */
            (res) => {
                this.isButtonLoginText = res;
            }));
        }
        if (this.oauthInfo.loginUrl == undefined || this.oauthInfo.loginUrl == '') {
            this.oauthInfo.loginUrl = this.oauthInfo.serverHost + "oauth/authorize";
        }
        if (this.oauthInfo.tokenEndpoint == undefined || this.oauthInfo.tokenEndpoint == '') {
            this.oauthInfo.tokenEndpoint = this.oauthInfo.serverHost + "oauth/token";
        }
        this.configure();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.timerAuthenticateSuscription) {
            this.timerAuthenticateSuscription.unsubscribe();
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        // this observable is to wait a while for the component to finish loading,
        // because otherwise it fails to notify that the user is authenticated
        this.timerAuthenticateSuscription = timer(0).subscribe(this.timerAuthenticateObserver);
    }
    /**
     * Configurations to authenticate
     * @private
     * @return {?}
     */
    configure() {
        /** @type {?} */
        const authConfig = {
            // Url of the Identity Provider
            //issuer: 'https://sceiba-lab.upr.edu.cu',
            loginUrl: this.oauthInfo.loginUrl,
            tokenEndpoint: this.oauthInfo.tokenEndpoint,
            // URL of the SPA to redirect the user to after login
            redirectUri: this.oauthInfo.oauthRedirectUri,
            // The SPA's id. The SPA is registered with this id at the auth-server
            clientId: this.oauthInfo.oauthClientId,
            oidc: false,
            // silentRefreshRedirectUri: this.oauthInfo.sceibaHost + 'oauth/token',
            // timeoutFactor: 0.75,
            sessionChecksEnabled: true,
            // set the scope for the permissions the client should request
            // The first three are defined by OIDC. The 4th is a usecase-specific one
            scope: this.oauthInfo.oauthScope,
        };
        this.oauthService.configure(authConfig);
        // Store user session in storage
        // this.oauthService.setStorage(this.oauthStorage);
        this.oauthService.tokenValidationHandler = new JwksValidationHandler();
        // Try to login and if a token was received, request user information
        this.oauthService.tryLogin({
            onTokenReceived: (/**
             * @param {?} _
             * @return {?}
             */
            (_) => {
                // gives information about user loggued
                this.authenticationService.userInfoEndpoint = this.oauthInfo.userInfoEndpoint;
                this.authenticationService.getUserInfo().subscribe((/**
                 * @param {?} response
                 * @return {?}
                 */
                (response) => {
                    console.log(response);
                    this.oauthStorage.setItem("user", JSON.stringify(response));
                    this.authenticationService.login(response);
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                error => console.log(error)), (/**
                 * @return {?}
                 */
                () => { }));
            }),
            onLoginError: (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                console.log("error in login", err);
            }),
        });
    }
    /**
     * Starts the login flow
     * @return {?}
     */
    login() {
        this.oauthService.initImplicitFlow();
        // this.authenticationService.authBackend = this.authBackend
        // TODO: por que esto aqui, este modulo solo se encarga de la autenticacion y dar la informacion basica del usuario,
        // el perfil es manejado por otro componente
        this.user = new UserProfile();
        this.userProfileService.getUserInfo().subscribe({
            next: (/**
             * @param {?} response
             * @return {?}
             */
            (response) => {
                if (response && response.data && response.data.userprofile) {
                    this.user.deepcopy(response.data.userprofile);
                    this.oauthStorage.setItem("user", this.user.entitystringify());
                }
            }),
            error: (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                console.log(err);
            }),
            complete: (/**
             * @return {?}
             */
            () => { }),
        });
    }
    /**
     * Ends the login flow
     * @return {?}
     */
    logoff() {
        this.oauthService.logOut();
        this.authenticationService.logout();
    }
    /**
     * Gives the user's email if the user is authenticated
     * @return {?}
     */
    get name() {
        if (this.oauthStorage.getItem("access_token")) {
            return this.oauthStorage.getItem("email");
        }
        else {
            return null;
        }
    }
}
AuthenticationComponent.decorators = [
    { type: Component, args: [{
                selector: "toco-authentication",
                template: "\n<div *ngIf=\"!isButtonLogin;else template_buttonLogin\" fxLayoutAlign=\"center center\" fxLayout=\"row\">\n    <mat-card fxLayoutAlign=\"center center\" fxLayout=\"column\">\n\n        <mat-card-header>\n            <mat-card-title *ngIf=\"!userName\">{{ 'TOCO_AUTHENTICATION.MAT_CARD_TITLE_AUTH' | translate }}</mat-card-title>\n        </mat-card-header>\n\n        <mat-card-content fxLayoutAlign=\"center center\" fxLayout=\"column\">\n            <button *ngIf=\"!userName;else templateName\" mat-raised-button color=\"primary\" style=\"width: 12em\" (click)=\"login()\">\n                <img src=\"https://sceiba-lab.upr.edu.cu/static/images/sceiba-logo-white.png\" alt=\"Sceiba\" width=\"100\" style=\"padding-top: .9em; padding-bottom: .9em\">\n            </button>\n\n            <ng-template #templateName>\n                <h1>{{ 'TOCO_AUTHENTICATION.H1_HOLA' | translate }} {{ userName }}</h1>\n                <button mat-raised-button color=\"primary\" style=\"width: 12em\" (click)=\"logoff()\">\n                    {{ 'TOCO_AUTHENTICATION.BUTTON_SALIR' | translate }}\n                </button>\n            </ng-template>\n\n        </mat-card-content>\n    </mat-card>\n</div>\n\n<ng-template #template_buttonLogin>\n    <button *ngIf=\"isButtonLoginIcon\" mat-icon-button (click)=\"login()\" matTooltip=\"{{ isButtonLoginText }}\">\n        <mat-icon>lock_open</mat-icon>\n    </button>\n    <button *ngIf=\"!isButtonLoginIcon\" mat-raised-button color=\"primary\" (click)=\"login()\">\n        {{ isButtonLoginText }}\n        <mat-icon class=\"mat-18\">lock_open</mat-icon>\n    </button>\n</ng-template>\n",
                styles: [".card-width{width:25%;min-width:15em}"]
            }] }
];
/** @nocollapse */
AuthenticationComponent.ctorParameters = () => [
    { type: UserProfileService },
    { type: Environment },
    { type: Router },
    { type: OAuthService },
    { type: OAuthStorage },
    { type: OauthAuthenticationService },
    { type: TranslateService }
];
AuthenticationComponent.propDecorators = {
    isButtonLogin: [{ type: Input }],
    isButtonLoginIcon: [{ type: Input }],
    isButtonLoginText: [{ type: Input }],
    oauthInfo: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    AuthenticationComponent.prototype.isButtonLogin;
    /** @type {?} */
    AuthenticationComponent.prototype.isButtonLoginIcon;
    /** @type {?} */
    AuthenticationComponent.prototype.isButtonLoginText;
    /** @type {?} */
    AuthenticationComponent.prototype.oauthInfo;
    /** @type {?} */
    AuthenticationComponent.prototype.user;
    /** @type {?} */
    AuthenticationComponent.prototype.userName;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.timerAuthenticateSuscription;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.timerAuthenticateObserver;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.userProfileService;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.env;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.router;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.oauthService;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.oauthStorage;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.authenticationService;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype._transServ;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRpb24uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vdG9jby1saWIvIiwic291cmNlcyI6WyJsaWIvYXV0aGVudGljYXRpb24vYXV0aGVudGljYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFpQixTQUFTLEVBQUUsS0FBSyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQWlDLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQWMscUJBQXFCLEVBQUUsWUFBWSxFQUFDLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRW5HLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDckUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3hELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7O0FBR3RFLCtCQVdDOzs7SUFUQywrQkFBbUI7O0lBQ25CLDZCQUFpQjs7SUFDakIsa0NBQXNCOztJQUN0QixxQ0FBeUI7O0lBQ3pCLDRCQUFnQjs7SUFDaEIsNEJBQWdCOztJQUNoQixxQ0FBeUI7O0lBQ3pCLGtDQUFzQjs7SUFDdEIsK0JBQW1COzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW1DckIsTUFBTSxPQUFPLHVCQUF1Qjs7Ozs7Ozs7OztJQTRDbEMsWUFDVSxrQkFBc0MsRUFDdEMsR0FBZ0IsRUFDaEIsTUFBYyxFQUNkLFlBQTBCLEVBQzFCLFlBQTBCLEVBQzFCLHFCQUFpRCxFQUNqRCxVQUE0QjtRQU41Qix1QkFBa0IsR0FBbEIs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LENBQUMsQ0FBQztZQUNuQixDQUFDLENBQUE7WUFDRCxRQUFROzs7WUFBRSxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUE7U0FDbkIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7Ozs7SUFLTSxNQUFNO1FBQ1gsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUMzQixJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDdEMsQ0FBQzs7Ozs7SUFLRCxJQUFXLElBQUk7UUFDYixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxFQUFFO1lBQzdDLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDM0M7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDO1NBQ2I7SUFDSCxDQUFDOzs7WUFsTkYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxxQkFBcUI7Z0JBQy9CLDRtREFBOEM7O2FBRS9DOzs7O1lBakRRLGtCQUFrQjtZQURsQixXQUFXO1lBTFgsTUFBTTtZQUc2QixZQUFZO1lBQUMsWUFBWTtZQUs1RCwwQkFBMEI7WUFOMUIsZ0JBQWdCOzs7NEJBd0R0QixLQUFLO2dDQUdMLEtBQUs7Z0NBR0wsS0FBSzt3QkFHTCxLQUFLOzs7O0lBVE4sZ0RBQzhCOztJQUU5QixvREFDa0M7O0lBRWxDLG9EQUNpQzs7SUFFakMsNENBQzRCOztJQUU1Qix1Q0FBeUI7O0lBRXpCLDJDQUF3Qjs7Ozs7SUFDeEIsK0RBQTBEOzs7OztJQUMxRCw0REF3QkU7Ozs7O0lBR0EscURBQThDOzs7OztJQUM5QyxzQ0FBd0I7Ozs7O0lBQ3hCLHlDQUFzQjs7Ozs7SUFDdEIsK0NBQWtDOzs7OztJQUNsQywrQ0FBa0M7Ozs7O0lBQ2xDLHdEQUF5RDs7Ozs7SUFDekQsNkNBQW9DIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnQsIElucHV0LCBPbkluaXQgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSBcIkBhbmd1bGFyL3JvdXRlclwiO1xuaW1wb3J0IHsgUGFydGlhbE9ic2VydmVyLCBTdWJzY3JpcHRpb24sIHRpbWVyIH0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tIFwiQG5neC10cmFuc2xhdGUvY29yZVwiO1xuaW1wb3J0IHsgQXV0aENvbmZpZywgSndrc1ZhbGlkYXRpb25IYW5kbGVyLCBPQXV0aFNlcnZpY2UsT0F1dGhTdG9yYWdlIH0gZnJvbSBcImFuZ3VsYXItb2F1dGgyLW9pZGNcIjtcblxuaW1wb3J0IHsgRW52aXJvbm1lbnQgfSBmcm9tIFwiLi4vY29yZS9lbnZcIjtcbmltcG9ydCB7IFVzZXJQcm9maWxlU2VydmljZSB9IGZyb20gXCIuLi9iYWNrZW5kL3VzZXItcHJvZmlsZS5zZXJ2aWNlXCI7XG5pbXBvcnQgeyBVc2VyUHJvZmlsZSB9IGZyb20gXCIuLi9lbnRpdGllcy9wZXJzb24uZW50aXR5XCI7XG5pbXBvcnQgeyBPYXV0aEF1dGhlbnRpY2F0aW9uU2VydmljZSB9IGZyb20gXCIuL2F1dGhlbnRpY2F0aW9uLnNlcnZpY2VcIjtcbi8vIGltcG9ydCB7IGF1dGhDb25maWcgfSBmcm9tICcuL2F1dGgtY29uZmlnJztcblxuZXhwb3J0IGludGVyZmFjZSBPYXV0aEluZm9cbntcbiAgc2VydmVySG9zdDogc3RyaW5nO1xuICBsb2dpblVybDogc3RyaW5nO1xuICB0b2tlbkVuZHBvaW50OiBzdHJpbmc7XG4gIHVzZXJJbmZvRW5kcG9pbnQ6IHN0cmluZyxcbiAgYXBwSG9zdDogc3RyaW5nO1xuICBhcHBOYW1lOiBzdHJpbmc7XG4gIG9hdXRoUmVkaXJlY3RVcmk6IHN0cmluZztcbiAgb2F1dGhDbGllbnRJZDogc3RyaW5nO1xuICBvYXV0aFNjb3BlOiBzdHJpbmc7XG59XG5cbi8qKlxuICogUmVwcmVzZW50cyBhIGNvbXBvbmVudCB1c2VkIHRvIGF1dGhlbnRpY2F0ZS4gXG4gKiBcbiAqIEluIG9yZGVyIHRvIHVzZSB0aGlzIGNvbXBvbmVudCB3aXRoIHRoZSBjb3JyZWN0IGkxOG4sIHlvdSBtdXN0IGluY2x1ZGUgXG4gKiAoaW4geW91ciBpMThuIHRyYW5zbGF0ZSBmaWxlcyB0aGF0IGFyZSBpbiB0aGUgZm9sZGVyIGBhc3NldHNcXGkxOG5gKSBcbiAqIGEgdHJhbnNsYXRpb24ga2V5IG9mIG5hbWUgXCJUT0NPX0FVVEhFTlRJQ0FUSU9OXCIgdGhhdCBjb250YWlucyBcbiAqIGFuIG9iamVjdCBhcyB2YWx1ZSB3aXRoIHRoZSB0cmFuc2xhdGlvbiBuZWVkZWQgYnkgdGhpcyBjb21wb25lbnQuIFxuICogXG4gKiBJbiB0aGUgY2FzZSBvZiBgZXMuanNvbmAgZmlsZSwgeW91IG11c3QgaW5jbHVkZSB0aGUgZm9sbG93aW5nIHRyYW5zbGF0aW9uIGtleTogXG4gICAgXCJUT0NPX0FVVEhFTlRJQ0FUSU9OXCI6IHtcbiAgICAgICAgXCJNQVRfQ0FSRF9USVRMRV9BVVRIXCI6IFwiQXV0ZW50aWNhY2nDs24gY29uXCIsXG4gICAgICAgIFwiQVVURU5USUNBUlNFXCI6IFwiQXV0ZW50aWNhcnNlXCIsXG4gICAgICAgIFwiSDFfSE9MQVwiOiBcIkhvbGFcIixcbiAgICAgICAgXCJCVVRUT05fU0FMSVJcIjogXCJTYWxpclwiXG4gICAgfVxuICogXG4gKiBJbiB0aGUgY2FzZSBvZiBgZW4uanNvbmAgZmlsZSwgeW91IG11c3QgaW5jbHVkZSB0aGUgZm9sbG93aW5nIHRyYW5zbGF0aW9uIGtleTogXG4gICAgXCJUT0NPX0FVVEhFTlRJQ0FUSU9OXCI6IHtcbiAgICAgICAgXCJNQVRfQ0FSRF9USVRMRV9BVVRIXCI6IFwiQXV0aGVudGljYXRpb24gd2l0aFwiLFxuICAgICAgICBcIkFVVEVOVElDQVJTRVwiOiBcIkxvZyBpblwiLFxuICAgICAgICBcIkgxX0hPTEFcIjogXCJIZWxsbyxcIixcbiAgICAgICAgXCJCVVRUT05fU0FMSVJcIjogXCJFeGl0XCJcbiAgICB9XG4gKiBcbiAqIElmIHlvdSBoYXZlIGFub3RoZXIgbGFuZ3VhZ2UsIHRoZW4geW91IGhhdmUgYW5vdGhlciBgKi5qc29uYCBmaWxlLCBcbiAqIGFuZCB5b3UgbXVzdCBpbmNsdWRlIHRoZSBcIlRPQ09fQVVUSEVOVElDQVRJT05cIiB0cmFuc2xhdGlvbiBrZXkgd2l0aCB0aGUgY29ycmVjdCB0cmFuc2xhdGlvbiB2YWx1ZXMuIFxuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6IFwidG9jby1hdXRoZW50aWNhdGlvblwiLFxuICB0ZW1wbGF0ZVVybDogXCIuL2F1dGhlbnRpY2F0aW9uLmNvbXBvbmVudC5odG1sXCIsXG4gIHN0eWxlVXJsczogW1wiLi9hdXRoZW50aWNhdGlvbi5jb21wb25lbnQuc2Nzc1wiXSxcbn0pXG5leHBvcnQgY2xhc3MgQXV0aGVudGljYXRpb25Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQge1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBpc0J1dHRvbkxvZ2luOiBib29sZWFuO1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBpc0J1dHRvbkxvZ2luSWNvbjogYm9vbGVhbjtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgaXNCdXR0b25Mb2dpblRleHQ6IHN0cmluZztcblxuICBASW5wdXQoKVxuICBwdWJsaWMgb2F1dGhJbmZvOiBPYXV0aEluZm87XG5cbiAgcHVibGljIHVzZXI6IFVzZXJQcm9maWxlO1xuXG4gIHB1YmxpYyB1c2VyTmFtZTogc3RyaW5nO1xuICBwcml2YXRlIHRpbWVyQXV0aGVudGljYXRlU3VzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IG51bGw7XG4gIHByaXZhdGUgdGltZXJBdXRoZW50aWNhdGVPYnNlcnZlcjogUGFydGlhbE9ic2VydmVyPG51bWJlcj4gPSB7XG4gICAgbmV4dDogKF8pID0+IHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKCduZXh0Jyk7XG4gICAgICAvLyB0aGlzLm9hdXRoU2VydmljZS5zZXR1cEF1dG9tYXRpY1NpbGVudFJlZnJlc2goKTtcbiAgICAgIGlmICh0aGlzLm9hdXRoU3RvcmFnZS5nZXRJdGVtKFwiYWNjZXNzX3Rva2VuXCIpKSB7XG4gICAgICAgIHRoaXMuYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldFVzZXJJbmZvKCkuc3Vic2NyaWJlKFxuICAgICAgICAgIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vYXV0aFN0b3JhZ2Uuc2V0SXRlbShcInVzZXJcIiwgSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICAgICAgICAgIHRoaXMuYXV0aGVudGljYXRpb25TZXJ2aWNlLmxvZ2luKHJlc3BvbnNlKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVycm9yID0+IGNvbnNvbGUubG9nKGVycm9yKSxcbiAgICAgICAgICAoKSA9PiB7fVxuICAgICAgICApXG4gICAgICAgIC8vIHRoaXMuYXV0aGVudGljYXRpb25TZXJ2aWNlLmxvZ2d1ZWRDaGFuZ2UodHJ1ZSk7XG4gICAgICB9XG4gICAgfSxcblxuICAgIGVycm9yOiAoZXJyOiBhbnkpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFwiVGhlIG9ic2VydmFibGUgZ290IGFuIGVycm9yIG5vdGlmaWNhdGlvbjogXCIgKyBlcnIgKyBcIi5cIik7XG4gICAgfSxcblxuICAgIGNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhcIlRoZSBvYnNlcnZhYmxlIGdvdCBhIGNvbXBsZXRlIG5vdGlmaWNhdGlvbi5cIik7XG4gICAgfSxcbiAgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHVzZXJQcm9maWxlU2VydmljZTogVXNlclByb2ZpbGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgZW52OiBFbnZpcm9ubWVudCxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgb2F1dGhTZXJ2aWNlOiBPQXV0aFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBvYXV0aFN0b3JhZ2U6IE9BdXRoU3RvcmFnZSxcbiAgICBwcml2YXRlIGF1dGhlbnRpY2F0aW9uU2VydmljZTogT2F1dGhBdXRoZW50aWNhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBfdHJhbnNTZXJ2OiBUcmFuc2xhdGVTZXJ2aWNlXG4gIClcbiAgeyB9XG5cbiAgbmdPbkluaXQoKVxuICB7XG4gICAgaWYgKHRoaXMuaXNCdXR0b25Mb2dpbiA9PSB1bmRlZmluZWQpIHRoaXMuaXNCdXR0b25Mb2dpbiA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmlzQnV0dG9uTG9naW5JY29uID09IHVuZGVmaW5lZCkgdGhpcy5pc0J1dHRvbkxvZ2luSWNvbiA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmlzQnV0dG9uTG9naW5UZXh0ID09IHVuZGVmaW5lZClcbiAgICB7XG4gICAgICB0aGlzLl90cmFuc1NlcnYuZ2V0KCdUT0NPX0FVVEhFTlRJQ0FUSU9OLkFVVEVOVElDQVJTRScpLnN1YnNjcmliZSgocmVzOiBzdHJpbmcpID0+IHtcbiAgICAgICAgdGhpcy5pc0J1dHRvbkxvZ2luVGV4dCA9IHJlcztcbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAodGhpcy5vYXV0aEluZm8ubG9naW5VcmwgPT0gdW5kZWZpbmVkIHx8IHRoaXMub2F1dGhJbmZvLmxvZ2luVXJsID09ICcnKXtcbiAgICAgIHRoaXMub2F1dGhJbmZvLmxvZ2luVXJsID0gdGhpcy5vYXV0aEluZm8uc2VydmVySG9zdCArIFwib2F1dGgvYXV0aG9yaXplXCI7XG4gICAgfVxuICAgIGlmICh0aGlzLm9hdXRoSW5mby50b2tlbkVuZHBvaW50ID09IHVuZGVmaW5lZCB8fCB0aGlzLm9hdXRoSW5mby50b2tlbkVuZHBvaW50ID09ICcnKXtcbiAgICAgIHRoaXMub2F1dGhJbmZvLnRva2VuRW5kcG9pbnQgPSB0aGlzLm9hdXRoSW5mby5zZXJ2ZXJIb3N0ICsgXCJvYXV0aC90b2tlblwiO1xuICAgIH1cbiAgICB0aGlzLmNvbmZpZ3VyZSgpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMudGltZXJBdXRoZW50aWNhdGVTdXNjcmlwdGlvbikge1xuICAgICAgdGhpcy50aW1lckF1dGhlbnRpY2F0ZVN1c2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIC8vIHRoaXMgb2JzZXJ2YWJsZSBpcyB0byB3YWl0IGEgd2hpbGUgZm9yIHRoZSBjb21wb25lbnQgdG8gZmluaXNoIGxvYWRpbmcsXG4gICAgLy8gYmVjYXVzZSBvdGhlcndpc2UgaXQgZmFpbHMgdG8gbm90aWZ5IHRoYXQgdGhlIHVzZXIgaXMgYXV0aGVudGljYXRlZFxuICAgIHRoaXMudGltZXJBdXRoZW50aWNhdGVTdXNjcmlwdGlvbiA9IHRpbWVyKDApLnN1YnNjcmliZShcbiAgICAgIHRoaXMudGltZXJBdXRoZW50aWNhdGVPYnNlcnZlclxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQ29uZmlndXJhdGlvbnMgdG8gYXV0aGVudGljYXRlXG4gICAqL1xuICBwcml2YXRlIGNvbmZpZ3VyZSgpIHtcbiAgICBjb25zdCBhdXRoQ29uZmlnOiBBdXRoQ29uZmlnID0ge1xuICAgICAgLy8gVXJsIG9mIHRoZSBJZGVudGl0eSBQcm92aWRlclxuICAgICAgLy9pc3N1ZXI6ICdodHRwczovL3NjZWliYS1sYWIudXByLmVkdS5jdScsXG5cbiAgICAgIGxvZ2luVXJsOiB0aGlzLm9hdXRoSW5mby5sb2dpblVybCxcblxuICAgICAgdG9rZW5FbmRwb2ludDogdGhpcy5vYXV0aEluZm8udG9rZW5FbmRwb2ludCxcblxuICAgICAgLy8gVVJMIG9mIHRoZSBTUEEgdG8gcmVkaXJlY3QgdGhlIHVzZXIgdG8gYWZ0ZXIgbG9naW5cbiAgICAgIHJlZGlyZWN0VXJpOiB0aGlzLm9hdXRoSW5mby5vYXV0aFJlZGlyZWN0VXJpLFxuXG4gICAgICAvLyBUaGUgU1BBJ3MgaWQuIFRoZSBTUEEgaXMgcmVnaXN0ZXJlZCB3aXRoIHRoaXMgaWQgYXQgdGhlIGF1dGgtc2VydmVyXG4gICAgICBjbGllbnRJZDogdGhpcy5vYXV0aEluZm8ub2F1dGhDbGllbnRJZCxcblxuICAgICAgb2lkYzogZmFsc2UsXG5cbiAgICAgIC8vIHNpbGVudFJlZnJlc2hSZWRpcmVjdFVyaTogdGhpcy5vYXV0aEluZm8uc2NlaWJhSG9zdCArICdvYXV0aC90b2tlbicsXG5cbiAgICAgIC8vIHRpbWVvdXRGYWN0b3I6IDAuNzUsXG5cbiAgICAgIHNlc3Npb25DaGVja3NFbmFibGVkOiB0cnVlLFxuICAgICAgLy8gc2V0IHRoZSBzY29wZSBmb3IgdGhlIHBlcm1pc3Npb25zIHRoZSBjbGllbnQgc2hvdWxkIHJlcXVlc3RcbiAgICAgIC8vIFRoZSBmaXJzdCB0aHJlZSBhcmUgZGVmaW5lZCBieSBPSURDLiBUaGUgNHRoIGlzIGEgdXNlY2FzZS1zcGVjaWZpYyBvbmVcbiAgICAgIHNjb3BlOiB0aGlzLm9hdXRoSW5mby5vYXV0aFNjb3BlLCAvLydvcGVuaWQgcHJvZmlsZSBlbWFpbCB2b3VjaGVyJyxcbiAgICB9O1xuICAgIHRoaXMub2F1dGhTZXJ2aWNlLmNvbmZpZ3VyZShhdXRoQ29uZmlnKTtcblxuICAgIC8vIFN0b3JlIHVzZXIgc2Vzc2lvbiBpbiBzdG9yYWdlXG4gICAgLy8gdGhpcy5vYXV0aFNlcnZpY2Uuc2V0U3RvcmFnZSh0aGlzLm9hdXRoU3RvcmFnZSk7XG5cbiAgICB0aGlzLm9hdXRoU2VydmljZS50b2tlblZhbGlkYXRpb25IYW5kbGVyID0gbmV3IEp3a3NWYWxpZGF0aW9uSGFuZGxlcigpO1xuXG4gICAgLy8gVHJ5IHRvIGxvZ2luIGFuZCBpZiBhIHRva2VuIHdhcyByZWNlaXZlZCwgcmVxdWVzdCB1c2VyIGluZm9ybWF0aW9uXG4gICAgdGhpcy5vYXV0aFNlcnZpY2UudHJ5TG9naW4oe1xuICAgICAgb25Ub2tlblJlY2VpdmVkOiAoXykgPT4ge1xuICAgICAgICAvLyBnaXZlcyBpbmZvcm1hdGlvbiBhYm91dCB1c2VyIGxvZ2d1ZWRcbiAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UudXNlckluZm9FbmRwb2ludCA9IHRoaXMub2F1dGhJbmZvLnVzZXJJbmZvRW5kcG9pbnQ7XG4gICAgICAgIHRoaXMuYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldFVzZXJJbmZvKCkuc3Vic2NyaWJlKFxuXG4gICAgICAgICAgICAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgdGhpcy5vYXV0aFN0b3JhZ2Uuc2V0SXRlbShcInVzZXJcIiwgSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICAgICAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UubG9naW4ocmVzcG9uc2UpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yID0+IGNvbnNvbGUubG9nKGVycm9yKSxcbiAgICAgICAgICAgICgpID0+IHt9XG5cblxuICAgICAgICAgIC8vIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgIC8vIHRoaXMub2F1dGhTdG9yYWdlLnNldEl0ZW0oXCJ1c2VyXCIsIEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlKSk7XG4gICAgICAgICAgLy8gLy8gLy8gc2F2ZSBlbWFpbCBpbiBzdG9yYWdlXG4gICAgICAgICAgLy8gLy8gaWYgKHRoaXMuYXV0aEJhY2tlbmQgPT0gQXV0aEJhY2tlbmQuY3Vvcil7XG4gICAgICAgICAgLy8gLy8gICB0aGlzLm9hdXRoU3RvcmFnZS5zZXRJdGVtKFwiZW1haWxcIiwgcmVzcG9uc2UuZW1haWwpO1xuICAgICAgICAgIC8vIC8vIH1lbHNle1xuICAgICAgICAgIC8vIC8vICAgdGhpcy5vYXV0aFN0b3JhZ2Uuc2V0SXRlbShcImVtYWlsXCIsIHJlc3BvbnNlLmRhdGEudXNlcnByb2ZpbGUudXNlci5lbWFpbCk7XG4gICAgICAgICAgLy8gLy8gfVxuICAgICAgICAgIC8vIC8vIHRoaXMub2F1dGhTdG9yYWdlLnNldEl0ZW0oJ3VzZXJJRCcsIHJlc3BvbnNlLmRhdGEudXNlcnByb2ZpbGUuaWQpO1xuXG4gICAgICAgICAgLy8gLy8gbm90aWZpZXMgdXNlciBpcyBsb2dnZWRcbiAgICAgICAgICAvLyB0aGlzLmF1dGhlbnRpY2F0aW9uU2VydmljZS5sb2dndWVkQ2hhbmdlKHRydWUpO1xuXG4gICAgICAgICAgLy8gdGhpcy51c2VyTmFtZSA9IHRoaXMub2F1dGhTdG9yYWdlLmdldEl0ZW0oXCJlbWFpbFwiKTtcblxuICAgICAgICAvLyB9XG4gICAgICAgICk7XG4gICAgICB9LFxuICAgICAgb25Mb2dpbkVycm9yOiAoZXJyKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3IgaW4gbG9naW5cIiwgZXJyKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogU3RhcnRzIHRoZSBsb2dpbiBmbG93XG4gICAqL1xuICBwdWJsaWMgbG9naW4oKSB7XG4gICAgdGhpcy5vYXV0aFNlcnZpY2UuaW5pdEltcGxpY2l0RmxvdygpO1xuICAgIC8vIHRoaXMuYXV0aGVudGljYXRpb25TZXJ2aWNlLmF1dGhCYWNrZW5kID0gdGhpcy5hdXRoQmFja2VuZFxuICAgIC8vIFRPRE86IHBvciBxdWUgZXN0byBhcXVpLCBlc3RlIG1vZHVsbyBzb2xvIHNlIGVuY2FyZ2EgZGUgbGEgYXV0ZW50aWNhY2lvbiB5IGRhciBsYSBpbmZvcm1hY2lvbiBiYXNpY2EgZGVsIHVzdWFyaW8sXG4gICAgLy8gZWwgcGVyZmlsIGVzIG1hbmVqYWRvIHBvciBvdHJvIGNvbXBvbmVudGVcbiAgICB0aGlzLnVzZXIgPSBuZXcgVXNlclByb2ZpbGUoKTtcbiAgICB0aGlzLnVzZXJQcm9maWxlU2VydmljZS5nZXRVc2VySW5mbygpLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLmRhdGEgJiYgcmVzcG9uc2UuZGF0YS51c2VycHJvZmlsZSkge1xuICAgICAgICAgIHRoaXMudXNlci5kZWVwY29weShyZXNwb25zZS5kYXRhLnVzZXJwcm9maWxlKTtcbiAgICAgICAgICB0aGlzLm9hdXRoU3RvcmFnZS5zZXRJdGVtKFwidXNlclwiLCB0aGlzLnVzZXIuZW50aXR5c3RyaW5naWZ5KCkpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgZXJyb3I6IChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgIH0sXG4gICAgICBjb21wbGV0ZTogKCkgPT4ge30sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRW5kcyB0aGUgbG9naW4gZmxvd1xuICAgKi9cbiAgcHVibGljIGxvZ29mZigpIHtcbiAgICB0aGlzLm9hdXRoU2VydmljZS5sb2dPdXQoKTtcbiAgICB0aGlzLmF1dGhlbnRpY2F0aW9uU2VydmljZS5sb2dvdXQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHaXZlcyB0aGUgdXNlcidzIGVtYWlsIGlmIHRoZSB1c2VyIGlzIGF1dGhlbnRpY2F0ZWRcbiAgICovXG4gIHB1YmxpYyBnZXQgbmFtZSgpIHtcbiAgICBpZiAodGhpcy5vYXV0aFN0b3JhZ2UuZ2V0SXRlbShcImFjY2Vzc190b2tlblwiKSkge1xuICAgICAgcmV0dXJuIHRoaXMub2F1dGhTdG9yYWdlLmdldEl0ZW0oXCJlbWFpbFwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG59XG4iXX0=