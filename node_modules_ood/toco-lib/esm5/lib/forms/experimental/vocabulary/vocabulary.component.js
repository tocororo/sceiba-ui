/**
 * @fileoverview added by tsickle
 * Generated from: lib/forms/experimental/vocabulary/vocabulary.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*
 *   Copyright (c) 2020 Universidad de Pinar del Río "Hermanos Saíz Montes de Oca"
 *   All rights reserved.
 */
import { Component } from "@angular/core";
import { FormControl } from "@angular/forms";
import { startWith, map } from "rxjs/operators";
import { TaxonomyService } from '../../../backend/public-api';
import { InputControl } from '../../input/input.control';
/**
 * @record
 */
function VocabularyComponentExtraContent() { }
if (false) {
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.multiple;
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.selectedTermsIds;
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.excludeTermsIds;
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.level;
    /** @type {?} */
    VocabularyComponentExtraContent.prototype.vocab;
}
/**
 * A control to select a term or terms in a vocabulary.
 */
var VocabularyComponent = /** @class */ (function (_super) {
    tslib_1.__extends(VocabularyComponent, _super);
    function VocabularyComponent(service) {
        var _this = _super.call(this) || this;
        _this.service = service;
        // internalControl = new FormControl();
        //this control is used by the chips,not necessary to expose it
        _this.chipsFormControl = new FormControl();
        _this.chipsList = [];
        _this.selectOptions = [];
        _this.terms = [];
        _this.loading = true;
        // selectedTermsIds = [];
        _this.searchText = "Seleccione las opciones";
        _this.termsTreeObserver = {
            next: (/**
             * @param {?} response
             * @return {?}
             */
            function (response) {
                console.log("VOCABULARY COMPONENT RESPONSE ", response);
                console.log(response.data.tree);
                _this.terms = response.data.tree.term_node;
                _this.terms.forEach((/**
                 * @param {?} element
                 * @return {?}
                 */
                function (element) {
                    _this.selectOptions = _this.selectOptions.concat(_this._get_terms(element));
                }));
            }),
            error: (/**
             * @param {?} err
             * @return {?}
             */
            function (err) {
                console.log("The observable got an error notification: " + err + ".");
            }),
            complete: (/**
             * @return {?}
             */
            function () {
                console.log("The observable got a complete notification.");
                _this.loading = !_this.loading;
            })
        };
        return _this;
    }
    /**
     * @return {?}
     */
    VocabularyComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.init('', '', false, true);
        // (this.content.parentFormSection as FormGroup).addControl(
        //   this.content.name,
        //   this.internalControl
        // );
        if (this.content.required) {
            this.content.formControl.setValidators((/**
             * @param {?} control
             * @return {?}
             */
            function (control) {
                return !_this.content.value || _this.content.value.length == 0
                    ? { requiredTerms: "No Terms Selected" }
                    : null;
            }));
        }
        this.inputId = this.content.label.trim().toLowerCase();
        if (this.content.extraContent) {
            this.extraContent = this.content.extraContent;
            // if (this.extraContent.multiple !== null) {
            //   this.multiple = this.extraContent.multiple;
            // }
            // if (this.extraContent.selectedTermsIds) {
            //   this.content.value = this.extraContent.selectedTermsIds;
            // } else {
            //   this.content.value = [];
            // }
            // already selected terms
            if (!this.extraContent.selectedTermsIds) {
                this.extraContent.selectedTermsIds = [];
            }
            // terms ids to exclude of the possible options.
            if (!this.extraContent.excludeTermsIds) {
                this.extraContent.excludeTermsIds = [];
            }
            this.content.value = [];
            if (this.extraContent.level == undefined) {
                this.extraContent.level = 10;
            }
            if (this.extraContent.vocab) {
                // this.vocab = this.extraContent.vocab;
                this.service
                    .getTermsTreeByVocab(this.extraContent.vocab, this.extraContent.level)
                    .subscribe(this.termsTreeObserver);
            }
            //   else if(this.extraContent.termID){
            //     this.service.getTermByUUID(this.extraContent.termID, this.extraContent.level)
            //     .subscribe(this.termsTreeObserver);
            // }
            this._updateFilteredOptions();
        }
    };
    /**
     * @private
     * @return {?}
     */
    VocabularyComponent.prototype.setValidation = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.content.formControl.valid) {
            this.chipsFormControl.setErrors(null);
        }
        else {
            this.chipsFormControl.setErrors({ requiered: true });
        }
    };
    /**
     * @private
     * @param {?} term
     * @return {?}
     */
    VocabularyComponent.prototype.addTermToValue = /**
     * @private
     * @param {?} term
     * @return {?}
     */
    function (term) {
        if (this.extraContent.multiple) {
            this.content.value.unshift(term);
        }
        else {
            this.content.value = [term];
        }
        this.content.formControl.setValue(this.content.value);
        this.setValidation();
    };
    /**
     * @private
     * @param {?} term
     * @return {?}
     */
    VocabularyComponent.prototype.removeTermFromValue = /**
     * @private
     * @param {?} term
     * @return {?}
     */
    function (term) {
        this.content.value = ((/** @type {?} */ (this.content.value))).filter((/**
         * @param {?} e
         * @return {?}
         */
        function (e) { return e.id !== term.id; }));
        this.content.formControl.setValue(this.content.value);
        this.setValidation();
    };
    /**
     * @private
     * @return {?}
     */
    VocabularyComponent.prototype._updateFilteredOptions = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.filteredOptions = this.chipsFormControl.valueChanges.pipe(startWith(""), map((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            /** @type {?} */
            var filterValue = value ? value.toLowerCase() : "";
            console.log('************************************');
            console.log(_this.selectOptions);
            console.log('************************************');
            return _this.selectOptions.filter((/**
             * @param {?} option
             * @return {?}
             */
            function (option) {
                return option.term.identifier.toLowerCase().includes(filterValue);
            }));
        })));
    };
    /**
     * @private
     * @param {?} node
     * @param {?=} parent
     * @return {?}
     */
    VocabularyComponent.prototype._get_terms = /**
     * @private
     * @param {?} node
     * @param {?=} parent
     * @return {?}
     */
    function (node, parent) {
        var _this = this;
        if (parent === void 0) { parent = null; }
        /** @type {?} */
        var result = [];
        node.parent = parent;
        // if is in selected terms ids list, then is part of the value
        if (((/** @type {?} */ (this.extraContent.selectedTermsIds))).some((/**
         * @param {?} id
         * @return {?}
         */
        function (id) { return id === node.term.uuid; }))) {
            this.addTermToValue(node.term);
            this.chipsList.push(node);
        }
        else {
            // if is not in any of the exclude term ids, then push
            if (!((/** @type {?} */ (this.extraContent.excludeTermsIds))).some((/**
             * @param {?} id
             * @return {?}
             */
            function (id) { return id === node.term.uuid; }))) {
                result.push(node);
            }
        }
        if (node.children) {
            node.children.forEach((/**
             * @param {?} child
             * @return {?}
             */
            function (child) {
                result = result.concat(_this._get_terms(child, node));
            }));
        }
        return result;
    };
    /**
     * @param {?} value
     * @return {?}
     */
    VocabularyComponent.prototype.addChips = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        if (this.extraContent.multiple) {
            this.chipsList.unshift(value);
        }
        else {
            // if not is multiple, then the element in the chipsList goes back to the options
            if (this.chipsList.length > 0) {
                this.selectOptions.push(this.chipsList[0]);
            }
            this.chipsList = [value];
        }
        this.addTermToValue(value.term);
        this.selectOptions = this.selectOptions.filter((/**
         * @param {?} option
         * @return {?}
         */
        function (option) { return option.term.id !== value.term.id; }));
        this.chipsFormControl.setValue("");
        // document.getElementById(this.inputId).blur();
        this._updateFilteredOptions();
    };
    /**
     * @param {?} index
     * @return {?}
     */
    VocabularyComponent.prototype.removeChip = /**
     * @param {?} index
     * @return {?}
     */
    function (index) {
        this.selectOptions.push(this.chipsList[index]);
        this.removeTermFromValue(this.chipsList[index].term);
        this.chipsList.splice(index, 1);
        this._updateFilteredOptions();
    };
    /**
     * @param {?} node
     * @return {?}
     */
    VocabularyComponent.prototype.getTermNameInATree = /**
     * @param {?} node
     * @return {?}
     */
    function (node) {
        if (node.parent != null) {
            return this.getTermNameInATree(node.parent) + " / " + node.term.description;
        }
        else {
            return node.term.description;
        }
    };
    VocabularyComponent.decorators = [
        { type: Component, args: [{
                    selector: "toco-vocabulary",
                    template: "<mat-card>\n\n  <mat-progress-bar *ngIf=\"loading\"\n    mode=\"indeterminate\">\n  </mat-progress-bar>\n\n    <mat-card-subtitle *ngIf=\"!loading\">\n    <mat-form-field style=\"width: 100%;\">\n\n      <mat-label> {{content.label}} <span *ngIf=\"content.required\">*</span></mat-label>\n      <input\n        matInput\n        id=\"'inputId-'{{content.name}}\"\n        type=\"text\"\n        [formControl]=\"chipsFormControl\"\n        [matAutocomplete]=\"auto\"\n          aria-label=\"Number\"\n      />\n\n      <mat-hint *ngIf=\"content.startHint\" [align]=\"'start'\">{{ content.startHint.label }}</mat-hint>\n      <mat-hint *ngIf=\"!content.startHint\" [align]=\"'start'\">{{ searchText }}</mat-hint>\n\n      <mat-autocomplete #auto=\"matAutocomplete\">\n        <mat-option *ngFor=\"let option of filteredOptions | async\" [value]=\"option.term.description\" (click)=\"addChips(option)\"\n          [title]=\"option.term.description\">\n          {{ option.term.description }}\n        </mat-option>\n      </mat-autocomplete>\n\n      <!-- <button mat-icon-button color=\"accent\" class=\"delete-filter\" (click)=\"remove_component()\">\n      <mat-icon>close</mat-icon>\n    </button> -->\n    </mat-form-field>\n  </mat-card-subtitle>\n  <mat-card-content *ngIf=\"!loading\">\n    <mat-chip-list class=\"mat-chip-list-stacked\" fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"margin-bottom: .5em\"\n      id=\"chiplist-{{extraContent.vocab}}\">\n      <mat-chip *ngFor=\"let item of chipsList; let i=index\" (removed)=\"removeChip(i)\" [removable]=\"true\" style=\"width: 100%;height: 100%;\">\n        {{ getTermNameInATree(item) }}\n        <mat-icon matChipRemove>cancel</mat-icon>\n      </mat-chip>\n    </mat-chip-list>\n  </mat-card-content>\n\n</mat-card>\n",
                    host: {
                        "[style.minWidth]": "content.minWidth",
                        "[style.width]": "content.width"
                    },
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    VocabularyComponent.ctorParameters = function () { return [
        { type: TaxonomyService }
    ]; };
    return VocabularyComponent;
}(InputControl));
export { VocabularyComponent };
if (false) {
    /** @type {?} */
    VocabularyComponent.prototype.chipsFormControl;
    /** @type {?} */
    VocabularyComponent.prototype.inputId;
    /** @type {?} */
    VocabularyComponent.prototype.filteredOptions;
    /** @type {?} */
    VocabularyComponent.prototype.chipsList;
    /** @type {?} */
    VocabularyComponent.prototype.selectOptions;
    /** @type {?} */
    VocabularyComponent.prototype.terms;
    /** @type {?} */
    VocabularyComponent.prototype.loading;
    /** @type {?} */
    VocabularyComponent.prototype.extraContent;
    /** @type {?} */
    VocabularyComponent.prototype.searchText;
    /**
     * @type {?}
     * @private
     */
    VocabularyComponent.prototype.termsTreeObserver;
    /**
     * @type {?}
     * @private
     */
    VocabularyComponent.prototype.service;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm9jYWJ1bGFyeS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly90b2NvLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9mb3Jtcy9leHBlcmltZW50YWwvdm9jYWJ1bGFyeS92b2NhYnVsYXJ5LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBS0EsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNsRCxPQUFPLEVBQ0wsV0FBVyxFQUlaLE1BQU0sZ0JBQWdCLENBQUM7QUFFeEIsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFHOUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDOzs7O0FBSXpELDhDQVFDOzs7SUFQQyxtREFBa0I7O0lBQ2xCLDJEQUFxQjs7SUFDckIsMERBQW9COztJQUVwQixnREFBYzs7SUFFZCxnREFBa0M7Ozs7O0FBTXBDO0lBU3lDLCtDQUFZO0lBK0NuRCw2QkFBb0IsT0FBd0I7UUFBNUMsWUFFRSxpQkFBTyxTQUNSO1FBSG1CLGFBQU8sR0FBUCxPQUFPLENBQWlCOzs7UUF6QzVDLHNCQUFnQixHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFHckMsZUFBUyxHQUFlLEVBQUUsQ0FBQztRQUMzQixtQkFBYSxHQUFlLEVBQUUsQ0FBQztRQUUvQixXQUFLLEdBQWUsRUFBRSxDQUFDO1FBRXZCLGFBQU8sR0FBRyxJQUFJLENBQUM7O1FBTWYsZ0JBQVUsR0FBRyx5QkFBeUIsQ0FBQztRQUUvQix1QkFBaUIsR0FBbUM7WUFDMUQsSUFBSTs7OztZQUFFLFVBQUMsUUFBdUI7Z0JBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLEVBQUMsUUFBUSxDQUFDLENBQUE7Z0JBQ3RELE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFFaEMsS0FBSSxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBRTFDLEtBQUksQ0FBQyxLQUFLLENBQUMsT0FBTzs7OztnQkFBQyxVQUFBLE9BQU87b0JBQ3hCLEtBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQzVDLEtBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQ3pCLENBQUM7Z0JBQ0osQ0FBQyxFQUFDLENBQUM7WUFFTCxDQUFDLENBQUE7WUFFRCxLQUFLOzs7O1lBQUUsVUFBQyxHQUFRO2dCQUNkLE9BQU8sQ0FBQyxHQUFHLENBQUMsNENBQTRDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQ3hFLENBQUMsQ0FBQTtZQUVELFFBQVE7OztZQUFFO2dCQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkNBQTZDLENBQUMsQ0FBQztnQkFDM0QsS0FBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUM7WUFDL0IsQ0FBQyxDQUFBO1NBQ0YsQ0FBQzs7SUFLRixDQUFDOzs7O0lBRUQsc0NBQVE7OztJQUFSO1FBQUEsaUJBeURDO1FBdkRDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDL0IsNERBQTREO1FBQzVELHVCQUF1QjtRQUN2Qix5QkFBeUI7UUFDekIsS0FBSztRQUVMLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUU7WUFDekIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsYUFBYTs7OztZQUNwQyxVQUFDLE9BQXdCO2dCQUN2QixPQUFPLENBQUMsS0FBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksS0FBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxJQUFJLENBQUM7b0JBQzFELENBQUMsQ0FBQyxFQUFFLGFBQWEsRUFBRSxtQkFBbUIsRUFBRTtvQkFDeEMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNYLENBQUMsRUFDRixDQUFDO1NBQ0g7UUFFRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3ZELElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUU7WUFDN0IsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQztZQUU5Qyw2Q0FBNkM7WUFDN0MsZ0RBQWdEO1lBQ2hELElBQUk7WUFDSiw0Q0FBNEM7WUFDNUMsNkRBQTZEO1lBQzdELFdBQVc7WUFDWCw2QkFBNkI7WUFDN0IsSUFBSTtZQUVKLHlCQUF5QjtZQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDdkMsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7YUFDekM7WUFFRCxnREFBZ0Q7WUFDaEQsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsZUFBZSxFQUFFO2dCQUN0QyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7YUFDeEM7WUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7WUFFeEIsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssSUFBSSxTQUFTLEVBQUU7Z0JBQ3hDLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQzthQUM5QjtZQUNELElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUU7Z0JBQzNCLHdDQUF3QztnQkFDeEMsSUFBSSxDQUFDLE9BQU87cUJBQ1QsbUJBQW1CLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUM7cUJBQ3JFLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQzthQUN0QztZQUNILHVDQUF1QztZQUN2QyxvRkFBb0Y7WUFDcEYsMENBQTBDO1lBQzFDLElBQUk7WUFDRixJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztTQUMvQjtJQUNILENBQUM7Ozs7O0lBRU8sMkNBQWE7Ozs7SUFBckI7UUFDRSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRTtZQUNsQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3ZDO2FBQU07WUFDTCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7U0FDdEQ7SUFDSCxDQUFDOzs7Ozs7SUFDTyw0Q0FBYzs7Ozs7SUFBdEIsVUFBdUIsSUFBVTtRQUMvQixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFO1lBQzlCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNsQzthQUFNO1lBQ0wsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM3QjtRQUNELElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDOzs7Ozs7SUFFTyxpREFBbUI7Ozs7O0lBQTNCLFVBQTRCLElBQVU7UUFDcEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxtQkFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBTSxDQUFDLENBQUMsTUFBTTs7OztRQUNwRCxVQUFDLENBQU8sSUFBSyxPQUFBLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsRUFBaEIsQ0FBZ0IsRUFDOUIsQ0FBQztRQUNGLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDOzs7OztJQUVPLG9EQUFzQjs7OztJQUE5QjtRQUFBLGlCQWlCQztRQWhCQyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUk1RCxTQUFTLENBQUMsRUFBRSxDQUFDLEVBQ2IsR0FBRzs7OztRQUFDLFVBQUEsS0FBSzs7Z0JBQ0QsV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ3BELE9BQU8sQ0FBQyxHQUFHLENBQUMsc0NBQXNDLENBQUMsQ0FBQTtZQUNuRCxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUNoQyxPQUFPLENBQUMsR0FBRyxDQUFDLHNDQUFzQyxDQUFDLENBQUE7WUFFbkQsT0FBTyxLQUFJLENBQUMsYUFBYSxDQUFDLE1BQU07Ozs7WUFBQyxVQUFBLE1BQU07Z0JBQ3JDLE9BQUEsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQztZQUExRCxDQUEwRCxFQUMzRCxDQUFDO1FBQ0osQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7Ozs7Ozs7SUFFTyx3Q0FBVTs7Ozs7O0lBQWxCLFVBQW1CLElBQWMsRUFBRSxNQUF1QjtRQUExRCxpQkE2QkM7UUE3QmtDLHVCQUFBLEVBQUEsYUFBdUI7O1lBQ3BELE1BQU0sR0FBZSxFQUFFO1FBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLDhEQUE4RDtRQUM5RCxJQUNFLENBQUMsbUJBQUEsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsRUFBTSxDQUFDLENBQUMsSUFBSTs7OztRQUM3QyxVQUFBLEVBQUUsSUFBSSxPQUFBLEVBQUUsS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBckIsQ0FBcUIsRUFDNUIsRUFDRDtZQUNBLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzNCO2FBQU07WUFDTCxzREFBc0Q7WUFDdEQsSUFDRSxDQUFDLENBQUMsbUJBQUEsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLEVBQU0sQ0FBQyxDQUFDLElBQUk7Ozs7WUFDN0MsVUFBQSxFQUFFLElBQUksT0FBQSxFQUFFLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQXJCLENBQXFCLEVBQzVCLEVBQ0Q7Z0JBQ0EsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNuQjtTQUNGO1FBQ0QsSUFBRyxJQUFJLENBQUMsUUFBUSxFQUFDO1lBQ2YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQSxLQUFLO2dCQUN6QixNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3ZELENBQUMsRUFBQyxDQUFDO1NBQ0o7UUFHRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOzs7OztJQUVELHNDQUFROzs7O0lBQVIsVUFBUyxLQUFlO1FBQ3RCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUU7WUFDOUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDL0I7YUFBTTtZQUNMLGlGQUFpRjtZQUNqRixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDN0IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzVDO1lBQ0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzFCO1FBQ0QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU07Ozs7UUFDNUMsVUFBQSxNQUFNLElBQUksT0FBQSxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBaEMsQ0FBZ0MsRUFDM0MsQ0FBQztRQUVGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkMsZ0RBQWdEO1FBQ2hELElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0lBQ2hDLENBQUM7Ozs7O0lBRUQsd0NBQVU7Ozs7SUFBVixVQUFXLEtBQWE7UUFDdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztJQUNoQyxDQUFDOzs7OztJQUVELGdEQUFrQjs7OztJQUFsQixVQUFtQixJQUFjO1FBQy9CLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLEVBQUU7WUFDdkIsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztTQUM3RTthQUFNO1lBQ0wsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztTQUM5QjtJQUNILENBQUM7O2dCQXBPRixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLGlCQUFpQjtvQkFDM0Isd3dEQUEwQztvQkFFMUMsSUFBSSxFQUFFO3dCQUNKLGtCQUFrQixFQUFFLGtCQUFrQjt3QkFDdEMsZUFBZSxFQUFFLGVBQWU7cUJBQ2pDOztpQkFDRjs7OztnQkE1QlEsZUFBZTs7SUF5UHhCLDBCQUFDO0NBQUEsQUFyT0QsQ0FTeUMsWUFBWSxHQTROcEQ7U0E1TlksbUJBQW1COzs7SUFNOUIsK0NBQXFDOztJQUNyQyxzQ0FBZ0I7O0lBQ2hCLDhDQUF3Qzs7SUFDeEMsd0NBQTJCOztJQUMzQiw0Q0FBK0I7O0lBRS9CLG9DQUF1Qjs7SUFFdkIsc0NBQWU7O0lBRWYsMkNBQThDOztJQUk5Qyx5Q0FBdUM7Ozs7O0lBRXZDLGdEQXVCRTs7Ozs7SUFFVSxzQ0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogICBDb3B5cmlnaHQgKGMpIDIwMjAgVW5pdmVyc2lkYWQgZGUgUGluYXIgZGVsIFLDrW8gXCJIZXJtYW5vcyBTYcOteiBNb250ZXMgZGUgT2NhXCJcbiAqICAgQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqL1xuXG5pbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQge1xuICBGb3JtQ29udHJvbCxcbiAgQWJzdHJhY3RDb250cm9sLFxuICBWYWxpZGF0aW9uRXJyb3JzLFxuICBGb3JtR3JvdXBcbn0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBQYXJ0aWFsT2JzZXJ2ZXIgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgc3RhcnRXaXRoLCBtYXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IFRheG9ub215U2VydmljZSB9IGZyb20gJy4uLy4uLy4uL2JhY2tlbmQvcHVibGljLWFwaSc7XG5pbXBvcnQgeyBWb2NhYnVsYXJpZXNJbm11dGFibGVOYW1lcywgVGVybU5vZGUsIFRlcm0gfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9wdWJsaWMtYXBpJztcblxuaW1wb3J0IHsgSW5wdXRDb250cm9sIH0gZnJvbSAnLi4vLi4vaW5wdXQvaW5wdXQuY29udHJvbCc7XG5cbmltcG9ydCB7IFJlc3BvbnNlIH0gZnJvbSAnLi4vLi4vLi4vY29yZS9wdWJsaWMtYXBpJztcblxuaW50ZXJmYWNlIFZvY2FidWxhcnlDb21wb25lbnRFeHRyYUNvbnRlbnR7XG4gIG11bHRpcGxlOiBib29sZWFuO1xuICBzZWxlY3RlZFRlcm1zSWRzOiBbXTtcbiAgZXhjbHVkZVRlcm1zSWRzOiBbXTtcblxuICBsZXZlbDogbnVtYmVyO1xuXG4gIHZvY2FiOiBWb2NhYnVsYXJpZXNJbm11dGFibGVOYW1lcztcbn1cblxuLyoqXG4gKiBBIGNvbnRyb2wgdG8gc2VsZWN0IGEgdGVybSBvciB0ZXJtcyBpbiBhIHZvY2FidWxhcnkuXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogXCJ0b2NvLXZvY2FidWxhcnlcIixcbiAgdGVtcGxhdGVVcmw6IFwiLi92b2NhYnVsYXJ5LmNvbXBvbmVudC5odG1sXCIsXG4gIHN0eWxlVXJsczogW1wiLi92b2NhYnVsYXJ5LmNvbXBvbmVudC5zY3NzXCJdLFxuICBob3N0OiB7XG4gICAgXCJbc3R5bGUubWluV2lkdGhdXCI6IFwiY29udGVudC5taW5XaWR0aFwiLFxuICAgIFwiW3N0eWxlLndpZHRoXVwiOiBcImNvbnRlbnQud2lkdGhcIlxuICB9XG59KVxuZXhwb3J0IGNsYXNzIFZvY2FidWxhcnlDb21wb25lbnQgZXh0ZW5kcyBJbnB1dENvbnRyb2xcbiAgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gIC8vIGludGVybmFsQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbCgpO1xuXG4gIC8vdGhpcyBjb250cm9sIGlzIHVzZWQgYnkgdGhlIGNoaXBzLG5vdCBuZWNlc3NhcnkgdG8gZXhwb3NlIGl0XG4gIGNoaXBzRm9ybUNvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2woKTtcbiAgaW5wdXRJZDogc3RyaW5nO1xuICBmaWx0ZXJlZE9wdGlvbnM6IE9ic2VydmFibGU8VGVybU5vZGVbXT47XG4gIGNoaXBzTGlzdDogVGVybU5vZGVbXSA9IFtdO1xuICBzZWxlY3RPcHRpb25zOiBUZXJtTm9kZVtdID0gW107XG5cbiAgdGVybXM6IFRlcm1Ob2RlW10gPSBbXTtcblxuICBsb2FkaW5nID0gdHJ1ZTtcblxuICBleHRyYUNvbnRlbnQ6IFZvY2FidWxhcnlDb21wb25lbnRFeHRyYUNvbnRlbnQ7XG5cbiAgLy8gc2VsZWN0ZWRUZXJtc0lkcyA9IFtdO1xuXG4gIHNlYXJjaFRleHQgPSBcIlNlbGVjY2lvbmUgbGFzIG9wY2lvbmVzXCI7XG5cbiAgcHJpdmF0ZSB0ZXJtc1RyZWVPYnNlcnZlcjogUGFydGlhbE9ic2VydmVyPFJlc3BvbnNlPGFueT4+ID0ge1xuICAgIG5leHQ6IChyZXNwb25zZTogUmVzcG9uc2U8YW55PikgPT4ge1xuICAgICAgY29uc29sZS5sb2coXCJWT0NBQlVMQVJZIENPTVBPTkVOVCBSRVNQT05TRSBcIixyZXNwb25zZSlcbiAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlLmRhdGEudHJlZSk7XG5cbiAgICAgIHRoaXMudGVybXMgPSByZXNwb25zZS5kYXRhLnRyZWUudGVybV9ub2RlO1xuXG4gICAgICB0aGlzLnRlcm1zLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICAgIHRoaXMuc2VsZWN0T3B0aW9ucyA9IHRoaXMuc2VsZWN0T3B0aW9ucy5jb25jYXQoXG4gICAgICAgICAgdGhpcy5fZ2V0X3Rlcm1zKGVsZW1lbnQpXG4gICAgICAgICk7XG4gICAgICB9KTtcblxuICAgIH0sXG5cbiAgICBlcnJvcjogKGVycjogYW55KSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhcIlRoZSBvYnNlcnZhYmxlIGdvdCBhbiBlcnJvciBub3RpZmljYXRpb246IFwiICsgZXJyICsgXCIuXCIpO1xuICAgIH0sXG5cbiAgICBjb21wbGV0ZTogKCkgPT4ge1xuICAgICAgY29uc29sZS5sb2coXCJUaGUgb2JzZXJ2YWJsZSBnb3QgYSBjb21wbGV0ZSBub3RpZmljYXRpb24uXCIpO1xuICAgICAgdGhpcy5sb2FkaW5nID0gIXRoaXMubG9hZGluZztcbiAgICB9XG4gIH07XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzZXJ2aWNlOiBUYXhvbm9teVNlcnZpY2UpXG4gIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgbmdPbkluaXQoKVxuICB7XG4gICAgdGhpcy5pbml0KCcnLCAnJywgZmFsc2UsIHRydWUpO1xuICAgIC8vICh0aGlzLmNvbnRlbnQucGFyZW50Rm9ybVNlY3Rpb24gYXMgRm9ybUdyb3VwKS5hZGRDb250cm9sKFxuICAgIC8vICAgdGhpcy5jb250ZW50Lm5hbWUsXG4gICAgLy8gICB0aGlzLmludGVybmFsQ29udHJvbFxuICAgIC8vICk7XG5cbiAgICBpZiAodGhpcy5jb250ZW50LnJlcXVpcmVkKSB7XG4gICAgICB0aGlzLmNvbnRlbnQuZm9ybUNvbnRyb2wuc2V0VmFsaWRhdG9ycyhcbiAgICAgICAgKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRpb25FcnJvcnMgfCBudWxsID0+IHtcbiAgICAgICAgICByZXR1cm4gIXRoaXMuY29udGVudC52YWx1ZSB8fCB0aGlzLmNvbnRlbnQudmFsdWUubGVuZ3RoID09IDBcbiAgICAgICAgICAgID8geyByZXF1aXJlZFRlcm1zOiBcIk5vIFRlcm1zIFNlbGVjdGVkXCIgfVxuICAgICAgICAgICAgOiBudWxsO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuaW5wdXRJZCA9IHRoaXMuY29udGVudC5sYWJlbC50cmltKCkudG9Mb3dlckNhc2UoKTtcbiAgICBpZiAodGhpcy5jb250ZW50LmV4dHJhQ29udGVudCkge1xuICAgICAgdGhpcy5leHRyYUNvbnRlbnQgPSB0aGlzLmNvbnRlbnQuZXh0cmFDb250ZW50O1xuXG4gICAgICAvLyBpZiAodGhpcy5leHRyYUNvbnRlbnQubXVsdGlwbGUgIT09IG51bGwpIHtcbiAgICAgIC8vICAgdGhpcy5tdWx0aXBsZSA9IHRoaXMuZXh0cmFDb250ZW50Lm11bHRpcGxlO1xuICAgICAgLy8gfVxuICAgICAgLy8gaWYgKHRoaXMuZXh0cmFDb250ZW50LnNlbGVjdGVkVGVybXNJZHMpIHtcbiAgICAgIC8vICAgdGhpcy5jb250ZW50LnZhbHVlID0gdGhpcy5leHRyYUNvbnRlbnQuc2VsZWN0ZWRUZXJtc0lkcztcbiAgICAgIC8vIH0gZWxzZSB7XG4gICAgICAvLyAgIHRoaXMuY29udGVudC52YWx1ZSA9IFtdO1xuICAgICAgLy8gfVxuXG4gICAgICAvLyBhbHJlYWR5IHNlbGVjdGVkIHRlcm1zXG4gICAgICBpZiAoIXRoaXMuZXh0cmFDb250ZW50LnNlbGVjdGVkVGVybXNJZHMpIHtcbiAgICAgICAgdGhpcy5leHRyYUNvbnRlbnQuc2VsZWN0ZWRUZXJtc0lkcyA9IFtdO1xuICAgICAgfVxuXG4gICAgICAvLyB0ZXJtcyBpZHMgdG8gZXhjbHVkZSBvZiB0aGUgcG9zc2libGUgb3B0aW9ucy5cbiAgICAgIGlmICghdGhpcy5leHRyYUNvbnRlbnQuZXhjbHVkZVRlcm1zSWRzKSB7XG4gICAgICAgIHRoaXMuZXh0cmFDb250ZW50LmV4Y2x1ZGVUZXJtc0lkcyA9IFtdO1xuICAgICAgfVxuICAgICAgdGhpcy5jb250ZW50LnZhbHVlID0gW107XG5cbiAgICAgIGlmICh0aGlzLmV4dHJhQ29udGVudC5sZXZlbCA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5leHRyYUNvbnRlbnQubGV2ZWwgPSAxMDtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmV4dHJhQ29udGVudC52b2NhYikge1xuICAgICAgICAvLyB0aGlzLnZvY2FiID0gdGhpcy5leHRyYUNvbnRlbnQudm9jYWI7XG4gICAgICAgIHRoaXMuc2VydmljZVxuICAgICAgICAgIC5nZXRUZXJtc1RyZWVCeVZvY2FiKHRoaXMuZXh0cmFDb250ZW50LnZvY2FiLCB0aGlzLmV4dHJhQ29udGVudC5sZXZlbClcbiAgICAgICAgICAuc3Vic2NyaWJlKHRoaXMudGVybXNUcmVlT2JzZXJ2ZXIpO1xuICAgICAgfVxuICAgIC8vICAgZWxzZSBpZih0aGlzLmV4dHJhQ29udGVudC50ZXJtSUQpe1xuICAgIC8vICAgICB0aGlzLnNlcnZpY2UuZ2V0VGVybUJ5VVVJRCh0aGlzLmV4dHJhQ29udGVudC50ZXJtSUQsIHRoaXMuZXh0cmFDb250ZW50LmxldmVsKVxuICAgIC8vICAgICAuc3Vic2NyaWJlKHRoaXMudGVybXNUcmVlT2JzZXJ2ZXIpO1xuICAgIC8vIH1cbiAgICAgIHRoaXMuX3VwZGF0ZUZpbHRlcmVkT3B0aW9ucygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0VmFsaWRhdGlvbigpIHtcbiAgICBpZiAodGhpcy5jb250ZW50LmZvcm1Db250cm9sLnZhbGlkKSB7XG4gICAgICB0aGlzLmNoaXBzRm9ybUNvbnRyb2wuc2V0RXJyb3JzKG51bGwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNoaXBzRm9ybUNvbnRyb2wuc2V0RXJyb3JzKHsgcmVxdWllcmVkOiB0cnVlIH0pO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGFkZFRlcm1Ub1ZhbHVlKHRlcm06IFRlcm0pIHtcbiAgICBpZiAodGhpcy5leHRyYUNvbnRlbnQubXVsdGlwbGUpIHtcbiAgICAgIHRoaXMuY29udGVudC52YWx1ZS51bnNoaWZ0KHRlcm0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNvbnRlbnQudmFsdWUgPSBbdGVybV07XG4gICAgfVxuICAgIHRoaXMuY29udGVudC5mb3JtQ29udHJvbC5zZXRWYWx1ZSh0aGlzLmNvbnRlbnQudmFsdWUpO1xuICAgIHRoaXMuc2V0VmFsaWRhdGlvbigpO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVUZXJtRnJvbVZhbHVlKHRlcm06IFRlcm0pIHtcbiAgICB0aGlzLmNvbnRlbnQudmFsdWUgPSAodGhpcy5jb250ZW50LnZhbHVlIGFzIFtdKS5maWx0ZXIoXG4gICAgICAoZTogVGVybSkgPT4gZS5pZCAhPT0gdGVybS5pZFxuICAgICk7XG4gICAgdGhpcy5jb250ZW50LmZvcm1Db250cm9sLnNldFZhbHVlKHRoaXMuY29udGVudC52YWx1ZSk7XG4gICAgdGhpcy5zZXRWYWxpZGF0aW9uKCk7XG4gIH1cblxuICBwcml2YXRlIF91cGRhdGVGaWx0ZXJlZE9wdGlvbnMoKSB7XG4gICAgdGhpcy5maWx0ZXJlZE9wdGlvbnMgPSB0aGlzLmNoaXBzRm9ybUNvbnRyb2wudmFsdWVDaGFuZ2VzLnBpcGU8XG4gICAgICBzdHJpbmcsXG4gICAgICBUZXJtTm9kZVtdXG4gICAgPihcbiAgICAgIHN0YXJ0V2l0aChcIlwiKSxcbiAgICAgIG1hcCh2YWx1ZSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbHRlclZhbHVlID0gdmFsdWUgPyB2YWx1ZS50b0xvd2VyQ2FzZSgpIDogXCJcIjtcbiAgICAgICAgY29uc29sZS5sb2coJyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKicpXG4gICAgICAgIGNvbnNvbGUubG9nKHRoaXMuc2VsZWN0T3B0aW9ucyk7XG4gICAgICAgIGNvbnNvbGUubG9nKCcqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKionKVxuXG4gICAgICAgIHJldHVybiB0aGlzLnNlbGVjdE9wdGlvbnMuZmlsdGVyKG9wdGlvbiA9PlxuICAgICAgICAgIG9wdGlvbi50ZXJtLmlkZW50aWZpZXIudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmaWx0ZXJWYWx1ZSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldF90ZXJtcyhub2RlOiBUZXJtTm9kZSwgcGFyZW50OiBUZXJtTm9kZSA9IG51bGwpOiBUZXJtTm9kZVtdIHtcbiAgICBsZXQgcmVzdWx0OiBUZXJtTm9kZVtdID0gW107XG4gICAgbm9kZS5wYXJlbnQgPSBwYXJlbnQ7XG4gICAgLy8gaWYgaXMgaW4gc2VsZWN0ZWQgdGVybXMgaWRzIGxpc3QsIHRoZW4gaXMgcGFydCBvZiB0aGUgdmFsdWVcbiAgICBpZiAoXG4gICAgICAodGhpcy5leHRyYUNvbnRlbnQuc2VsZWN0ZWRUZXJtc0lkcyBhcyBbXSkuc29tZShcbiAgICAgICAgaWQgPT4gaWQgPT09IG5vZGUudGVybS51dWlkXG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aGlzLmFkZFRlcm1Ub1ZhbHVlKG5vZGUudGVybSk7XG4gICAgICB0aGlzLmNoaXBzTGlzdC5wdXNoKG5vZGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBpZiBpcyBub3QgaW4gYW55IG9mIHRoZSBleGNsdWRlIHRlcm0gaWRzLCB0aGVuIHB1c2hcbiAgICAgIGlmIChcbiAgICAgICAgISh0aGlzLmV4dHJhQ29udGVudC5leGNsdWRlVGVybXNJZHMgYXMgW10pLnNvbWUoXG4gICAgICAgICAgaWQgPT4gaWQgPT09IG5vZGUudGVybS51dWlkXG4gICAgICAgIClcbiAgICAgICkge1xuICAgICAgICByZXN1bHQucHVzaChub2RlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYobm9kZS5jaGlsZHJlbil7XG4gICAgICBub2RlLmNoaWxkcmVuLmZvckVhY2goY2hpbGQgPT4ge1xuICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KHRoaXMuX2dldF90ZXJtcyhjaGlsZCwgbm9kZSkpO1xuICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgYWRkQ2hpcHModmFsdWU6IFRlcm1Ob2RlKSB7XG4gICAgaWYgKHRoaXMuZXh0cmFDb250ZW50Lm11bHRpcGxlKSB7XG4gICAgICB0aGlzLmNoaXBzTGlzdC51bnNoaWZ0KHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gaWYgbm90IGlzIG11bHRpcGxlLCB0aGVuIHRoZSBlbGVtZW50IGluIHRoZSBjaGlwc0xpc3QgZ29lcyBiYWNrIHRvIHRoZSBvcHRpb25zXG4gICAgICBpZiAodGhpcy5jaGlwc0xpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLnNlbGVjdE9wdGlvbnMucHVzaCh0aGlzLmNoaXBzTGlzdFswXSk7XG4gICAgICB9XG4gICAgICB0aGlzLmNoaXBzTGlzdCA9IFt2YWx1ZV07XG4gICAgfVxuICAgIHRoaXMuYWRkVGVybVRvVmFsdWUodmFsdWUudGVybSk7XG4gICAgdGhpcy5zZWxlY3RPcHRpb25zID0gdGhpcy5zZWxlY3RPcHRpb25zLmZpbHRlcihcbiAgICAgIG9wdGlvbiA9PiBvcHRpb24udGVybS5pZCAhPT0gdmFsdWUudGVybS5pZFxuICAgICk7XG5cbiAgICB0aGlzLmNoaXBzRm9ybUNvbnRyb2wuc2V0VmFsdWUoXCJcIik7XG4gICAgLy8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5pbnB1dElkKS5ibHVyKCk7XG4gICAgdGhpcy5fdXBkYXRlRmlsdGVyZWRPcHRpb25zKCk7XG4gIH1cblxuICByZW1vdmVDaGlwKGluZGV4OiBudW1iZXIpIHtcbiAgICB0aGlzLnNlbGVjdE9wdGlvbnMucHVzaCh0aGlzLmNoaXBzTGlzdFtpbmRleF0pO1xuICAgIHRoaXMucmVtb3ZlVGVybUZyb21WYWx1ZSh0aGlzLmNoaXBzTGlzdFtpbmRleF0udGVybSk7XG4gICAgdGhpcy5jaGlwc0xpc3Quc3BsaWNlKGluZGV4LCAxKTtcbiAgICB0aGlzLl91cGRhdGVGaWx0ZXJlZE9wdGlvbnMoKTtcbiAgfVxuXG4gIGdldFRlcm1OYW1lSW5BVHJlZShub2RlOiBUZXJtTm9kZSkge1xuICAgIGlmIChub2RlLnBhcmVudCAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRUZXJtTmFtZUluQVRyZWUobm9kZS5wYXJlbnQpICsgXCIgLyBcIiArIG5vZGUudGVybS5kZXNjcmlwdGlvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5vZGUudGVybS5kZXNjcmlwdGlvbjtcbiAgICB9XG4gIH1cbn1cbiJdfQ==