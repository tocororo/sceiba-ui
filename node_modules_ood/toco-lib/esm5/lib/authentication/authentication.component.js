/**
 * @fileoverview added by tsickle
 * Generated from: lib/authentication/authentication.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input } from "@angular/core";
import { Router } from "@angular/router";
import { timer } from "rxjs";
import { TranslateService } from "@ngx-translate/core";
import { JwksValidationHandler, OAuthService, OAuthStorage } from "angular-oauth2-oidc";
import { Environment } from "../core/env";
import { UserProfileService } from "../backend/user-profile.service";
import { UserProfile } from "../entities/person.entity";
import { OauthAuthenticationService } from "./authentication.service";
/**
 * @record
 */
export function OauthInfo() { }
if (false) {
    /** @type {?} */
    OauthInfo.prototype.serverHost;
    /** @type {?} */
    OauthInfo.prototype.loginUrl;
    /** @type {?} */
    OauthInfo.prototype.tokenEndpoint;
    /** @type {?} */
    OauthInfo.prototype.userInfoEndpoint;
    /** @type {?} */
    OauthInfo.prototype.appHost;
    /** @type {?} */
    OauthInfo.prototype.appName;
    /** @type {?} */
    OauthInfo.prototype.oauthRedirectUri;
    /** @type {?} */
    OauthInfo.prototype.oauthClientId;
    /** @type {?} */
    OauthInfo.prototype.oauthScope;
}
/**
 * Represents a component used to authenticate.
 *
 * In order to use this component with the correct i18n, you must include
 * (in your i18n translate files that are in the folder `assets\i18n`)
 * a translation key of name "TOCO_AUTHENTICATION" that contains
 * an object as value with the translation needed by this component.
 *
 * In the case of `es.json` file, you must include the following translation key:
 * "TOCO_AUTHENTICATION": {
 * "MAT_CARD_TITLE_AUTH": "Autenticaci√≥n con",
 * "AUTENTICARSE": "Autenticarse",
 * "H1_HOLA": "Hola",
 * "BUTTON_SALIR": "Salir"
 * }
 *
 * In the case of `en.json` file, you must include the following translation key:
 * "TOCO_AUTHENTICATION": {
 * "MAT_CARD_TITLE_AUTH": "Authentication with",
 * "AUTENTICARSE": "Log in",
 * "H1_HOLA": "Hello,",
 * "BUTTON_SALIR": "Exit"
 * }
 *
 * If you have another language, then you have another `*.json` file,
 * and you must include the "TOCO_AUTHENTICATION" translation key with the correct translation values.
 */
var AuthenticationComponent = /** @class */ (function () {
    function AuthenticationComponent(userProfileService, env, router, oauthService, oauthStorage, authenticationService, _transServ) {
        var _this = this;
        this.userProfileService = userProfileService;
        this.env = env;
        this.router = router;
        this.oauthService = oauthService;
        this.oauthStorage = oauthStorage;
        this.authenticationService = authenticationService;
        this._transServ = _transServ;
        this.timerAuthenticateSuscription = null;
        this.timerAuthenticateObserver = {
            next: (/**
             * @param {?} _
             * @return {?}
             */
            function (_) {
                // console.log('next');
                // this.oauthService.setupAutomaticSilentRefresh();
                if (_this.oauthStorage.getItem("access_token")) {
                    _this.authenticationService.getUserInfo().subscribe((/**
                     * @param {?} response
                     * @return {?}
                     */
                    function (response) {
                        _this.oauthStorage.setItem("user", JSON.stringify(response));
                        _this.authenticationService.login(response);
                    }), (/**
                     * @param {?} error
                     * @return {?}
                     */
                    function (error) { return console.log(error); }), (/**
                     * @return {?}
                     */
                    function () { }));
                    // this.authenticationService.logguedChange(true);
                }
            }),
            error: (/**
             * @param {?} err
             * @return {?}
             */
            function (err) {
                console.log("The observable got an error notification: " + err + ".");
            }),
            complete: (/**
             * @return {?}
             */
            function () {
                console.log("The observable got a complete notification.");
            }),
        };
    }
    /**
     * @return {?}
     */
    AuthenticationComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.isButtonLogin == undefined)
            this.isButtonLogin = false;
        if (this.isButtonLoginIcon == undefined)
            this.isButtonLoginIcon = false;
        if (this.isButtonLoginText == undefined) {
            this._transServ.get('TOCO_AUTHENTICATION.AUTENTICARSE').subscribe((/**
             * @param {?} res
             * @return {?}
             */
            function (res) {
                _this.isButtonLoginText = res;
            }));
        }
        if (this.oauthInfo.loginUrl == undefined || this.oauthInfo.loginUrl == '') {
            this.oauthInfo.loginUrl = this.oauthInfo.serverHost + "oauth/authorize";
        }
        if (this.oauthInfo.tokenEndpoint == undefined || this.oauthInfo.tokenEndpoint == '') {
            this.oauthInfo.tokenEndpoint = this.oauthInfo.serverHost + "oauth/token";
        }
        this.configure();
    };
    /**
     * @return {?}
     */
    AuthenticationComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.timerAuthenticateSuscription) {
            this.timerAuthenticateSuscription.unsubscribe();
        }
    };
    /**
     * @return {?}
     */
    AuthenticationComponent.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        // this observable is to wait a while for the component to finish loading,
        // because otherwise it fails to notify that the user is authenticated
        this.timerAuthenticateSuscription = timer(0).subscribe(this.timerAuthenticateObserver);
    };
    /**
     * Configurations to authenticate
     */
    /**
     * Configurations to authenticate
     * @private
     * @return {?}
     */
    AuthenticationComponent.prototype.configure = /**
     * Configurations to authenticate
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var authConfig = {
            // Url of the Identity Provider
            //issuer: 'https://sceiba-lab.upr.edu.cu',
            loginUrl: this.oauthInfo.loginUrl,
            tokenEndpoint: this.oauthInfo.tokenEndpoint,
            // URL of the SPA to redirect the user to after login
            redirectUri: this.oauthInfo.oauthRedirectUri,
            // The SPA's id. The SPA is registered with this id at the auth-server
            clientId: this.oauthInfo.oauthClientId,
            oidc: false,
            // silentRefreshRedirectUri: this.oauthInfo.sceibaHost + 'oauth/token',
            // timeoutFactor: 0.75,
            sessionChecksEnabled: true,
            // set the scope for the permissions the client should request
            // The first three are defined by OIDC. The 4th is a usecase-specific one
            scope: this.oauthInfo.oauthScope,
        };
        this.oauthService.configure(authConfig);
        // Store user session in storage
        // this.oauthService.setStorage(this.oauthStorage);
        this.oauthService.tokenValidationHandler = new JwksValidationHandler();
        // Try to login and if a token was received, request user information
        this.oauthService.tryLogin({
            onTokenReceived: (/**
             * @param {?} _
             * @return {?}
             */
            function (_) {
                // gives information about user loggued
                _this.authenticationService.userInfoEndpoint = _this.oauthInfo.userInfoEndpoint;
                _this.authenticationService.getUserInfo().subscribe((/**
                 * @param {?} response
                 * @return {?}
                 */
                function (response) {
                    console.log(response);
                    _this.oauthStorage.setItem("user", JSON.stringify(response));
                    _this.authenticationService.login(response);
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                function (error) { return console.log(error); }), (/**
                 * @return {?}
                 */
                function () { }));
            }),
            onLoginError: (/**
             * @param {?} err
             * @return {?}
             */
            function (err) {
                console.log("error in login", err);
            }),
        });
    };
    /**
     * Starts the login flow
     */
    /**
     * Starts the login flow
     * @return {?}
     */
    AuthenticationComponent.prototype.login = /**
     * Starts the login flow
     * @return {?}
     */
    function () {
        var _this = this;
        this.oauthService.initImplicitFlow();
        // this.authenticationService.authBackend = this.authBackend
        // TODO: por que esto aqui, este modulo solo se encarga de la autenticacion y dar la informacion basica del usuario,
        // el perfil es manejado por otro componente
        this.user = new UserProfile();
        this.userProfileService.getUserInfo().subscribe({
            next: (/**
             * @param {?} response
             * @return {?}
             */
            function (response) {
                if (response && response.data && response.data.userprofile) {
                    _this.user.deepcopy(response.data.userprofile);
                    _this.oauthStorage.setItem("user", _this.user.entitystringify());
                }
            }),
            error: (/**
             * @param {?} err
             * @return {?}
             */
            function (err) {
                console.log(err);
            }),
            complete: (/**
             * @return {?}
             */
            function () { }),
        });
    };
    /**
     * Ends the login flow
     */
    /**
     * Ends the login flow
     * @return {?}
     */
    AuthenticationComponent.prototype.logoff = /**
     * Ends the login flow
     * @return {?}
     */
    function () {
        this.oauthService.logOut();
        this.authenticationService.logout();
    };
    Object.defineProperty(AuthenticationComponent.prototype, "name", {
        /**
         * Gives the user's email if the user is authenticated
         */
        get: /**
         * Gives the user's email if the user is authenticated
         * @return {?}
         */
        function () {
            if (this.oauthStorage.getItem("access_token")) {
                return this.oauthStorage.getItem("email");
            }
            else {
                return null;
            }
        },
        enumerable: true,
        configurable: true
    });
    AuthenticationComponent.decorators = [
        { type: Component, args: [{
                    selector: "toco-authentication",
                    template: "\n<div *ngIf=\"!isButtonLogin;else template_buttonLogin\" fxLayoutAlign=\"center center\" fxLayout=\"row\">\n    <mat-card fxLayoutAlign=\"center center\" fxLayout=\"column\">\n\n        <mat-card-header>\n            <mat-card-title *ngIf=\"!userName\">{{ 'TOCO_AUTHENTICATION.MAT_CARD_TITLE_AUTH' | translate }}</mat-card-title>\n        </mat-card-header>\n\n        <mat-card-content fxLayoutAlign=\"center center\" fxLayout=\"column\">\n            <button *ngIf=\"!userName;else templateName\" mat-raised-button color=\"primary\" style=\"width: 12em\" (click)=\"login()\">\n                <img src=\"https://sceiba-lab.upr.edu.cu/static/images/sceiba-logo-white.png\" alt=\"Sceiba\" width=\"100\" style=\"padding-top: .9em; padding-bottom: .9em\">\n            </button>\n\n            <ng-template #templateName>\n                <h1>{{ 'TOCO_AUTHENTICATION.H1_HOLA' | translate }} {{ userName }}</h1>\n                <button mat-raised-button color=\"primary\" style=\"width: 12em\" (click)=\"logoff()\">\n                    {{ 'TOCO_AUTHENTICATION.BUTTON_SALIR' | translate }}\n                </button>\n            </ng-template>\n\n        </mat-card-content>\n    </mat-card>\n</div>\n\n<ng-template #template_buttonLogin>\n    <button *ngIf=\"isButtonLoginIcon\" mat-icon-button (click)=\"login()\" matTooltip=\"{{ isButtonLoginText }}\">\n        <mat-icon>lock_open</mat-icon>\n    </button>\n    <button *ngIf=\"!isButtonLoginIcon\" mat-raised-button color=\"primary\" (click)=\"login()\">\n        {{ isButtonLoginText }}\n        <mat-icon class=\"mat-18\">lock_open</mat-icon>\n    </button>\n</ng-template>\n",
                    styles: [".card-width{width:25%;min-width:15em}"]
                }] }
    ];
    /** @nocollapse */
    AuthenticationComponent.ctorParameters = function () { return [
        { type: UserProfileService },
        { type: Environment },
        { type: Router },
        { type: OAuthService },
        { type: OAuthStorage },
        { type: OauthAuthenticationService },
        { type: TranslateService }
    ]; };
    AuthenticationComponent.propDecorators = {
        isButtonLogin: [{ type: Input }],
        isButtonLoginIcon: [{ type: Input }],
        isButtonLoginText: [{ type: Input }],
        oauthInfo: [{ type: Input }]
    };
    return AuthenticationComponent;
}());
export { AuthenticationComponent };
if (false) {
    /** @type {?} */
    AuthenticationComponent.prototype.isButtonLogin;
    /** @type {?} */
    AuthenticationComponent.prototype.isButtonLoginIcon;
    /** @type {?} */
    AuthenticationComponent.prototype.isButtonLoginText;
    /** @type {?} */
    AuthenticationComponent.prototype.oauthInfo;
    /** @type {?} */
    AuthenticationComponent.prototype.user;
    /** @type {?} */
    AuthenticationComponent.prototype.userName;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.timerAuthenticateSuscription;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.timerAuthenticateObserver;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.userProfileService;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.env;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.router;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.oauthService;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.oauthStorage;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype.authenticationService;
    /**
     * @type {?}
     * @private
     */
    AuthenticationComponent.prototype._transServ;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRpb24uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vdG9jby1saWIvIiwic291cmNlcyI6WyJsaWIvYXV0aGVudGljYXRpb24vYXV0aGVudGljYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFpQixTQUFTLEVBQUUsS0FBSyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQWlDLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQWMscUJBQXFCLEVBQUUsWUFBWSxFQUFDLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRW5HLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDckUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3hELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7O0FBR3RFLCtCQVdDOzs7SUFUQywrQkFBbUI7O0lBQ25CLDZCQUFpQjs7SUFDakIsa0NBQXNCOztJQUN0QixxQ0FBeUI7O0lBQ3pCLDRCQUFnQjs7SUFDaEIsNEJBQWdCOztJQUNoQixxQ0FBeUI7O0lBQ3pCLGtDQUFzQjs7SUFDdEIsK0JBQW1COzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQThCckI7SUFpREUsaUNBQ1Usa0JBQXNDLEVBQ3RDLEdBQWdCLEVBQ2hCLE1BQWMsRUFDZCxZQUEwQixFQUMxQixZQUEwQixFQUMxQixxQkFBaUQsRUFDakQsVUFBNEI7UUFQdEMsaUJBU0c7UUFSTyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FB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Q29udGVudCI6WyJcbmltcG9ydCB7IEFmdGVyVmlld0luaXQsIENvbXBvbmVudCwgSW5wdXQsIE9uSW5pdCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tIFwiQGFuZ3VsYXIvcm91dGVyXCI7XG5pbXBvcnQgeyBQYXJ0aWFsT2JzZXJ2ZXIsIFN1YnNjcmlwdGlvbiwgdGltZXIgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gXCJAbmd4LXRyYW5zbGF0ZS9jb3JlXCI7XG5pbXBvcnQgeyBBdXRoQ29uZmlnLCBKd2tzVmFsaWRhdGlvbkhhbmRsZXIsIE9BdXRoU2VydmljZSxPQXV0aFN0b3JhZ2UgfSBmcm9tIFwiYW5ndWxhci1vYXV0aDItb2lkY1wiO1xuXG5pbXBvcnQgeyBFbnZpcm9ubWVudCB9IGZyb20gXCIuLi9jb3JlL2VudlwiO1xuaW1wb3J0IHsgVXNlclByb2ZpbGVTZXJ2aWNlIH0gZnJvbSBcIi4uL2JhY2tlbmQvdXNlci1wcm9maWxlLnNlcnZpY2VcIjtcbmltcG9ydCB7IFVzZXJQcm9maWxlIH0gZnJvbSBcIi4uL2VudGl0aWVzL3BlcnNvbi5lbnRpdHlcIjtcbmltcG9ydCB7IE9hdXRoQXV0aGVudGljYXRpb25TZXJ2aWNlIH0gZnJvbSBcIi4vYXV0aGVudGljYXRpb24uc2VydmljZVwiO1xuLy8gaW1wb3J0IHsgYXV0aENvbmZpZyB9IGZyb20gJy4vYXV0aC1jb25maWcnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE9hdXRoSW5mb1xue1xuICBzZXJ2ZXJIb3N0OiBzdHJpbmc7XG4gIGxvZ2luVXJsOiBzdHJpbmc7XG4gIHRva2VuRW5kcG9pbnQ6IHN0cmluZztcbiAgdXNlckluZm9FbmRwb2ludDogc3RyaW5nLFxuICBhcHBIb3N0OiBzdHJpbmc7XG4gIGFwcE5hbWU6IHN0cmluZztcbiAgb2F1dGhSZWRpcmVjdFVyaTogc3RyaW5nO1xuICBvYXV0aENsaWVudElkOiBzdHJpbmc7XG4gIG9hdXRoU2NvcGU6IHN0cmluZztcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRzIGEgY29tcG9uZW50IHVzZWQgdG8gYXV0aGVudGljYXRlLiBcbiAqIFxuICogSW4gb3JkZXIgdG8gdXNlIHRoaXMgY29tcG9uZW50IHdpdGggdGhlIGNvcnJlY3QgaTE4biwgeW91IG11c3QgaW5jbHVkZSBcbiAqIChpbiB5b3VyIGkxOG4gdHJhbnNsYXRlIGZpbGVzIHRoYXQgYXJlIGluIHRoZSBmb2xkZXIgYGFzc2V0c1xcaTE4bmApIFxuICogYSB0cmFuc2xhdGlvbiBrZXkgb2YgbmFtZSBcIlRPQ09fQVVUSEVOVElDQVRJT05cIiB0aGF0IGNvbnRhaW5zIFxuICogYW4gb2JqZWN0IGFzIHZhbHVlIHdpdGggdGhlIHRyYW5zbGF0aW9uIG5lZWRlZCBieSB0aGlzIGNvbXBvbmVudC4gXG4gKiBcbiAqIEluIHRoZSBjYXNlIG9mIGBlcy5qc29uYCBmaWxlLCB5b3UgbXVzdCBpbmNsdWRlIHRoZSBmb2xsb3dpbmcgdHJhbnNsYXRpb24ga2V5OiBcbiAgICBcIlRPQ09fQVVUSEVOVElDQVRJT05cIjoge1xuICAgICAgICBcIk1BVF9DQVJEX1RJVExFX0FVVEhcIjogXCJBdXRlbnRpY2FjacOzbiBjb25cIixcbiAgICAgICAgXCJBVVRFTlRJQ0FSU0VcIjogXCJBdXRlbnRpY2Fyc2VcIixcbiAgICAgICAgXCJIMV9IT0xBXCI6IFwiSG9sYVwiLFxuICAgICAgICBcIkJVVFRPTl9TQUxJUlwiOiBcIlNhbGlyXCJcbiAgICB9XG4gKiBcbiAqIEluIHRoZSBjYXNlIG9mIGBlbi5qc29uYCBmaWxlLCB5b3UgbXVzdCBpbmNsdWRlIHRoZSBmb2xsb3dpbmcgdHJhbnNsYXRpb24ga2V5OiBcbiAgICBcIlRPQ09fQVVUSEVOVElDQVRJT05cIjoge1xuICAgICAgICBcIk1BVF9DQVJEX1RJVExFX0FVVEhcIjogXCJBdXRoZW50aWNhdGlvbiB3aXRoXCIsXG4gICAgICAgIFwiQVVURU5USUNBUlNFXCI6IFwiTG9nIGluXCIsXG4gICAgICAgIFwiSDFfSE9MQVwiOiBcIkhlbGxvLFwiLFxuICAgICAgICBcIkJVVFRPTl9TQUxJUlwiOiBcIkV4aXRcIlxuICAgIH1cbiAqIFxuICogSWYgeW91IGhhdmUgYW5vdGhlciBsYW5ndWFnZSwgdGhlbiB5b3UgaGF2ZSBhbm90aGVyIGAqLmpzb25gIGZpbGUsIFxuICogYW5kIHlvdSBtdXN0IGluY2x1ZGUgdGhlIFwiVE9DT19BVVRIRU5USUNBVElPTlwiIHRyYW5zbGF0aW9uIGtleSB3aXRoIHRoZSBjb3JyZWN0IHRyYW5zbGF0aW9uIHZhbHVlcy4gXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogXCJ0b2NvLWF1dGhlbnRpY2F0aW9uXCIsXG4gIHRlbXBsYXRlVXJsOiBcIi4vYXV0aGVudGljYXRpb24uY29tcG9uZW50Lmh0bWxcIixcbiAgc3R5bGVVcmxzOiBbXCIuL2F1dGhlbnRpY2F0aW9uLmNvbXBvbmVudC5zY3NzXCJdLFxufSlcbmV4cG9ydCBjbGFzcyBBdXRoZW50aWNhdGlvbkNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XG5cbiAgQElucHV0KClcbiAgcHVibGljIGlzQnV0dG9uTG9naW46IGJvb2xlYW47XG5cbiAgQElucHV0KClcbiAgcHVibGljIGlzQnV0dG9uTG9naW5JY29uOiBib29sZWFuO1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBpc0J1dHRvbkxvZ2luVGV4dDogc3RyaW5nO1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBvYXV0aEluZm86IE9hdXRoSW5mbztcblxuICBwdWJsaWMgdXNlcjogVXNlclByb2ZpbGU7XG5cbiAgcHVibGljIHVzZXJOYW1lOiBzdHJpbmc7XG4gIHByaXZhdGUgdGltZXJBdXRoZW50aWNhdGVTdXNjcmlwdGlvbjogU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgcHJpdmF0ZSB0aW1lckF1dGhlbnRpY2F0ZU9ic2VydmVyOiBQYXJ0aWFsT2JzZXJ2ZXI8bnVtYmVyPiA9IHtcbiAgICBuZXh0OiAoXykgPT4ge1xuICAgICAgLy8gY29uc29sZS5sb2coJ25leHQnKTtcbiAgICAgIC8vIHRoaXMub2F1dGhTZXJ2aWNlLnNldHVwQXV0b21hdGljU2lsZW50UmVmcmVzaCgpO1xuICAgICAgaWYgKHRoaXMub2F1dGhTdG9yYWdlLmdldEl0ZW0oXCJhY2Nlc3NfdG9rZW5cIikpIHtcbiAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0VXNlckluZm8oKS5zdWJzY3JpYmUoXG4gICAgICAgICAgKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm9hdXRoU3RvcmFnZS5zZXRJdGVtKFwidXNlclwiLCBKU09OLnN0cmluZ2lmeShyZXNwb25zZSkpO1xuICAgICAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UubG9naW4ocmVzcG9uc2UpO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3IgPT4gY29uc29sZS5sb2coZXJyb3IpLFxuICAgICAgICAgICgpID0+IHt9XG4gICAgICAgIClcbiAgICAgICAgLy8gdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UubG9nZ3VlZENoYW5nZSh0cnVlKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgZXJyb3I6IChlcnI6IGFueSkgPT4ge1xuICAgICAgY29uc29sZS5sb2coXCJUaGUgb2JzZXJ2YWJsZSBnb3QgYW4gZXJyb3Igbm90aWZpY2F0aW9uOiBcIiArIGVyciArIFwiLlwiKTtcbiAgICB9LFxuXG4gICAgY29tcGxldGU6ICgpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFwiVGhlIG9ic2VydmFibGUgZ290IGEgY29tcGxldGUgbm90aWZpY2F0aW9uLlwiKTtcbiAgICB9LFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdXNlclByb2ZpbGVTZXJ2aWNlOiBVc2VyUHJvZmlsZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBlbnY6IEVudmlyb25tZW50LFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSBvYXV0aFNlcnZpY2U6IE9BdXRoU2VydmljZSxcbiAgICBwcml2YXRlIG9hdXRoU3RvcmFnZTogT0F1dGhTdG9yYWdlLFxuICAgIHByaXZhdGUgYXV0aGVudGljYXRpb25TZXJ2aWNlOiBPYXV0aEF1dGhlbnRpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIF90cmFuc1NlcnY6IFRyYW5zbGF0ZVNlcnZpY2VcbiAgKVxuICB7IH1cblxuICBuZ09uSW5pdCgpXG4gIHtcbiAgICBpZiAodGhpcy5pc0J1dHRvbkxvZ2luID09IHVuZGVmaW5lZCkgdGhpcy5pc0J1dHRvbkxvZ2luID0gZmFsc2U7XG4gICAgaWYgKHRoaXMuaXNCdXR0b25Mb2dpbkljb24gPT0gdW5kZWZpbmVkKSB0aGlzLmlzQnV0dG9uTG9naW5JY29uID0gZmFsc2U7XG4gICAgaWYgKHRoaXMuaXNCdXR0b25Mb2dpblRleHQgPT0gdW5kZWZpbmVkKVxuICAgIHtcbiAgICAgIHRoaXMuX3RyYW5zU2Vydi5nZXQoJ1RPQ09fQVVUSEVOVElDQVRJT04uQVVURU5USUNBUlNFJykuc3Vic2NyaWJlKChyZXM6IHN0cmluZykgPT4ge1xuICAgICAgICB0aGlzLmlzQnV0dG9uTG9naW5UZXh0ID0gcmVzO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGlmICh0aGlzLm9hdXRoSW5mby5sb2dpblVybCA9PSB1bmRlZmluZWQgfHwgdGhpcy5vYXV0aEluZm8ubG9naW5VcmwgPT0gJycpe1xuICAgICAgdGhpcy5vYXV0aEluZm8ubG9naW5VcmwgPSB0aGlzLm9hdXRoSW5mby5zZXJ2ZXJIb3N0ICsgXCJvYXV0aC9hdXRob3JpemVcIjtcbiAgICB9XG4gICAgaWYgKHRoaXMub2F1dGhJbmZvLnRva2VuRW5kcG9pbnQgPT0gdW5kZWZpbmVkIHx8IHRoaXMub2F1dGhJbmZvLnRva2VuRW5kcG9pbnQgPT0gJycpe1xuICAgICAgdGhpcy5vYXV0aEluZm8udG9rZW5FbmRwb2ludCA9IHRoaXMub2F1dGhJbmZvLnNlcnZlckhvc3QgKyBcIm9hdXRoL3Rva2VuXCI7XG4gICAgfVxuICAgIHRoaXMuY29uZmlndXJlKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy50aW1lckF1dGhlbnRpY2F0ZVN1c2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnRpbWVyQXV0aGVudGljYXRlU3VzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgLy8gdGhpcyBvYnNlcnZhYmxlIGlzIHRvIHdhaXQgYSB3aGlsZSBmb3IgdGhlIGNvbXBvbmVudCB0byBmaW5pc2ggbG9hZGluZyxcbiAgICAvLyBiZWNhdXNlIG90aGVyd2lzZSBpdCBmYWlscyB0byBub3RpZnkgdGhhdCB0aGUgdXNlciBpcyBhdXRoZW50aWNhdGVkXG4gICAgdGhpcy50aW1lckF1dGhlbnRpY2F0ZVN1c2NyaXB0aW9uID0gdGltZXIoMCkuc3Vic2NyaWJlKFxuICAgICAgdGhpcy50aW1lckF1dGhlbnRpY2F0ZU9ic2VydmVyXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25maWd1cmF0aW9ucyB0byBhdXRoZW50aWNhdGVcbiAgICovXG4gIHByaXZhdGUgY29uZmlndXJlKCkge1xuICAgIGNvbnN0IGF1dGhDb25maWc6IEF1dGhDb25maWcgPSB7XG4gICAgICAvLyBVcmwgb2YgdGhlIElkZW50aXR5IFByb3ZpZGVyXG4gICAgICAvL2lzc3VlcjogJ2h0dHBzOi8vc2NlaWJhLWxhYi51cHIuZWR1LmN1JyxcblxuICAgICAgbG9naW5Vcmw6IHRoaXMub2F1dGhJbmZvLmxvZ2luVXJsLFxuXG4gICAgICB0b2tlbkVuZHBvaW50OiB0aGlzLm9hdXRoSW5mby50b2tlbkVuZHBvaW50LFxuXG4gICAgICAvLyBVUkwgb2YgdGhlIFNQQSB0byByZWRpcmVjdCB0aGUgdXNlciB0byBhZnRlciBsb2dpblxuICAgICAgcmVkaXJlY3RVcmk6IHRoaXMub2F1dGhJbmZvLm9hdXRoUmVkaXJlY3RVcmksXG5cbiAgICAgIC8vIFRoZSBTUEEncyBpZC4gVGhlIFNQQSBpcyByZWdpc3RlcmVkIHdpdGggdGhpcyBpZCBhdCB0aGUgYXV0aC1zZXJ2ZXJcbiAgICAgIGNsaWVudElkOiB0aGlzLm9hdXRoSW5mby5vYXV0aENsaWVudElkLFxuXG4gICAgICBvaWRjOiBmYWxzZSxcblxuICAgICAgLy8gc2lsZW50UmVmcmVzaFJlZGlyZWN0VXJpOiB0aGlzLm9hdXRoSW5mby5zY2VpYmFIb3N0ICsgJ29hdXRoL3Rva2VuJyxcblxuICAgICAgLy8gdGltZW91dEZhY3RvcjogMC43NSxcblxuICAgICAgc2Vzc2lvbkNoZWNrc0VuYWJsZWQ6IHRydWUsXG4gICAgICAvLyBzZXQgdGhlIHNjb3BlIGZvciB0aGUgcGVybWlzc2lvbnMgdGhlIGNsaWVudCBzaG91bGQgcmVxdWVzdFxuICAgICAgLy8gVGhlIGZpcnN0IHRocmVlIGFyZSBkZWZpbmVkIGJ5IE9JREMuIFRoZSA0dGggaXMgYSB1c2VjYXNlLXNwZWNpZmljIG9uZVxuICAgICAgc2NvcGU6IHRoaXMub2F1dGhJbmZvLm9hdXRoU2NvcGUsIC8vJ29wZW5pZCBwcm9maWxlIGVtYWlsIHZvdWNoZXInLFxuICAgIH07XG4gICAgdGhpcy5vYXV0aFNlcnZpY2UuY29uZmlndXJlKGF1dGhDb25maWcpO1xuXG4gICAgLy8gU3RvcmUgdXNlciBzZXNzaW9uIGluIHN0b3JhZ2VcbiAgICAvLyB0aGlzLm9hdXRoU2VydmljZS5zZXRTdG9yYWdlKHRoaXMub2F1dGhTdG9yYWdlKTtcblxuICAgIHRoaXMub2F1dGhTZXJ2aWNlLnRva2VuVmFsaWRhdGlvbkhhbmRsZXIgPSBuZXcgSndrc1ZhbGlkYXRpb25IYW5kbGVyKCk7XG5cbiAgICAvLyBUcnkgdG8gbG9naW4gYW5kIGlmIGEgdG9rZW4gd2FzIHJlY2VpdmVkLCByZXF1ZXN0IHVzZXIgaW5mb3JtYXRpb25cbiAgICB0aGlzLm9hdXRoU2VydmljZS50cnlMb2dpbih7XG4gICAgICBvblRva2VuUmVjZWl2ZWQ6IChfKSA9PiB7XG4gICAgICAgIC8vIGdpdmVzIGluZm9ybWF0aW9uIGFib3V0IHVzZXIgbG9nZ3VlZFxuICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uU2VydmljZS51c2VySW5mb0VuZHBvaW50ID0gdGhpcy5vYXV0aEluZm8udXNlckluZm9FbmRwb2ludDtcbiAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0VXNlckluZm8oKS5zdWJzY3JpYmUoXG5cbiAgICAgICAgICAgIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7XG4gICAgICAgICAgICAgIFxuICAgICAgICAgICAgICB0aGlzLm9hdXRoU3RvcmFnZS5zZXRJdGVtKFwidXNlclwiLCBKU09OLnN0cmluZ2lmeShyZXNwb25zZSkpO1xuICAgICAgICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uU2VydmljZS5sb2dpbihyZXNwb25zZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3IgPT4gY29uc29sZS5sb2coZXJyb3IpLFxuICAgICAgICAgICAgKCkgPT4ge31cblxuXG4gICAgICAgICAgLy8gKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgLy8gdGhpcy5vYXV0aFN0b3JhZ2Uuc2V0SXRlbShcInVzZXJcIiwgSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICAgICAgICAvLyAvLyAvLyBzYXZlIGVtYWlsIGluIHN0b3JhZ2VcbiAgICAgICAgICAvLyAvLyBpZiAodGhpcy5hdXRoQmFja2VuZCA9PSBBdXRoQmFja2VuZC5jdW9yKXtcbiAgICAgICAgICAvLyAvLyAgIHRoaXMub2F1dGhTdG9yYWdlLnNldEl0ZW0oXCJlbWFpbFwiLCByZXNwb25zZS5lbWFpbCk7XG4gICAgICAgICAgLy8gLy8gfWVsc2V7XG4gICAgICAgICAgLy8gLy8gICB0aGlzLm9hdXRoU3RvcmFnZS5zZXRJdGVtKFwiZW1haWxcIiwgcmVzcG9uc2UuZGF0YS51c2VycHJvZmlsZS51c2VyLmVtYWlsKTtcbiAgICAgICAgICAvLyAvLyB9XG4gICAgICAgICAgLy8gLy8gdGhpcy5vYXV0aFN0b3JhZ2Uuc2V0SXRlbSgndXNlcklEJywgcmVzcG9uc2UuZGF0YS51c2VycHJvZmlsZS5pZCk7XG5cbiAgICAgICAgICAvLyAvLyBub3RpZmllcyB1c2VyIGlzIGxvZ2dlZFxuICAgICAgICAgIC8vIHRoaXMuYXV0aGVudGljYXRpb25TZXJ2aWNlLmxvZ2d1ZWRDaGFuZ2UodHJ1ZSk7XG5cbiAgICAgICAgICAvLyB0aGlzLnVzZXJOYW1lID0gdGhpcy5vYXV0aFN0b3JhZ2UuZ2V0SXRlbShcImVtYWlsXCIpO1xuXG4gICAgICAgIC8vIH1cbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgICBvbkxvZ2luRXJyb3I6IChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coXCJlcnJvciBpbiBsb2dpblwiLCBlcnIpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydHMgdGhlIGxvZ2luIGZsb3dcbiAgICovXG4gIHB1YmxpYyBsb2dpbigpIHtcbiAgICB0aGlzLm9hdXRoU2VydmljZS5pbml0SW1wbGljaXRGbG93KCk7XG4gICAgLy8gdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aEJhY2tlbmQgPSB0aGlzLmF1dGhCYWNrZW5kXG4gICAgLy8gVE9ETzogcG9yIHF1ZSBlc3RvIGFxdWksIGVzdGUgbW9kdWxvIHNvbG8gc2UgZW5jYXJnYSBkZSBsYSBhdXRlbnRpY2FjaW9uIHkgZGFyIGxhIGluZm9ybWFjaW9uIGJhc2ljYSBkZWwgdXN1YXJpbyxcbiAgICAvLyBlbCBwZXJmaWwgZXMgbWFuZWphZG8gcG9yIG90cm8gY29tcG9uZW50ZVxuICAgIHRoaXMudXNlciA9IG5ldyBVc2VyUHJvZmlsZSgpO1xuICAgIHRoaXMudXNlclByb2ZpbGVTZXJ2aWNlLmdldFVzZXJJbmZvKCkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6IChyZXNwb25zZSkgPT4ge1xuICAgICAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2UuZGF0YSAmJiByZXNwb25zZS5kYXRhLnVzZXJwcm9maWxlKSB7XG4gICAgICAgICAgdGhpcy51c2VyLmRlZXBjb3B5KHJlc3BvbnNlLmRhdGEudXNlcnByb2ZpbGUpO1xuICAgICAgICAgIHRoaXMub2F1dGhTdG9yYWdlLnNldEl0ZW0oXCJ1c2VyXCIsIHRoaXMudXNlci5lbnRpdHlzdHJpbmdpZnkoKSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBlcnJvcjogKGVycikgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgfSxcbiAgICAgIGNvbXBsZXRlOiAoKSA9PiB7fSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbmRzIHRoZSBsb2dpbiBmbG93XG4gICAqL1xuICBwdWJsaWMgbG9nb2ZmKCkge1xuICAgIHRoaXMub2F1dGhTZXJ2aWNlLmxvZ091dCgpO1xuICAgIHRoaXMuYXV0aGVudGljYXRpb25TZXJ2aWNlLmxvZ291dCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdpdmVzIHRoZSB1c2VyJ3MgZW1haWwgaWYgdGhlIHVzZXIgaXMgYXV0aGVudGljYXRlZFxuICAgKi9cbiAgcHVibGljIGdldCBuYW1lKCkge1xuICAgIGlmICh0aGlzLm9hdXRoU3RvcmFnZS5nZXRJdGVtKFwiYWNjZXNzX3Rva2VuXCIpKSB7XG4gICAgICByZXR1cm4gdGhpcy5vYXV0aFN0b3JhZ2UuZ2V0SXRlbShcImVtYWlsXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==