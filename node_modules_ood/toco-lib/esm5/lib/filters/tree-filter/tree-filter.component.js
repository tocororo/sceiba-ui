/**
 * @fileoverview added by tsickle
 * Generated from: lib/filters/tree-filter/tree-filter.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*
 *   Copyright (c) 2020 Universidad de Pinar del Río "Hermanos Saíz Montes de Oca"
 *   All rights reserved.
 */
import { Component, Input } from '@angular/core';
import { FiltersService } from '../filters.service';
import { FilterContainerService } from '../filter-container.service';
import { FlatTreeControl } from '@angular/cdk/tree';
import { MatTreeFlattener, MatTreeFlatDataSource } from '@angular/material';
import { of } from 'rxjs';
import { SelectionModel } from '@angular/cdk/collections';
import { FormControl } from '@angular/forms';
/**
 * @record
 */
export function FlatTreeNodeFilter() { }
if (false) {
    /** @type {?} */
    FlatTreeNodeFilter.prototype.name;
    /** @type {?} */
    FlatTreeNodeFilter.prototype.level;
    /** @type {?} */
    FlatTreeNodeFilter.prototype.expandable;
    /** @type {?} */
    FlatTreeNodeFilter.prototype.term;
}
/**
 * @record
 */
function TreeFilterData() { }
if (false) {
    /** @type {?} */
    TreeFilterData.prototype.selectOptions;
    /** @type {?} */
    TreeFilterData.prototype.type;
    /** @type {?} */
    TreeFilterData.prototype.placeholder;
    /** @type {?} */
    TreeFilterData.prototype.text;
    /** @type {?} */
    TreeFilterData.prototype.field;
    /** @type {?} */
    TreeFilterData.prototype.index;
    /** @type {?} */
    TreeFilterData.prototype.value;
    /** @type {?} */
    TreeFilterData.prototype.idVocab;
}
var TreeFilterComponent = /** @class */ (function () {
    function TreeFilterComponent(filterService, filterContainerService) {
        this.filterService = filterService;
        this.filterContainerService = filterContainerService;
        this.checklistSelection = new SelectionModel(true /* multiple */);
        this.myControl = new FormControl();
        this.treeFlattener = new MatTreeFlattener(this.transformer, this.getLevel, this.isExpandable, this.getChildren);
        this.treeControl = new FlatTreeControl(this.getLevel, this.isExpandable);
        this.dataSource = new MatTreeFlatDataSource(this.treeControl, this.treeFlattener);
    }
    /**
     * @return {?}
     */
    TreeFilterComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.data.value = '';
        this.dataSource.data = this.data.selectOptions;
        this.myControl.valueChanges.subscribe((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            _this._filter(value);
        }), (/**
         * @param {?} error
         * @return {?}
         */
        function (error) { }), (/**
         * @return {?}
         */
        function () {
        }));
        this.inputId = this.data.placeholder.trim().toLowerCase();
    };
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    TreeFilterComponent.prototype._filter = /**
     * @private
     * @param {?} value
     * @return {?}
     */
    function (value) {
        var _this = this;
        /** @type {?} */
        var filterValue = value.toLowerCase();
        console.log(filterValue);
        /** @type {?} */
        var newData = this.data.selectOptions.filter((/**
         * @param {?} node
         * @return {?}
         */
        function (node) { return _this._include_node(filterValue, node); }));
        this.dataSource.data = newData;
        this._fix_selection();
    };
    /** return true if any children is include, false otherwise */
    /**
     * return true if any children is include, false otherwise
     * @private
     * @param {?} filter
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype._include_node = /**
     * return true if any children is include, false otherwise
     * @private
     * @param {?} filter
     * @param {?} node
     * @return {?}
     */
    function (filter, node) {
        var e_1, _a;
        if (node.term.identifier.toLowerCase().includes(filter)) {
            return true;
        }
        else if (node.children) {
            try {
                for (var _b = tslib_1.__values(node.children), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var child = _c.value;
                    if (this._include_node(filter, child)) {
                        return true;
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        else {
            return false;
        }
        return false;
    };
    /**
     * @private
     * @return {?}
     */
    TreeFilterComponent.prototype._fix_selection = /**
     * @private
     * @return {?}
     */
    function () {
        var e_2, _a;
        try {
            for (var _b = tslib_1.__values(this.treeControl.dataNodes), _c = _b.next(); !_c.done; _c = _b.next()) {
                var node = _c.value;
                console.log(node);
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_2) throw e_2.error; }
        }
        // if (this.checklistSelection.selected) {
        //   const old = this.checklistSelection.selected.find(
        //     (value: FlatTreeNode, index: number, obj: FlatTreeNode[]) => value.term.id === node.term.id
        //   );
        //   if (old !== undefined) {
        //     this.checklistSelection.deselect(old);
        //     this.checklistSelection.select(result);
        //   }
        // }
    };
    /**
     * @return {?}
     */
    TreeFilterComponent.prototype.remove_component = /**
     * @return {?}
     */
    function () {
        this.filterService.deleteParameter(this.data.field);
        this.filterContainerService.filterDeleted(this.data.index);
    };
    /**
     * @return {?}
     */
    TreeFilterComponent.prototype.onChange = /**
     * @return {?}
     */
    function () {
        this.filterService.changeFilter(this.data.field, this.data.value);
    };
    /**
     * @return {?}
     */
    TreeFilterComponent.prototype.emitSelection = /**
     * @return {?}
     */
    function () {
        console.log(this.checklistSelection.selected);
        /** @type {?} */
        var valueEmiter = 'OR';
        this.checklistSelection.selected.forEach((/**
         * @param {?} node
         * @return {?}
         */
        function (node) {
            valueEmiter = valueEmiter + ',' + node.term.id;
        }));
        this.filterService.changeAutocompleteFilter(this.data.idVocab.toString(10), valueEmiter);
    };
    /** Transform the data to something the tree can read. */
    /**
     * Transform the data to something the tree can read.
     * @param {?} node
     * @param {?} level
     * @return {?}
     */
    TreeFilterComponent.prototype.transformer = /**
     * Transform the data to something the tree can read.
     * @param {?} node
     * @param {?} level
     * @return {?}
     */
    function (node, level) {
        /** @type {?} */
        var result = {
            name: node.term.identifier,
            level: level,
            expandable: (node.children.length > 0),
            term: node.term,
        };
        return result;
    };
    /** Get the level of the node */
    /**
     * Get the level of the node
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.getLevel = /**
     * Get the level of the node
     * @param {?} node
     * @return {?}
     */
    function (node) {
        return node.level;
    };
    /** Get whether the node is expanded or not. */
    /**
     * Get whether the node is expanded or not.
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.isExpandable = /**
     * Get whether the node is expanded or not.
     * @param {?} node
     * @return {?}
     */
    function (node) {
        return node.expandable;
    };
    /** Get whether the node has children or not. */
    /**
     * Get whether the node has children or not.
     * @param {?} index
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.hasChild = /**
     * Get whether the node has children or not.
     * @param {?} index
     * @param {?} node
     * @return {?}
     */
    function (index, node) {
        return node.expandable;
    };
    /** Get the children for the node. */
    /**
     * Get the children for the node.
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.getChildren = /**
     * Get the children for the node.
     * @param {?} node
     * @return {?}
     */
    function (node) {
        return of(node.children);
    };
    /** Whether all the descendants of the node are selected. */
    /**
     * Whether all the descendants of the node are selected.
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.descendantsAllSelected = /**
     * Whether all the descendants of the node are selected.
     * @param {?} node
     * @return {?}
     */
    function (node) {
        var _this = this;
        /** @type {?} */
        var descendants = this.treeControl.getDescendants(node);
        /** @type {?} */
        var descAllSelected = descendants.every((/**
         * @param {?} child
         * @return {?}
         */
        function (child) {
            return _this.checklistSelection.isSelected(child);
        }));
        return descAllSelected;
    };
    /** Whether part of the descendants are selected */
    /**
     * Whether part of the descendants are selected
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.descendantsPartiallySelected = /**
     * Whether part of the descendants are selected
     * @param {?} node
     * @return {?}
     */
    function (node) {
        var _this = this;
        /** @type {?} */
        var descendants = this.treeControl.getDescendants(node);
        /** @type {?} */
        var result = descendants.some((/**
         * @param {?} child
         * @return {?}
         */
        function (child) { return _this.checklistSelection.isSelected(child); }));
        return result && !this.descendantsAllSelected(node);
    };
    /** Select/deselect all the descendants node */
    /**
     * Select/deselect all the descendants node
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.itemSelectionToggle = /**
     * Select/deselect all the descendants node
     * @param {?} node
     * @return {?}
     */
    function (node) {
        var _a, _b;
        var _this = this;
        this.checklistSelection.toggle(node);
        /** @type {?} */
        var descendants = this.treeControl.getDescendants(node);
        this.checklistSelection.isSelected(node)
            ? (_a = this.checklistSelection).select.apply(_a, tslib_1.__spread(descendants)) : (_b = this.checklistSelection).deselect.apply(_b, tslib_1.__spread(descendants));
        // Force update for the parent
        descendants.every((/**
         * @param {?} child
         * @return {?}
         */
        function (child) {
            return _this.checklistSelection.isSelected(child);
        }));
        this.checkAllParentsSelection(node);
        this.emitSelection();
    };
    /** Check all the parents to see if they changed */
    /**
     * Check all the parents to see if they changed
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.leafItemSelectionToggle = /**
     * Check all the parents to see if they changed
     * @param {?} node
     * @return {?}
     */
    function (node) {
        this.checklistSelection.toggle(node);
        this.checkAllParentsSelection(node);
        this.emitSelection();
    };
    /* Checks all the parents when a leaf node is selected/unselected */
    /* Checks all the parents when a leaf node is selected/unselected */
    /**
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.checkAllParentsSelection = /* Checks all the parents when a leaf node is selected/unselected */
    /**
     * @param {?} node
     * @return {?}
     */
    function (node) {
        /** @type {?} */
        var parent = this.getParentNode(node);
        while (parent) {
            this.checkRootNodeSelection(parent);
            parent = this.getParentNode(parent);
        }
    };
    /** Check root node checked state and change it accordingly */
    /**
     * Check root node checked state and change it accordingly
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.checkRootNodeSelection = /**
     * Check root node checked state and change it accordingly
     * @param {?} node
     * @return {?}
     */
    function (node) {
        var _this = this;
        /** @type {?} */
        var nodeSelected = this.checklistSelection.isSelected(node);
        /** @type {?} */
        var descendants = this.treeControl.getDescendants(node);
        /** @type {?} */
        var descAllSelected = descendants.every((/**
         * @param {?} child
         * @return {?}
         */
        function (child) {
            return _this.checklistSelection.isSelected(child);
        }));
        if (nodeSelected && !descAllSelected) {
            this.checklistSelection.deselect(node);
        }
        else if (!nodeSelected && descAllSelected) {
            this.checklistSelection.select(node);
        }
    };
    /* Get the parent node of a node */
    /* Get the parent node of a node */
    /**
     * @param {?} node
     * @return {?}
     */
    TreeFilterComponent.prototype.getParentNode = /* Get the parent node of a node */
    /**
     * @param {?} node
     * @return {?}
     */
    function (node) {
        /** @type {?} */
        var currentLevel = this.getLevel(node);
        if (currentLevel < 1) {
            return null;
        }
        /** @type {?} */
        var startIndex = this.treeControl.dataNodes.indexOf(node) - 1;
        for (var i = startIndex; i >= 0; i--) {
            /** @type {?} */
            var currentNode = this.treeControl.dataNodes[i];
            if (this.getLevel(currentNode) < currentLevel) {
                return currentNode;
            }
        }
        return null;
    };
    /**
     * @param {?} i
     * @return {?}
     */
    TreeFilterComponent.prototype.removeChip = /**
     * @param {?} i
     * @return {?}
     */
    function (i) {
        console.log(i);
    };
    TreeFilterComponent.decorators = [
        { type: Component, args: [{
                    selector: 'toco-tree-filter',
                    template: "<div class=\"card-filter\">\n  <input\n    type=\"text\"\n    placeholder=\"{{ data.placeholder }}\"\n    aria-label=\"Number\"\n    matInput\n    [formControl]=\"myControl\"\n    id=\"{{ inputId }}\"\n  />\n\n  <mat-tree [dataSource]=\"dataSource\" [treeControl]=\"treeControl\" class=\"padd\">\n    <mat-tree-node\n      class=\"hover\"\n      *matTreeNodeDef=\"let node\"\n      matTreeNodeToggle\n      matTreeNodePadding\n      fxLayout=\"row\"\n      fxLayoutAlign=\"space-between center\"\n    >\n      <div fxLayout=\"row\" fxLayoutAlign=\"start center\">\n        <button mat-icon-button disabled></button>\n        <mat-checkbox\n          class=\"checklist-leaf-node\"\n          [checked]=\"checklistSelection.isSelected(node)\"\n          (change)=\"leafItemSelectionToggle(node)\"\n          matTooltip=\"{{ node.name }}\"\n          >{{ node.name }}</mat-checkbox\n        >\n      </div>\n    </mat-tree-node>\n\n    <mat-tree-node\n      class=\"hover\"\n      *matTreeNodeDef=\"let node; when: hasChild\"\n      matTreeNodePadding\n    >\n      <button\n        mat-icon-button\n        matTreeNodeToggle\n        [attr.aria-label]=\"'toggle ' + node.name\"\n      >\n        <mat-icon class=\"mat-icon-rtl-mirror\">\n          {{ treeControl.isExpanded(node) ? \"expand_more\" : \"chevron_right\" }}\n        </mat-icon>\n      </button>\n      <div\n        class=\"item-width\"\n        fxLayout=\"row\"\n        fxLayoutAlign=\"space-between center\"\n      >\n        <mat-checkbox\n          [checked]=\"descendantsAllSelected(node)\"\n          [indeterminate]=\"descendantsPartiallySelected(node)\"\n          (change)=\"itemSelectionToggle(node)\"\n          matTooltip=\"{{ node.name }}\"\n          >{{ node.name }}</mat-checkbox\n        >\n      </div>\n    </mat-tree-node>\n  </mat-tree>\n\n  <button\n    mat-icon-button\n    color=\"accent\"\n    class=\"delete-filter\"\n    (click)=\"remove_component()\"\n  >\n    <mat-icon>close</mat-icon>\n  </button>\n\n  <mat-chip-list\n    fxLayout=\"row\"\n    fxLayoutAlign=\"start center\"\n    style=\"margin-bottom: .5em\"\n    id=\"chiplist\"\n  >\n    <mat-chip\n      *ngFor=\"let item of chipsList; let i = index\"\n      (click)=\"removeChip(i)\"\n      >{{ item.name }}</mat-chip\n    >\n  </mat-chip-list>\n</div>\n",
                    styles: [".card-filter{border:2px solid #e4e4e4;border-radius:5px;padding:5px .5em 0;position:relative;box-shadow:2px 3px 10px RGB(0,0,0,.053);width:15em;margin:.4em 0}.delete-filter{position:absolute;top:-1.9em;right:-1.4em;width:2em;height:2em}.delete-filter mat-icon{font-size:medium}"]
                }] }
    ];
    /** @nocollapse */
    TreeFilterComponent.ctorParameters = function () { return [
        { type: FiltersService },
        { type: FilterContainerService }
    ]; };
    TreeFilterComponent.propDecorators = {
        data: [{ type: Input }]
    };
    return TreeFilterComponent;
}());
export { TreeFilterComponent };
if (false) {
    /** @type {?} */
    TreeFilterComponent.prototype.data;
    /** @type {?} */
    TreeFilterComponent.prototype.chipsList;
    /** @type {?} */
    TreeFilterComponent.prototype.treeControl;
    /** @type {?} */
    TreeFilterComponent.prototype.treeFlattener;
    /** @type {?} */
    TreeFilterComponent.prototype.dataSource;
    /** @type {?} */
    TreeFilterComponent.prototype.checklistSelection;
    /** @type {?} */
    TreeFilterComponent.prototype.myControl;
    /** @type {?} */
    TreeFilterComponent.prototype.inputId;
    /**
     * @type {?}
     * @private
     */
    TreeFilterComponent.prototype.filterService;
    /**
     * @type {?}
     * @private
     */
    TreeFilterComponent.prototype.filterContainerService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS1maWx0ZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vdG9jby1saWIvIiwic291cmNlcyI6WyJsaWIvZmlsdGVycy90cmVlLWZpbHRlci90cmVlLWZpbHRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQU1BLE9BQU8sRUFBRSxTQUFTLEVBQVUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR3pELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUVyRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLHFCQUFxQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDNUUsT0FBTyxFQUFFLEVBQUUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQUUsY0FBYyxFQUFvQixNQUFNLDBCQUEwQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUc3Qyx3Q0FLQzs7O0lBSkMsa0NBQWE7O0lBQ2IsbUNBQWM7O0lBQ2Qsd0NBQW9COztJQUNwQixrQ0FBVzs7Ozs7QUFFYiw2QkFTQzs7O0lBUkMsdUNBQTBCOztJQUMxQiw4QkFBYTs7SUFDYixxQ0FBb0I7O0lBQ3BCLDhCQUFhOztJQUNiLCtCQUFjOztJQUNkLCtCQUFjOztJQUNkLCtCQUFXOztJQUNYLGlDQUFnQjs7QUFHbEI7SUFtQkUsNkJBQ1UsYUFBNkIsRUFDN0Isc0JBQThDO1FBRDlDLGtCQUFhLEdBQWIsYUFBYSxDQUFnQjtRQUM3QiwyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBUnhELHVCQUFrQixHQUFHLElBQUksY0FBYyxDQUFxQixJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFakYsY0FBUyxHQUFHLElBQUks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O1lBRUssVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBRS9ELEtBQUssSUFBSSxDQUFDLEdBQUcsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7O2dCQUM5QixXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBRWpELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsR0FBRyxZQUFZLEVBQUU7Z0JBQzdDLE9BQU8sV0FBVyxDQUFDO2FBQ3BCO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Ozs7O0lBQ0Qsd0NBQVU7Ozs7SUFBVixVQUFXLENBQUM7UUFDVixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pCLENBQUM7O2dCQTVORixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLGtCQUFrQjtvQkFDNUIsNHdFQUEyQzs7aUJBRTVDOzs7O2dCQS9CUSxjQUFjO2dCQUNkLHNCQUFzQjs7O3VCQWdDNUIsS0FBSzs7SUF1TlIsMEJBQUM7Q0FBQSxBQTdORCxJQTZOQztTQXhOWSxtQkFBbUI7OztJQUM5QixtQ0FBOEI7O0lBRTlCLHdDQUFjOztJQUVkLDBDQUFpRDs7SUFDakQsNENBQThEOztJQUM5RCx5Q0FBZ0U7O0lBQ2hFLGlEQUFpRjs7SUFFakYsd0NBQThCOztJQUU5QixzQ0FBZ0I7Ozs7O0lBR2QsNENBQXFDOzs7OztJQUNyQyxxREFBc0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogICBDb3B5cmlnaHQgKGMpIDIwMjAgVW5pdmVyc2lkYWQgZGUgUGluYXIgZGVsIFLDrW8gXCJIZXJtYW5vcyBTYcOteiBNb250ZXMgZGUgT2NhXCJcbiAqICAgQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqL1xuXG5cbmltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBJbnB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBGaWx0ZXJDb21wb25lbnQgfSBmcm9tICcuLi9maWx0ZXIuY29tcG9uZW50JztcbmltcG9ydCB7IEZpbHRlcnNTZXJ2aWNlIH0gZnJvbSAnLi4vZmlsdGVycy5zZXJ2aWNlJztcbmltcG9ydCB7IEZpbHRlckNvbnRhaW5lclNlcnZpY2UgfSBmcm9tICcuLi9maWx0ZXItY29udGFpbmVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgVGVybU5vZGUsIFRlcm0gfSBmcm9tICcuLi8uLi9lbnRpdGllcy9wdWJsaWMtYXBpJztcbmltcG9ydCB7IEZsYXRUcmVlQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay90cmVlJztcbmltcG9ydCB7IE1hdFRyZWVGbGF0dGVuZXIsIE1hdFRyZWVGbGF0RGF0YVNvdXJjZSB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsJztcbmltcG9ydCB7IG9mLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBTZWxlY3Rpb25Nb2RlbCwgQ29sbGVjdGlvblZpZXdlciB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2xsZWN0aW9ucyc7XG5pbXBvcnQgeyBGb3JtQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IHN0YXJ0V2l0aCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEZsYXRUcmVlTm9kZUZpbHRlciB7XG4gIG5hbWU6IHN0cmluZztcbiAgbGV2ZWw6IG51bWJlcjtcbiAgZXhwYW5kYWJsZTogYm9vbGVhbjtcbiAgdGVybTogVGVybTtcbn1cbmludGVyZmFjZSBUcmVlRmlsdGVyRGF0YSB7XG4gIHNlbGVjdE9wdGlvbnM6IFRlcm1Ob2RlW107XG4gIHR5cGU6IHN0cmluZztcbiAgcGxhY2Vob2xkZXI6IHN0cmluZztcbiAgdGV4dDogc3RyaW5nO1xuICBmaWVsZDogc3RyaW5nO1xuICBpbmRleDogbnVtYmVyO1xuICB2YWx1ZTogYW55O1xuICBpZFZvY2FiOiBudW1iZXI7XG59XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3RvY28tdHJlZS1maWx0ZXInLFxuICB0ZW1wbGF0ZVVybDogJy4vdHJlZS1maWx0ZXIuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi90cmVlLWZpbHRlci5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIFRyZWVGaWx0ZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEZpbHRlckNvbXBvbmVudCB7XG4gIEBJbnB1dCgpIGRhdGE6IFRyZWVGaWx0ZXJEYXRhO1xuXG4gIGNoaXBzTGlzdDogW107XG5cbiAgdHJlZUNvbnRyb2w6IEZsYXRUcmVlQ29udHJvbDxGbGF0VHJlZU5vZGVGaWx0ZXI+O1xuICB0cmVlRmxhdHRlbmVyOiBNYXRUcmVlRmxhdHRlbmVyPFRlcm1Ob2RlLCBGbGF0VHJlZU5vZGVGaWx0ZXI+O1xuICBkYXRhU291cmNlOiBNYXRUcmVlRmxhdERhdGFTb3VyY2U8VGVybU5vZGUsIEZsYXRUcmVlTm9kZUZpbHRlcj47XG4gIGNoZWNrbGlzdFNlbGVjdGlvbiA9IG5ldyBTZWxlY3Rpb25Nb2RlbDxGbGF0VHJlZU5vZGVGaWx0ZXI+KHRydWUgLyogbXVsdGlwbGUgKi8pO1xuXG4gIG15Q29udHJvbCA9IG5ldyBGb3JtQ29udHJvbCgpO1xuXG4gIGlucHV0SWQ6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGZpbHRlclNlcnZpY2U6IEZpbHRlcnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgZmlsdGVyQ29udGFpbmVyU2VydmljZTogRmlsdGVyQ29udGFpbmVyU2VydmljZSkge1xuICAgIHRoaXMudHJlZUZsYXR0ZW5lciA9IG5ldyBNYXRUcmVlRmxhdHRlbmVyKFxuICAgICAgdGhpcy50cmFuc2Zvcm1lcixcbiAgICAgIHRoaXMuZ2V0TGV2ZWwsXG4gICAgICB0aGlzLmlzRXhwYW5kYWJsZSxcbiAgICAgIHRoaXMuZ2V0Q2hpbGRyZW4pO1xuXG4gICAgdGhpcy50cmVlQ29udHJvbCA9IG5ldyBGbGF0VHJlZUNvbnRyb2wodGhpcy5nZXRMZXZlbCwgdGhpcy5pc0V4cGFuZGFibGUpO1xuICAgIHRoaXMuZGF0YVNvdXJjZSA9IG5ldyBNYXRUcmVlRmxhdERhdGFTb3VyY2UodGhpcy50cmVlQ29udHJvbCwgdGhpcy50cmVlRmxhdHRlbmVyKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuZGF0YS52YWx1ZSA9ICcnO1xuICAgIHRoaXMuZGF0YVNvdXJjZS5kYXRhID0gdGhpcy5kYXRhLnNlbGVjdE9wdGlvbnM7XG4gICAgdGhpcy5teUNvbnRyb2wudmFsdWVDaGFuZ2VzLnN1YnNjcmliZShcbiAgICAgICh2YWx1ZTogYW55KSA9PiB7XG4gICAgICAgIHRoaXMuX2ZpbHRlcih2YWx1ZSk7XG4gICAgICB9LFxuICAgICAgKGVycm9yOiBhbnkpID0+IHsgfSxcbiAgICAgICgpID0+IHtcbiAgICAgIH1cbiAgICApO1xuICAgIHRoaXMuaW5wdXRJZCA9IHRoaXMuZGF0YS5wbGFjZWhvbGRlci50cmltKCkudG9Mb3dlckNhc2UoKTtcbiAgfVxuXG4gIHByaXZhdGUgX2ZpbHRlcih2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgZmlsdGVyVmFsdWUgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpO1xuICAgIGNvbnNvbGUubG9nKGZpbHRlclZhbHVlKTtcblxuICAgIGNvbnN0IG5ld0RhdGEgPSB0aGlzLmRhdGEuc2VsZWN0T3B0aW9ucy5maWx0ZXIobm9kZSA9PiB0aGlzLl9pbmNsdWRlX25vZGUoZmlsdGVyVmFsdWUsIG5vZGUpKTtcblxuICAgIHRoaXMuZGF0YVNvdXJjZS5kYXRhID0gbmV3RGF0YTtcbiAgICB0aGlzLl9maXhfc2VsZWN0aW9uKCk7XG4gIH1cbiAgLyoqIHJldHVybiB0cnVlIGlmIGFueSBjaGlsZHJlbiBpcyBpbmNsdWRlLCBmYWxzZSBvdGhlcndpc2UgKi9cbiAgcHJpdmF0ZSBfaW5jbHVkZV9ub2RlKGZpbHRlcjogc3RyaW5nLCBub2RlOiBUZXJtTm9kZSk6IGJvb2xlYW4ge1xuICAgIGlmIChub2RlLnRlcm0uaWRlbnRpZmllci50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGZpbHRlcikpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZHJlbikge1xuICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiBub2RlLmNoaWxkcmVuKSB7XG4gICAgICAgIGlmICh0aGlzLl9pbmNsdWRlX25vZGUoZmlsdGVyLCBjaGlsZCkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgX2ZpeF9zZWxlY3Rpb24oKSB7XG4gICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMudHJlZUNvbnRyb2wuZGF0YU5vZGVzKSB7XG4gICAgICBjb25zb2xlLmxvZyhub2RlKTtcbiAgICB9XG5cbiAgICAvLyBpZiAodGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uc2VsZWN0ZWQpIHtcbiAgICAvLyAgIGNvbnN0IG9sZCA9IHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLnNlbGVjdGVkLmZpbmQoXG4gICAgLy8gICAgICh2YWx1ZTogRmxhdFRyZWVOb2RlLCBpbmRleDogbnVtYmVyLCBvYmo6IEZsYXRUcmVlTm9kZVtdKSA9PiB2YWx1ZS50ZXJtLmlkID09PSBub2RlLnRlcm0uaWRcbiAgICAvLyAgICk7XG4gICAgLy8gICBpZiAob2xkICE9PSB1bmRlZmluZWQpIHtcbiAgICAvLyAgICAgdGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uZGVzZWxlY3Qob2xkKTtcbiAgICAvLyAgICAgdGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uc2VsZWN0KHJlc3VsdCk7XG4gICAgLy8gICB9XG4gICAgLy8gfVxuICB9XG4gIHJlbW92ZV9jb21wb25lbnQoKSB7XG4gICAgdGhpcy5maWx0ZXJTZXJ2aWNlLmRlbGV0ZVBhcmFtZXRlcih0aGlzLmRhdGEuZmllbGQpO1xuICAgIHRoaXMuZmlsdGVyQ29udGFpbmVyU2VydmljZS5maWx0ZXJEZWxldGVkKHRoaXMuZGF0YS5pbmRleCk7XG5cbiAgfVxuICBvbkNoYW5nZSgpIHtcbiAgICB0aGlzLmZpbHRlclNlcnZpY2UuY2hhbmdlRmlsdGVyKHRoaXMuZGF0YS5maWVsZCwgdGhpcy5kYXRhLnZhbHVlKTtcbiAgfVxuXG4gIGVtaXRTZWxlY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2codGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uc2VsZWN0ZWQpO1xuICAgIHZhciB2YWx1ZUVtaXRlciA9ICdPUic7XG4gICAgdGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uc2VsZWN0ZWQuZm9yRWFjaChub2RlID0+IHtcbiAgICAgIHZhbHVlRW1pdGVyID0gdmFsdWVFbWl0ZXIgKyAnLCcgKyBub2RlLnRlcm0uaWQ7XG4gICAgfSk7XG4gICAgdGhpcy5maWx0ZXJTZXJ2aWNlLmNoYW5nZUF1dG9jb21wbGV0ZUZpbHRlcih0aGlzLmRhdGEuaWRWb2NhYi50b1N0cmluZygxMCksIHZhbHVlRW1pdGVyKTtcbiAgfVxuXG5cbiAgLyoqIFRyYW5zZm9ybSB0aGUgZGF0YSB0byBzb21ldGhpbmcgdGhlIHRyZWUgY2FuIHJlYWQuICovXG4gIHRyYW5zZm9ybWVyKG5vZGU6IFRlcm1Ob2RlLCBsZXZlbDogbnVtYmVyKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgbmFtZTogbm9kZS50ZXJtLmlkZW50aWZpZXIsXG4gICAgICBsZXZlbDogbGV2ZWwsXG4gICAgICBleHBhbmRhYmxlOiAobm9kZS5jaGlsZHJlbi5sZW5ndGggPiAwKSxcbiAgICAgIHRlcm06IG5vZGUudGVybSxcbiAgICB9O1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKiogR2V0IHRoZSBsZXZlbCBvZiB0aGUgbm9kZSAqL1xuICBnZXRMZXZlbChub2RlOiBGbGF0VHJlZU5vZGVGaWx0ZXIpIHtcbiAgICByZXR1cm4gbm9kZS5sZXZlbDtcbiAgfVxuXG4gIC8qKiBHZXQgd2hldGhlciB0aGUgbm9kZSBpcyBleHBhbmRlZCBvciBub3QuICovXG4gIGlzRXhwYW5kYWJsZShub2RlOiBGbGF0VHJlZU5vZGVGaWx0ZXIpIHtcbiAgICByZXR1cm4gbm9kZS5leHBhbmRhYmxlO1xuICB9XG5cbiAgLyoqIEdldCB3aGV0aGVyIHRoZSBub2RlIGhhcyBjaGlsZHJlbiBvciBub3QuICovXG4gIGhhc0NoaWxkKGluZGV4OiBudW1iZXIsIG5vZGU6IEZsYXRUcmVlTm9kZUZpbHRlcikge1xuICAgIHJldHVybiBub2RlLmV4cGFuZGFibGU7XG4gIH1cblxuICAvKiogR2V0IHRoZSBjaGlsZHJlbiBmb3IgdGhlIG5vZGUuICovXG4gIGdldENoaWxkcmVuKG5vZGU6IFRlcm1Ob2RlKSB7XG4gICAgcmV0dXJuIG9mKG5vZGUuY2hpbGRyZW4pO1xuICB9XG5cbiAgLyoqIFdoZXRoZXIgYWxsIHRoZSBkZXNjZW5kYW50cyBvZiB0aGUgbm9kZSBhcmUgc2VsZWN0ZWQuICovXG4gIGRlc2NlbmRhbnRzQWxsU2VsZWN0ZWQobm9kZTogRmxhdFRyZWVOb2RlRmlsdGVyKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZGVzY2VuZGFudHMgPSB0aGlzLnRyZWVDb250cm9sLmdldERlc2NlbmRhbnRzKG5vZGUpO1xuICAgIGNvbnN0IGRlc2NBbGxTZWxlY3RlZCA9IGRlc2NlbmRhbnRzLmV2ZXJ5KGNoaWxkID0+XG4gICAgICB0aGlzLmNoZWNrbGlzdFNlbGVjdGlvbi5pc1NlbGVjdGVkKGNoaWxkKVxuICAgICk7XG4gICAgcmV0dXJuIGRlc2NBbGxTZWxlY3RlZDtcbiAgfVxuXG4gIC8qKiBXaGV0aGVyIHBhcnQgb2YgdGhlIGRlc2NlbmRhbnRzIGFyZSBzZWxlY3RlZCAqL1xuICBkZXNjZW5kYW50c1BhcnRpYWxseVNlbGVjdGVkKG5vZGU6IEZsYXRUcmVlTm9kZUZpbHRlcik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGRlc2NlbmRhbnRzID0gdGhpcy50cmVlQ29udHJvbC5nZXREZXNjZW5kYW50cyhub2RlKTtcbiAgICBjb25zdCByZXN1bHQgPSBkZXNjZW5kYW50cy5zb21lKGNoaWxkID0+IHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLmlzU2VsZWN0ZWQoY2hpbGQpKTtcbiAgICByZXR1cm4gcmVzdWx0ICYmICF0aGlzLmRlc2NlbmRhbnRzQWxsU2VsZWN0ZWQobm9kZSk7XG4gIH1cblxuICAvKiogU2VsZWN0L2Rlc2VsZWN0IGFsbCB0aGUgZGVzY2VuZGFudHMgbm9kZSAqL1xuICBpdGVtU2VsZWN0aW9uVG9nZ2xlKG5vZGU6IEZsYXRUcmVlTm9kZUZpbHRlcik6IHZvaWQge1xuICAgIHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLnRvZ2dsZShub2RlKTtcbiAgICBjb25zdCBkZXNjZW5kYW50cyA9IHRoaXMudHJlZUNvbnRyb2wuZ2V0RGVzY2VuZGFudHMobm9kZSk7XG4gICAgdGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uaXNTZWxlY3RlZChub2RlKVxuICAgICAgPyB0aGlzLmNoZWNrbGlzdFNlbGVjdGlvbi5zZWxlY3QoLi4uZGVzY2VuZGFudHMpXG4gICAgICA6IHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLmRlc2VsZWN0KC4uLmRlc2NlbmRhbnRzKTtcblxuICAgIC8vIEZvcmNlIHVwZGF0ZSBmb3IgdGhlIHBhcmVudFxuICAgIGRlc2NlbmRhbnRzLmV2ZXJ5KGNoaWxkID0+XG4gICAgICB0aGlzLmNoZWNrbGlzdFNlbGVjdGlvbi5pc1NlbGVjdGVkKGNoaWxkKVxuICAgICk7XG4gICAgdGhpcy5jaGVja0FsbFBhcmVudHNTZWxlY3Rpb24obm9kZSk7XG4gICAgdGhpcy5lbWl0U2VsZWN0aW9uKCk7XG5cbiAgfVxuXG4gIC8qKiBDaGVjayBhbGwgdGhlIHBhcmVudHMgdG8gc2VlIGlmIHRoZXkgY2hhbmdlZCAqL1xuICBsZWFmSXRlbVNlbGVjdGlvblRvZ2dsZShub2RlOiBGbGF0VHJlZU5vZGVGaWx0ZXIpOiB2b2lkIHtcbiAgICB0aGlzLmNoZWNrbGlzdFNlbGVjdGlvbi50b2dnbGUobm9kZSk7XG4gICAgdGhpcy5jaGVja0FsbFBhcmVudHNTZWxlY3Rpb24obm9kZSk7XG4gICAgdGhpcy5lbWl0U2VsZWN0aW9uKCk7XG4gIH1cblxuICAvKiBDaGVja3MgYWxsIHRoZSBwYXJlbnRzIHdoZW4gYSBsZWFmIG5vZGUgaXMgc2VsZWN0ZWQvdW5zZWxlY3RlZCAqL1xuICBjaGVja0FsbFBhcmVudHNTZWxlY3Rpb24obm9kZTogRmxhdFRyZWVOb2RlRmlsdGVyKTogdm9pZCB7XG4gICAgbGV0IHBhcmVudDogRmxhdFRyZWVOb2RlRmlsdGVyIHwgbnVsbCA9IHRoaXMuZ2V0UGFyZW50Tm9kZShub2RlKTtcbiAgICB3aGlsZSAocGFyZW50KSB7XG4gICAgICB0aGlzLmNoZWNrUm9vdE5vZGVTZWxlY3Rpb24ocGFyZW50KTtcbiAgICAgIHBhcmVudCA9IHRoaXMuZ2V0UGFyZW50Tm9kZShwYXJlbnQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBDaGVjayByb290IG5vZGUgY2hlY2tlZCBzdGF0ZSBhbmQgY2hhbmdlIGl0IGFjY29yZGluZ2x5ICovXG4gIGNoZWNrUm9vdE5vZGVTZWxlY3Rpb24obm9kZTogRmxhdFRyZWVOb2RlRmlsdGVyKTogdm9pZCB7XG4gICAgY29uc3Qgbm9kZVNlbGVjdGVkID0gdGhpcy5jaGVja2xpc3RTZWxlY3Rpb24uaXNTZWxlY3RlZChub2RlKTtcbiAgICBjb25zdCBkZXNjZW5kYW50cyA9IHRoaXMudHJlZUNvbnRyb2wuZ2V0RGVzY2VuZGFudHMobm9kZSk7XG4gICAgY29uc3QgZGVzY0FsbFNlbGVjdGVkID0gZGVzY2VuZGFudHMuZXZlcnkoY2hpbGQgPT5cbiAgICAgIHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLmlzU2VsZWN0ZWQoY2hpbGQpXG4gICAgKTtcbiAgICBpZiAobm9kZVNlbGVjdGVkICYmICFkZXNjQWxsU2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLmRlc2VsZWN0KG5vZGUpO1xuICAgIH0gZWxzZSBpZiAoIW5vZGVTZWxlY3RlZCAmJiBkZXNjQWxsU2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMuY2hlY2tsaXN0U2VsZWN0aW9uLnNlbGVjdChub2RlKTtcbiAgICB9XG4gIH1cblxuICAvKiBHZXQgdGhlIHBhcmVudCBub2RlIG9mIGEgbm9kZSAqL1xuICBnZXRQYXJlbnROb2RlKG5vZGU6IEZsYXRUcmVlTm9kZUZpbHRlcik6IEZsYXRUcmVlTm9kZUZpbHRlciB8IG51bGwge1xuICAgIGNvbnN0IGN1cnJlbnRMZXZlbCA9IHRoaXMuZ2V0TGV2ZWwobm9kZSk7XG5cbiAgICBpZiAoY3VycmVudExldmVsIDwgMSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnRJbmRleCA9IHRoaXMudHJlZUNvbnRyb2wuZGF0YU5vZGVzLmluZGV4T2Yobm9kZSkgLSAxO1xuXG4gICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjb25zdCBjdXJyZW50Tm9kZSA9IHRoaXMudHJlZUNvbnRyb2wuZGF0YU5vZGVzW2ldO1xuXG4gICAgICBpZiAodGhpcy5nZXRMZXZlbChjdXJyZW50Tm9kZSkgPCBjdXJyZW50TGV2ZWwpIHtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnROb2RlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZW1vdmVDaGlwKGkpe1xuICAgIGNvbnNvbGUubG9nKGkpO1xuICB9XG59XG4iXX0=